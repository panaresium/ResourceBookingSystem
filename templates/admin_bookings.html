{% extends "base.html" %}
{% import '_pagination_controls.html' as pagination_macros with context %} {# IMPORT ADDED HERE #}

{% block title %}{{ _('Admin - Bookings - Smart Resource Booking') }}{% endblock %}

{% block content %}
<div class="container bookings-management-container">
    <h1>{{ _('Admin Bookings Management') }}</h1>

    <div id="admin-booking-status" class="status-message" role="alert">
        <!-- Messages from JavaScript will appear here -->
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <form method="GET" action="{{ url_for('admin_ui.serve_admin_bookings_page') }}" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <label for="status_filter" style="margin-right: 5px; font-weight: bold;">{{ _('Filter by Status:') }}</label>
        <select name="status_filter" id="status_filter" onchange="this.form.submit()" style="padding: 5px; border-radius: 3px; border: 1px solid #ced4da;">
            <option value="">{{ _('-- All Statuses --') }}</option>
            {% for stat in all_statuses %}
                <option value="{{ stat }}" {% if stat == current_status_filter %}selected{% endif %}>
                    {{ stat.replace('_', ' ').capitalize() }}
                </option>
            {% endfor %}
        </select>
        {# The results per page select is now part of the pagination macro, so no need for a separate submit button here for status filter alone if macro handles form submission #}
    </form>

    {# PAGINATION CONTROLS ADDED HERE #}
    {% if pagination_data and pagination_data.total_items > 0 %} {# Check total_items to show even for one page #}
        {{ pagination_macros.render_pagination_controls(
            pagination_data,
            'admin_ui.serve_admin_bookings_page',
            params={'status_filter': current_status_filter if current_status_filter else ''}
        ) }}
    {% elif pagination_data and pagination_data.total_items == 0 and not error %}
        {# Still show per_page if there are no items due to filter, allowing user to change it #}
         {{ pagination_macros.render_pagination_controls(
            pagination_data,
            'admin_ui.serve_admin_bookings_page',
            params={'status_filter': current_status_filter if current_status_filter else ''}
        ) }}
    {% endif %}

    {% if bookings %}
    {# SCROLLABLE CONTAINER ADDED HERE #}
    <div class="scrollable-table-container">
        <div class="table-responsive">
            <table id="admin-bookings-table" class="table bookings-table"> {# Added id #}
                <thead>
                    <tr>
                        <th>{{ _('ID') }}</th>
                        <th>{{ _('User') }}</th>
                        <th>{{ _('Resource') }}</th>
                        <th>{{ _('Title') }}</th>
                        <th>{{ _('Start Time') }}</th>
                        <th>{{ _('End Time') }}</th>
                        <th>{{ _('Status') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    {# Added dynamic class for row styling based on status, and improved condition for table-warning #}
                    <tr class="booking-row-{{ booking.status | lower | replace('_', '-') }} {{ 'table-warning' if booking.status == 'cancelled_by_admin' and booking.admin_deleted_message else '' }}">
                        <td>{{ booking.id }}</td>
                        <td>{{ booking.user_username }}</td>
                        <td>{{ booking.resource_name }}</td>
                        <td>
                            {{ booking.title if booking.title else '-' }}
                            {% if booking.status == 'cancelled_by_admin' and booking.admin_deleted_message %}
                              <div class="alert alert-warning p-1 my-1">
                                <small><strong>{{ _('Admin Cancellation:') }}</strong> {{ booking.admin_deleted_message }}</small>
                              </div>
                            {% endif %}
                        </td>
                        <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '-' }}</td>
                        <td>{{ booking.end_time.strftime('%Y-%m-%d %H:%M') if booking.end_time else '-' }}</td>
                        {# Updated status display to be more readable and use new CSS class convention #}
                        <td><span class="status-badge status-{{ booking.status | lower | replace('_', '-') }}">{{ booking.status.replace('_', ' ').capitalize() }}</span></td>
                        <td>
                            {% if booking.status == 'cancelled_by_admin' and booking.admin_deleted_message %}
                              <button class="btn btn-sm btn-outline-secondary dismiss-admin-message-btn" data-booking-id="{{ booking.id }}">
                                {{ _('Dismiss Message') }}
                              </button>
                            {% elif booking.status and booking.status.lower() not in ['cancelled', 'rejected', 'completed', 'checked_out', 'cancelled_by_admin'] %}
                            {# Delete button for active bookings might still be relevant for hard deletion #}
                            <button class="button button-danger delete-booking-btn" data-booking-id="{{ booking.id }}">{{ _('Cancel') }}</button>
                            {% else %}
                            {# For completed, cancelled, rejected bookings, show a dash or specific info #}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div> {# END SCROLLABLE CONTAINER #}
    {% else %}
        <p>{{ _('No bookings found.') }}</p>
        {# Consider if pagination controls (just the per_page selector) should show if error is not present #}
    {% endif %}

    {# Optional: Add pagination controls below the table as well #}
    {#
    {% if pagination_data and pagination_data.total_items > 0 %}
        <div class="mt-3"> {# Add some margin if placing below #}
            {{ pagination_macros.render_pagination_controls(
                pagination_data,
                'admin_ui.serve_admin_bookings_page',
                params={'status_filter': current_status_filter if current_status_filter else ''}
            ) }}
        </div>
    {% endif %}
    #}
</div>

<script>
// Existing JavaScript for this page...
// ...
</script>

{% endblock %}
