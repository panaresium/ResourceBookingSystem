{% extends "base.html" %}

{% block title %}{{ _('Admin - Bookings - Smart Resource Booking') }}{% endblock %}

{% block content %}
<div class="container bookings-management-container">
    <h1>{{ _('Admin Bookings Management') }}</h1>

    <div id="admin-booking-status" class="status-message" role="alert">
        <!-- Messages from JavaScript will appear here -->
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if bookings %}
    <div class="table-responsive">
        <table class="table bookings-table">
            <thead>
                <tr>
                    <th>{{ _('ID') }}</th>
                    <th>{{ _('User') }}</th>
                    <th>{{ _('Resource') }}</th>
                    <th>{{ _('Title') }}</th>
                    <th>{{ _('Start Time') }}</th>
                    <th>{{ _('End Time') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td>{{ booking.id }}</td>
                    <td>{{ booking.user_username }}</td>
                    <td>{{ booking.resource_name }}</td>
                    <td>{{ booking.title if booking.title else '-' }}</td>
                    <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '-' }}</td>
                    <td>{{ booking.end_time.strftime('%Y-%m-%d %H:%M') if booking.end_time else '-' }}</td>
                    <td><span class="status-badge status-{{ booking.status | lower }}">{{ _(booking.status) }}</span></td>
                    <td>
                        {% if booking.status and booking.status.lower() not in ['cancelled', 'rejected', 'completed', 'checked_out'] %}
                        <button class="button button-danger delete-booking-btn" data-booking-id="{{ booking.id }}">{{ _('Delete') }}</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>{{ _('No bookings found.') }}</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusDiv = document.getElementById('admin-booking-status');
    const deleteButtons = document.querySelectorAll('.delete-booking-btn'); // Changed selector
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    deleteButtons.forEach(button => { // Changed variable name
        button.addEventListener('click', function() {
            const bookingId = this.dataset.bookingId;
            const row = this.closest('tr'); // Get the table row

            if (!bookingId) {
                console.error('Booking ID not found on button');
                statusDiv.textContent = 'Error: Booking ID missing.';
                statusDiv.style.color = 'red';
                return;
            }

            if (!csrfToken) {
                console.error('CSRF token not found');
                statusDiv.textContent = 'Error: CSRF token not found. Please refresh the page.';
                statusDiv.style.color = 'red';
                return;
            }

            // Confirmation dialog
            if (!confirm("{{ _('Are you sure you want to delete this booking? This action cannot be undone.') }}")) {
                return; // Stop if user cancels
            }

            // Optimistically disable the button
            this.disabled = true;
            this.textContent = "{{ _('Deleting...') }}";

            fetch(`/api/admin/bookings/${bookingId}/cancel`, { // Endpoint remains the same as it now handles deletion
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // Try to parse error, but provide a fallback
                    return response.json().catch(() => ({ error: 'Failed to parse error response.' })).then(err => Promise.reject(err));
                }
            })
            .then(data => {
                statusDiv.textContent = data.message || "{{ _('Booking deleted successfully.') }}";
                statusDiv.style.color = 'green';

                // Remove the row from the table
                row.remove();
            })
            .catch(error => {
                const errorMessage = error.message || error.error || "{{ _('An unknown error occurred during deletion.') }}";
                statusDiv.textContent = `{{ _('Error') }}: ${errorMessage}`;
                statusDiv.style.color = 'red';

                // Re-enable the button if the operation failed, unless it was a 404 (booking not found)
                // or other specific statuses where re-enabling isn't logical.
                if (error.status !== 404 && error.status !== 400) { // 400 might be for already terminal state
                     this.disabled = false;
                     this.textContent = "{{ _('Delete') }}";
                } else {
                    // For 404 or 400 (e.g. already terminal), the button might stay disabled or removed
                    // If row wasn't removed due to error, button text indicates error
                    this.textContent = "{{ _('Error') }}";
                    // Optionally, if the row is still there and it's a 404, remove it.
                    if (error.status === 404) row.remove();
                }
            });
        });
    });
});
</script>

{% endblock %}
