{% extends "base.html" %}

{% block title %}{{ _('Admin - Bookings - Smart Resource Booking') }}{% endblock %}

{% block content %}
<div class="container bookings-management-container">
    <h1>{{ _('Admin Bookings Management') }}</h1>

    <div id="admin-booking-status" class="status-message" role="alert">
        <!-- Messages from JavaScript will appear here -->
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if bookings %}
    <div class="table-responsive">
        <table class="table bookings-table">
            <thead>
                <tr>
                    <th>{{ _('ID') }}</th>
                    <th>{{ _('User') }}</th>
                    <th>{{ _('Resource') }}</th>
                    <th>{{ _('Title') }}</th>
                    <th>{{ _('Start Time') }}</th>
                    <th>{{ _('End Time') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr class="{{ 'table-warning' if booking.status == 'cancelled_by_admin' else '' }}">
                    <td>{{ booking.id }}</td>
                    <td>{{ booking.user_username }}</td>
                    <td>{{ booking.resource_name }}</td>
                    <td>
                        {{ booking.title if booking.title else '-' }}
                        {% if booking.status == 'cancelled_by_admin' and booking.admin_deleted_message %}
                          <div class="alert alert-warning p-1 my-1">
                            <small><strong>{{ _('Admin Cancellation:') }}</strong> {{ booking.admin_deleted_message }}</small>
                          </div>
                        {% endif %}
                    </td>
                    <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '-' }}</td>
                    <td>{{ booking.end_time.strftime('%Y-%m-%d %H:%M') if booking.end_time else '-' }}</td>
                    <td><span class="status-badge status-{{ booking.status | lower }}">{{ _(booking.status) }}</span></td>
                    <td>
                        {% if booking.status == 'cancelled_by_admin' and booking.admin_deleted_message %}
                          <button class="btn btn-sm btn-outline-secondary dismiss-admin-message-btn" data-booking-id="{{ booking.id }}">
                            {{ _('Dismiss Message') }}
                          </button>
                        {% elif booking.status and booking.status.lower() not in ['cancelled', 'rejected', 'completed', 'checked_out', 'cancelled_by_admin'] %}
                        <button class="button button-danger delete-booking-btn" data-booking-id="{{ booking.id }}">{{ _('Delete') }}</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>{{ _('No bookings found.') }}</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusDiv = document.getElementById('admin-booking-status');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    document.querySelectorAll('.delete-booking-btn').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.dataset.bookingId;
            const row = this.closest('tr');

            if (!confirm("{{ _('Are you sure you want to cancel this booking? This will mark it as cancelled by an administrator.') }}")) {
                return;
            }
            this.disabled = true;
            this.textContent = "{{ _('Processing...') }}";

            fetch(`/api/admin/bookings/${bookingId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            })
            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
            .then(({ ok, status, data }) => {
                if (ok) {
                    statusDiv.textContent = data.message || "{{ _('Booking cancelled successfully.') }}";
                    statusDiv.className = 'alert alert-success';

                    row.classList.add('table-warning');
                    row.cells[6].innerHTML = `<span class="status-badge status-${data.new_status.toLowerCase()}">${data.new_status}</span>`;

                    let titleCell = row.cells[3];
                    let messageDiv = titleCell.querySelector('.alert.alert-warning');
                    if (!messageDiv) {
                        messageDiv = document.createElement('div');
                        messageDiv.className = 'alert alert-warning p-1 my-1';
                        titleCell.appendChild(messageDiv);
                    }
                    messageDiv.innerHTML = `<small><strong>{{ _('Admin Cancellation:') }}</strong> ${data.admin_message}</small>`;

                    this.classList.remove('delete-booking-btn', 'button-danger');
                    this.classList.add('dismiss-admin-message-btn', 'btn-outline-secondary');
                    this.textContent = "{{ _('Dismiss Message') }}";
                    this.disabled = false;
                } else {
                    throw new Error(data.error || `{{ _('Error cancelling booking (Status: ${status}).') }}`);
                }
            })
            .catch(error => {
                statusDiv.textContent = `{{ _('Error') }}: ${error.message}`;
                statusDiv.className = 'alert alert-danger';
                this.disabled = false;
                this.textContent = "{{ _('Delete') }}";
            });
        });
    });

    document.querySelectorAll('.dismiss-admin-message-btn').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.dataset.bookingId;
            const row = this.closest('tr');
            const messageDiv = row.querySelector('.alert.alert-warning');

            this.disabled = true;
            this.textContent = "{{ _('Processing...') }}";

            fetch(`/api/admin/bookings/${bookingId}/clear_admin_message`, { // Corrected API endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            })
            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
            .then(({ ok, status, data }) => {
                if (ok) {
                    statusDiv.textContent = data.message || "{{ _('Admin message cleared and booking acknowledged.') }}";
                    statusDiv.className = 'alert alert-success';

                    if (messageDiv) messageDiv.remove();
                    this.remove(); // Remove the dismiss button

                    // Update status display
                    const statusCell = row.cells[6]; // Assuming status is the 7th cell
                    if (statusCell && data.new_status) {
                        // For translation, ideally the backend would send translated status or use a mapping here
                        // For now, using the raw status string, which might not be ideal for display if it's an enum key.
                        // The _() function is not directly available in JS unless passed specifically.
                        // Simple approach: use the new_status string.
                        statusCell.innerHTML = `<span class="status-badge status-${data.new_status.toLowerCase()}">${data.new_status}</span>`;
                    }

                    // Update row styling
                    row.classList.remove('table-warning');
                    // Optionally add another class like 'table-light' or 'table-secondary' if desired
                    // row.classList.add('table-light');

                } else {
                    throw new Error(data.error || `{{ _('Failed to clear admin message (Status: ${status}).') }}`);
                }
            })
            .catch(error => {
                statusDiv.textContent = `{{ _('Error') }}: ${error.message}`;
                statusDiv.className = 'alert alert-danger';
                this.disabled = false;
                this.textContent = "{{ _('Dismiss Message') }}"; // Revert button text
            });
        });
    });
});
</script>

{% endblock %}
