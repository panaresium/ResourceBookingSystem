{% extends "base.html" %}

{% block title %}{{ _('Admin - Bookings - Smart Resource Booking') }}{% endblock %}

{% block content %}
<div class="container bookings-management-container">
    <h1>{{ _('Admin Bookings Management') }}</h1>

    <div id="admin-booking-status" class="status-message" role="alert">
        <!-- Messages from JavaScript will appear here -->
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if bookings %}
    <div class="table-responsive">
        <table class="table bookings-table">
            <thead>
                <tr>
                    <th>{{ _('ID') }}</th>
                    <th>{{ _('User') }}</th>
                    <th>{{ _('Resource') }}</th>
                    <th>{{ _('Title') }}</th>
                    <th>{{ _('Start Time') }}</th>
                    <th>{{ _('End Time') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td>{{ booking.id }}</td>
                    <td>{{ booking.user_username }}</td>
                    <td>{{ booking.resource_name }}</td>
                    <td>{{ booking.title if booking.title else '-' }}</td>
                    <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '-' }}</td>
                    <td>{{ booking.end_time.strftime('%Y-%m-%d %H:%M') if booking.end_time else '-' }}</td>
                    <td><span class="status-badge status-{{ booking.status | lower }}">{{ _(booking.status) }}</span></td>
                    <td>
                        {% if booking.status and booking.status.lower() not in ['cancelled', 'rejected', 'completed', 'checked_out'] %}
                        <button class="button button-danger cancel-booking-btn" data-booking-id="{{ booking.id }}">{{ _('Cancel') }}</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>{{ _('No bookings found.') }}</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusDiv = document.getElementById('admin-booking-status');
    const cancelButtons = document.querySelectorAll('.cancel-booking-btn');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    cancelButtons.forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.dataset.bookingId;
            const row = this.closest('tr'); // Get the table row

            if (!bookingId) {
                console.error('Booking ID not found on button');
                return;
            }

            if (!csrfToken) {
                console.error('CSRF token not found');
                statusDiv.textContent = 'Error: CSRF token not found. Please refresh the page.';
                statusDiv.style.color = 'red';
                return;
            }

            // Optimistically disable the button
            this.disabled = true;
            this.textContent = 'Processing...';

            fetch(`/api/admin/bookings/${bookingId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                // body: JSON.stringify({}) // No body needed for this request as per typical cancel actions
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => Promise.reject(err));
                }
            })
            .then(data => {
                statusDiv.textContent = data.message || 'Booking cancelled successfully.';
                statusDiv.style.color = 'green';

                // Update booking status in the table
                const statusCell = row.querySelector('td:nth-child(7) span'); // 7th cell for status
                if (statusCell) {
                    statusCell.textContent = 'Cancelled';
                    statusCell.className = 'status-badge status-cancelled';
                }

                // Update button state
                this.textContent = 'Cancelled';
                this.disabled = true; // Keep it disabled
            })
            .catch(error => {
                const errorMessage = error.message || error.error || 'An unknown error occurred.';
                statusDiv.textContent = `Error: ${errorMessage}`;
                statusDiv.style.color = 'red';

                // Re-enable the button if the operation failed, unless it was a 404 or similar
                if (error.status !== 404) {
                     this.disabled = false;
                     this.textContent = 'Cancel';
                } else {
                    this.textContent = 'Error'; // Or some other indication that it failed terminally
                }
            });
        });
    });
});
</script>

{% endblock %}
