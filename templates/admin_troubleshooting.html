{% extends "base.html" %}

{% block title %}{{ _('System Troubleshooting Tools') }}{% endblock %}

{% block content %} {# Adjusted from page_content to content #}
<div class="container-fluid"> {# Or container mt-4 if that's preferred for admin pages #}
    <div class="row">
        <div class="col-lg-12">
            {# Assuming page-header is a valid class, or use a simple h1 #}
            <h1 class="page-header">{{ _('System Troubleshooting Tools') }}</h1>
            <hr>
            <section id="troubleshooting-tools-section" class="mb-5">
                <h2>{{ _('System Troubleshooting Tools') }}</h2>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Browse Database Tables') }}</h5>
                        <p class="card-text">{{ _('Select a table to view its columns, filter records, and browse data with pagination.') }}</p>

                        <div class="mb-3">
                            <label for="db-table-select" class="form-label">{{ _('Select Table:') }}</label>
                            <select id="db-table-select" class="form-select">
                                <option value="">{{ _('-- Loading tables... --') }}</option>
                            </select>
                        </div>

                        <div id="db-filter-area" class="mb-3" style="display: none;">
                            <h5>{{ _('Filters') }}</h5>
                            <div id="db-filter-controls-container" class="row">
                                <div id="db-filter-col-1" class="col-md-6"></div>
                                <div id="db-filter-col-2" class="col-md-6"></div>
                            </div>
                            <button id="db-apply-filters-btn" class="btn btn-primary mt-2">{{ _('Apply Filters') }}</button>
                            <button id="db-clear-filters-btn" class="btn btn-secondary mt-2">{{ _('Clear Filters') }}</button>
                        </div>

                        <div id="db-results-area" class="mt-3">
                            <h5>{{ _('Records') }}</h5>
                            <div id="db-records-output" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <p>{{ _('Select a table and apply filters to view records.') }}</p>
                                <!-- Table will be dynamically generated here -->
                            </div>
                        </div>

                        <div id="db-pagination-controls" class="mt-3" style="display: none;">
                            <!-- Pagination buttons will be dynamically added here -->
                        </div>

                        <div id="db-view-status" class="mt-2"></div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Reload Configurations') }}</h5>
                        <p class="card-text">{{ _('Attempt to reload system configurations like the backup schedule and map data. Note: Full effect may require deeper application integration for some configurations.') }}</p>
                        <button id="reload-configurations-btn" class="btn btn-warning">{{ _('Reload Configurations') }}</button>
                        <div id="reload-configurations-status" class="mt-2"></div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Cleanup System Data') }}</h5>
                        <p class="card-text text-danger"><strong>{{ _('Warning:') }}</strong> {{ _('This will delete all bookings, resources, and floor maps from the database, and remove all uploaded floor map and resource images. This action is irreversible.') }}</p>
                        <button id="cleanup-system-data-btn" class="btn btn-danger">{{ _('Cleanup System Data') }}</button>
                        <div id="cleanup-system-data-status" class="mt-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
    // CSRF token will be handled by the global apiCall function.

    // --- New Database Browser UI Elements & Logic ---
    const dbTableSelect = document.getElementById('db-table-select');
    const dbFilterArea = document.getElementById('db-filter-area');
    const dbFilterControlsContainer = document.getElementById('db-filter-controls-container');
    const dbApplyFiltersBtn = document.getElementById('db-apply-filters-btn');
    const dbClearFiltersBtn = document.getElementById('db-clear-filters-btn');
    const dbResultsArea = document.getElementById('db-results-area');
    const dbRecordsOutput = document.getElementById('db-records-output');
    const dbPaginationControls = document.getElementById('db-pagination-controls');
    const dbViewStatusEl = document.getElementById('db-view-status'); // Renamed from viewDbRecordsStatusEl

    let dbViewState = {
        selectedTable: null,
        currentPage: 1,
        currentFilters: [],
        columns: [],
        perPage: 10, // Changed from 30
        sortBy: null,
        sortOrder: 'asc'
    };

    function updateDbViewStatus(message, isError = false) {
        if (!dbViewStatusEl) return;
        dbViewStatusEl.textContent = message;
        dbViewStatusEl.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
        if (!message) {
            dbViewStatusEl.style.display = 'none';
        } else {
            dbViewStatusEl.style.display = 'block';
        }
    }

    async function loadTableNames() {
        updateDbViewStatus("{{ _('Loading table names...') }}");
        try {
            const response = await fetch('/api/admin/db/table_names');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('API response for table names:', JSON.stringify(data, null, 2)); // Added console log

            if (data.success && data.tables) {
                dbTableSelect.innerHTML = '<option value="">{{ _("-- Select a Table --") }}</option>'; // Clear existing options

                // Sort tables by name
                data.tables.sort((a, b) => a.name.localeCompare(b.name));

                data.tables.forEach(tableInfo => {
                    const option = document.createElement('option');
                    option.value = tableInfo.name;
                    const recordText = tableInfo.count === 1 ? 'record' : 'records'; // Using plain English
                    option.textContent = `${tableInfo.name} (${tableInfo.count} ${recordText})`;
                    dbTableSelect.appendChild(option);
                });
                updateDbViewStatus("{{ _('Table names loaded.') }}", false);
                console.log('Generated dbTableSelect HTML:', dbTableSelect.innerHTML); // Added console log
            } else {
                throw new Error(data.message || "{{ _('Failed to load table names.') }}");
            }
        } catch (error) {
            console.error('Error loading table names:', error);
            updateDbViewStatus(`{{ _('Error loading table names:') }} ${error.message}`, true);
            dbTableSelect.innerHTML = '<option value="">{{ _("-- Error loading tables --") }}</option>';
        }
    }

    async function loadTableInfoAndGenerateFilters(tableName) {
        if (!tableName) {
            dbFilterArea.style.display = 'none';
            dbFilterControlsContainer.innerHTML = `<p>{{ _('Select a table to see available filters.') }}</p>`;
            dbViewState.columns = [];
            return;
        }
        updateDbViewStatus(`{{ _('Loading schema for table:') }} ${tableName}...`);
        dbFilterArea.style.display = 'block'; // Ensure parent is visible before querying children

        const dbFilterCol1 = document.getElementById('db-filter-col-1');
        const dbFilterCol2 = document.getElementById('db-filter-col-2');

        if (!dbFilterCol1 || !dbFilterCol2) {
            console.error('CRITICAL: Filter column elements (db-filter-col-1 or db-filter-col-2) are null/not found in DOM immediately after getElementById within loadTableInfoAndGenerateFilters.');
            if (typeof updateDbViewStatus === 'function') {
                updateDbViewStatus('Internal UI error: Filter layout components are missing. Please try refreshing.', true);
            }
            return;
        }

        dbFilterCol1.innerHTML = `<p>{{ _('Loading filters for ') }}${tableName}...</p>`;
        dbFilterCol2.innerHTML = ''; // Clear second column initially

        try {
            const response = await fetch(`/api/admin/db/table_info/${tableName}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.success && data.columns) {
                dbViewState.columns = data.columns;
                dbFilterCol1.innerHTML = ''; // Clear loading message
                dbFilterCol2.innerHTML = '';

                if (data.columns.length === 0) {
                    dbFilterCol1.innerHTML = `<p>{{ _('No filterable columns found for this table.') }}</p>`;
                }

                data.columns.forEach((column, index) => {
                    const filterGroup = document.createElement('div');
                    // Each filter group can be a simple div, styling will be handled by parent col-md-6 and its own items
                    filterGroup.className = 'mb-3 filter-group-item';
                    // Using template literals for cleaner HTML structure within JS
                    filterGroup.innerHTML = `
                        <div><label class="form-label mb-1">${column.name} <small class="text-muted">(${column.type})</small></label></div>
                        <div class="input-group input-group-sm mb-1">
                            <select class="form-select filter-op" data-column="${column.name}">
                                <option value="">{{ _('-- Operator --') }}</option>
                                <option value="eq">{{ _('Equals') }} (=)</option>
                                <option value="neq">{{ _('Not Equals') }} (!=)</option>
                                <option value="ilike">{{ _('Contains (case-insensitive)') }}</option>
                                <option value="gt">{{ _('Greater Than') }} (&gt;)</option>
                                <option value="gte">{{ _('Greater Than or Equal To') }} (&gt;=)</option>
                                <option value="lt">{{ _('Less Than') }} (&lt;)</option>
                                <option value="lte">{{ _('Less Than or Equal To') }} (&lt;=)</option>
                                <option value="in">{{ _('In (comma-separated)') }}</option>
                                <option value="notin">{{ _('Not In (comma-separated)') }}</option>
                                <option value="is_null">{{ _('Is Null') }}</option>
                                <option value="is_not_null">{{ _('Is Not Null') }}</option>
                            </select>
                            <input type="text" class="form-control filter-val" data-column="${column.name}" placeholder="{{ _('Value') }}">
                        </div>
                    `;

                    const opSelect = filterGroup.querySelector('.filter-op');
                    const valInput = filterGroup.querySelector('.filter-val');
                    opSelect.addEventListener('change', function() {
                        if (this.value === 'is_null' || this.value === 'is_not_null') {
                            valInput.style.display = 'none';
                            valInput.value = '';
                        } else {
                            valInput.style.display = 'block';
                        }
                    });

                    if (index % 2 === 0) {
                        dbFilterCol1.appendChild(filterGroup);
                    } else {
                        dbFilterCol2.appendChild(filterGroup);
                    }
                });
                // dbFilterArea.style.display = 'block'; // Already set earlier if tableName is valid
                updateDbViewStatus(`{{ _('Schema loaded for table:') }} ${tableName}. {{ _('Ready for filtering and data fetching.') }}`, false);
            } else {
                throw new Error(data.message || `{{ _('Failed to load schema for table:') }} ${tableName}`);
            }
        } catch (error) {
            console.error(`Error loading table info for ${tableName}:`, error);
            updateDbViewStatus(`{{ _('Error loading schema for') }} ${tableName}: ${error.message}`, true);
            dbFilterArea.style.display = 'none';
            dbFilterControlsContainer.innerHTML = `<p class="text-danger">{{ _('Error loading filters.') }}</p>`;
        }
    }

    function renderTable(columns, records) {
        dbRecordsOutput.innerHTML = ''; // Clear previous
        if (!columns || columns.length === 0) {
             dbRecordsOutput.innerHTML = `<p>{{ _('No column information available to display table.') }}</p>`;
             return;
        }
        if (!records || records.length === 0) {
            dbRecordsOutput.innerHTML = `<p>{{ _('No records found for the current selection and filters.') }}</p>`;
            return;
        }

        const table = document.createElement('table');
        table.className = 'table table-striped table-bordered table-sm caption-top';

        const caption = table.createCaption();
        caption.textContent = `${dbViewState.selectedTable} - {{ _('Page') }} ${dbViewState.currentPage}`;


        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        columns.forEach(colDef => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.textContent = colDef.name;
            // Basic sort indicator and functionality (can be enhanced)
            let sortIndicator = '';
            if (dbViewState.sortBy === colDef.name) {
                sortIndicator = dbViewState.sortOrder === 'asc' ? ' &uarr;' : ' &darr;';
            }
            th.innerHTML = colDef.name + sortIndicator;
            th.style.cursor = 'pointer';
            th.addEventListener('click', () => {
                if (dbViewState.sortBy === colDef.name) {
                    dbViewState.sortOrder = dbViewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    dbViewState.sortBy = colDef.name;
                    dbViewState.sortOrder = 'asc';
                }
                fetchAndDisplayTableData();
            });
            headerRow.appendChild(th);
        });

        const tbody = table.createTBody();
        records.forEach(record => {
            const row = tbody.insertRow();
            columns.forEach(colDef => {
                const cell = row.insertCell();
                let value = record[colDef.name];
                if (value === null || typeof value === 'undefined') {
                    cell.textContent = 'NULL';
                    cell.classList.add('text-muted', 'fst-italic');
                } else if (typeof value === 'object') { // Handle potential JSON objects/arrays if not stringified by backend
                    cell.textContent = JSON.stringify(value, null, 2);
                } else {
                    cell.textContent = value;
                }
            });
        });
        dbRecordsOutput.appendChild(table);
    }

    function renderPagination(paginationData) {
        const controlsContainer = document.getElementById('db-pagination-controls'); // Ensure this is the correct ID
        if (!controlsContainer) {
            console.error('DB Pagination controls container not found!');
            return;
        }
        controlsContainer.innerHTML = ''; // Clear previous controls

        if (!paginationData || paginationData.total_pages <= 0) {
            controlsContainer.style.display = 'none';
            return;
        }
        controlsContainer.style.display = 'block';

        const navElement = document.createElement('nav');
        navElement.className = 'mt-4';
        navElement.setAttribute('aria-label', 'Database records pagination');

        const ulElement = document.createElement('ul');
        ulElement.className = 'pagination justify-content-center';

        // A. Items Per Page Selector
        const itemsPerPageLi = document.createElement('li');
        itemsPerPageLi.className = 'page-item disabled';
        const form = document.createElement('form');
        form.className = 'd-flex align-items-center';
        const label = document.createElement('label');
        label.className = 'visually-hidden me-2';
        label.setAttribute('for', 'per_page_select_db_pagination');
        label.textContent = "{{ _('Items per page:') }}";
        form.appendChild(label);
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm me-2';
        select.name = 'per_page';
        select.id = 'per_page_select_db_pagination';
        select.style.width = 'auto';
        const perPageOptions = [10, 25, 50, 100];
        perPageOptions.forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = num;
            if (num === dbViewState.perPage) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        select.addEventListener('change', function() {
            dbViewState.perPage = parseInt(this.value, 10);
            dbViewState.currentPage = 1;
            fetchAndDisplayTableData();
        });
        form.appendChild(select);
        itemsPerPageLi.appendChild(form);
        ulElement.appendChild(itemsPerPageLi);

        // If only one page, but we want to show "items per page"
        if (paginationData.total_pages <= 1) {
             // Optional: Add total records display here if desired even for single page
            const p = document.createElement('p');
            p.className = 'text-center text-muted small mt-2'; // Added mt-2 for spacing
            p.textContent = `${("{{ _('Total records:') }}")} ${paginationData.total_records}`;
            navElement.appendChild(ulElement);
            navElement.appendChild(p); // Append paragraph after ul
            controlsContainer.appendChild(navElement);
            return;
        }


        // B. Blank Separator
        const liSep1 = document.createElement('li');
        liSep1.className = 'page-item disabled';
        const spanSep1 = document.createElement('span');
        spanSep1.className = 'page-link';
        spanSep1.style.paddingLeft = '1em';
        liSep1.appendChild(spanSep1);
        ulElement.appendChild(liSep1);

        // C. Previous Icon Link
        const liPrev = document.createElement('li');
        liPrev.className = 'page-item';
        if (paginationData.page === 1) liPrev.classList.add('disabled');
        const aPrev = document.createElement('a');
        aPrev.className = 'page-link';
        aPrev.href = '#';
        aPrev.innerHTML = '&laquo;';
        if (paginationData.page > 1) {
            aPrev.addEventListener('click', (e) => { e.preventDefault(); handlePaginationClick(paginationData.page - 1); });
        }
        liPrev.appendChild(aPrev);
        ulElement.appendChild(liPrev);

        // D. Opening Bracket
        const liOpenBracket = document.createElement('li');
        liOpenBracket.className = 'page-item disabled';
        const spanOpenBracket = document.createElement('span');
        spanOpenBracket.className = 'page-link';
        spanOpenBracket.textContent = '[';
        liOpenBracket.appendChild(spanOpenBracket);
        ulElement.appendChild(liOpenBracket);

        // E. Page Numbers and Commas Loop
        function createCommaLi() {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            const span = document.createElement('span');
            span.className = 'page-link';
            span.textContent = ',';
            li.appendChild(span);
            return li;
        }

        let isFirstElementInSequence = true;
        const totalPages = paginationData.total_pages;
        const currentPage = paginationData.page;
        // Simplified iter_pages: show 1st, current-1, current, current+1, last. With ellipses.
        const pagesToShow = new Set();
        pagesToShow.add(1);
        pagesToShow.add(totalPages);
        if (currentPage > 1) pagesToShow.add(currentPage - 1);
        pagesToShow.add(currentPage);
        if (currentPage < totalPages) pagesToShow.add(currentPage + 1);

        const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
        let lastPageShown = 0;

        sortedPages.forEach(p => {
            if (p < 1 || p > totalPages) return; // Only valid pages

            if (p > lastPageShown + 1 && p !== 1 && lastPageShown !== 0) { // Ellipsis needed
                 if (!isFirstElementInSequence) ulElement.appendChild(createCommaLi());
                 const liEllipsis = document.createElement('li');
                 liEllipsis.className = 'page-item disabled';
                 const spanEllipsis = document.createElement('span');
                 spanEllipsis.className = 'page-link';
                 spanEllipsis.textContent = '...';
                 liEllipsis.appendChild(spanEllipsis);
                 ulElement.appendChild(liEllipsis);
                 isFirstElementInSequence = false;
            }

            if (p > lastPageShown) { // Ensure we don't duplicate if current+/-1 is edge
                if (!isFirstElementInSequence) ulElement.appendChild(createCommaLi());
                const liPage = document.createElement('li');
                liPage.className = 'page-item';
                if (p === currentPage) liPage.classList.add('active');
                const aPage = document.createElement('a');
                aPage.className = 'page-link';
                aPage.href = '#';
                aPage.textContent = p;
                aPage.addEventListener('click', (e) => { e.preventDefault(); handlePaginationClick(p); });
                liPage.appendChild(aPage);
                ulElement.appendChild(liPage);
                isFirstElementInSequence = false;
                lastPageShown = p;
            }
        });


        // F. Closing Bracket
        const liCloseBracket = document.createElement('li');
        liCloseBracket.className = 'page-item disabled';
        const spanCloseBracket = document.createElement('span');
        spanCloseBracket.className = 'page-link';
        spanCloseBracket.textContent = ']';
        liCloseBracket.appendChild(spanCloseBracket);
        ulElement.appendChild(liCloseBracket);

        // G. Next Icon Link
        const liNext = document.createElement('li');
        liNext.className = 'page-item';
        if (paginationData.page === totalPages) liNext.classList.add('disabled');
        const aNext = document.createElement('a');
        aNext.className = 'page-link';
        aNext.href = '#';
        aNext.innerHTML = '&raquo;';
        if (paginationData.page < totalPages) {
            aNext.addEventListener('click', (e) => { e.preventDefault(); handlePaginationClick(paginationData.page + 1); });
        }
        liNext.appendChild(aNext);
        ulElement.appendChild(liNext);

        // H. Final Blank Separator
        const liSep2 = document.createElement('li');
        liSep2.className = 'page-item disabled';
        const spanSep2 = document.createElement('span');
        spanSep2.className = 'page-link';
        spanSep2.style.paddingLeft = '1em';
        liSep2.appendChild(spanSep2);
        ulElement.appendChild(liSep2);

        navElement.appendChild(ulElement);

        // Total records display
        const pTotal = document.createElement('p');
        pTotal.className = 'text-center text-muted small mt-2';
        pTotal.textContent = `${("{{ _('Page') }}")} ${currentPage} ${("{{ _('of') }}")} ${totalPages}. ${("{{ _('Total records:') }}")} ${paginationData.total_records}`;
        navElement.appendChild(pTotal);

        controlsContainer.appendChild(navElement);
    }

    async function handlePaginationClick(newPage) {
        if (newPage < 1) return; // Should be handled by disabled state, but good check
        dbViewState.currentPage = newPage;
        await fetchAndDisplayTableData();
    }

    async function fetchAndDisplayTableData() {
        const { selectedTable, currentPage, currentFilters, perPage, sortBy, sortOrder } = dbViewState;

        if (!selectedTable) {
            dbRecordsOutput.innerHTML = `<p>{{ _('Please select a table first.') }}</p>`;
            dbPaginationControls.style.display = 'none';
            return;
        }

        const currentTableName = String(selectedTable); // Explicitly cast to string
        console.log('Fetching data for table:', currentTableName, 'Type:', typeof currentTableName);

        updateDbViewStatus(`{{ _('Fetching data for table:') }} ${currentTableName}, {{ _('page:') }} ${currentPage}...`);

        let queryParams = `page=${currentPage}&per_page=${perPage}`;
        if (currentFilters.length > 0) {
            queryParams += `&filters=${encodeURIComponent(JSON.stringify(currentFilters))}`;
        }
        if (sortBy) {
            queryParams += `&sort_by=${encodeURIComponent(sortBy)}&sort_order=${encodeURIComponent(sortOrder)}`;
        }

        try {
            const response = await fetch(`/api/admin/db/table_data/${currentTableName}?${queryParams}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP error! status: ${response.status}` }));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.success && data.records) {
                if (data.columns && dbViewState.columns.length === 0) { // Store column info if not already fetched by loadTableInfo
                    dbViewState.columns = data.columns;
                }
                renderTable(dbViewState.columns, data.records);
                renderPagination(data.pagination);
                updateDbViewStatus(`{{ _('Data loaded for table:') }} ${currentTableName}.`, false);
            } else {
                throw new Error(data.message || `{{ _('Failed to fetch data for table:') }} ${currentTableName}`);
            }
        } catch (error) {
            console.error(`Error fetching table data for ${currentTableName}:`, error);
            updateDbViewStatus(`{{ _('Error fetching data for') }} ${currentTableName}: ${error.message}`, true);
            dbRecordsOutput.innerHTML = `<p class="text-danger">{{ _('Error loading records.') }}</p>`;
            dbPaginationControls.style.display = 'none';
        }
    }

    if (dbTableSelect) {
        dbTableSelect.addEventListener('change', async function(event) { // Added 'event' parameter
            dbViewState.selectedTable = event.target.value; // Changed to event.target.value
            console.log('dbTableSelect changed. Selected table name:', dbViewState.selectedTable, 'Type:', typeof dbViewState.selectedTable);
            dbViewState.currentPage = 1;
            dbViewState.currentFilters = [];
            dbViewState.columns = []; // Reset columns, will be fetched by loadTableInfo or fetchAndDisplayTableData
            dbViewState.sortBy = null;
            dbViewState.sortOrder = 'asc';

            dbRecordsOutput.innerHTML = `<p>{{ _('Select a table and apply filters to view records.') }}</p>`;
            dbPaginationControls.style.display = 'none';

            if (dbViewState.selectedTable) {
                await loadTableInfoAndGenerateFilters(dbViewState.selectedTable);
                await fetchAndDisplayTableData();
            } else {
                dbFilterArea.style.display = 'none';
                const col1 = document.getElementById('db-filter-col-1');
                const col2 = document.getElementById('db-filter-col-2');
                if(col1) col1.innerHTML = `<p>{{ _('Select a table to see available filters.') }}</p>`;
                if(col2) col2.innerHTML = '';
            }
        });
    }

    if (dbApplyFiltersBtn) {
        dbApplyFiltersBtn.addEventListener('click', async function() {
            dbViewState.currentFilters = [];
            // Iterate over controls in both columns
            const filterItems = dbFilterControlsContainer.querySelectorAll('.filter-group-item');
            filterItems.forEach(item => {
                const opSelect = item.querySelector('.filter-op');
                const valInput = item.querySelector('.filter-val');
                const column = opSelect.dataset.column;
                const op = opSelect.value;
                let value = valInput.value;

                if (op) {
                    if (op === 'is_null' || op === 'is_not_null') {
                        dbViewState.currentFilters.push({ column, op, value: null });
                    } else if (value.trim() !== '') {
                         dbViewState.currentFilters.push({ column, op, value: value.trim() });
                    }
                }
            });
            dbViewState.currentPage = 1;
            await fetchAndDisplayTableData();
        });
    }

    if (dbClearFiltersBtn) {
        dbClearFiltersBtn.addEventListener('click', async function() {
            const filterItems = dbFilterControlsContainer.querySelectorAll('.filter-group-item');
            filterItems.forEach(item => {
                item.querySelector('.filter-op').value = '';
                const valInput = item.querySelector('.filter-val');
                valInput.value = '';
                valInput.style.display = 'block';
            });
            dbViewState.currentFilters = [];
            dbViewState.currentPage = 1;
            await fetchAndDisplayTableData();
        });
    }

    // Load initial table names
    loadTableNames();


    // --- End of New Database Browser UI Logic ---


    // Old Troubleshooting Tools Event Listeners (to be kept if they are for other cards)
    const reloadConfigurationsBtn = document.getElementById('reload-configurations-btn');
    const reloadConfigurationsStatusEl = document.getElementById('reload-configurations-status');

    const cleanupSystemDataBtn = document.getElementById('cleanup-system-data-btn');
    const cleanupSystemDataStatusEl = document.getElementById('cleanup-system-data-status');

    if (reloadConfigurationsBtn) {
        reloadConfigurationsBtn.addEventListener('click', function() {
            reloadConfigurationsStatusEl.textContent = "{{ _('Attempting to reload configurations...') }}";
            reloadConfigurationsStatusEl.className = 'alert alert-info';
            reloadConfigurationsBtn.disabled = true;

            // Using global apiCall which handles CSRF
            apiCall('/api/admin/reload_configurations', {
                method: 'POST'
                // headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' } // csrfToken handled by apiCall
            }, reloadConfigurationsStatusEl)
            .then(data => { // apiCall resolves with data on success (2xx status)
                // Message is already set by apiCall on success if data.message exists
                if (!data.message && data.success) { // if apiCall's default success message isn't enough
                     showSuccess(reloadConfigurationsStatusEl, "{{ _('Configuration reload attempt finished successfully.') }}");
                }
            })
            .catch(error => { // apiCall rejects on network error or non-2xx status, message already set
                console.error('Reload Configurations error:', error);
                // showError is already called by apiCall
            })
            .finally(() => {
                reloadConfigurationsBtn.disabled = false;
            });
        });
    }

    if (cleanupSystemDataBtn) {
        cleanupSystemDataBtn.addEventListener('click', function() {
            const confirmationPrompt = "{{ _('Type CONFIRM to delete bookings, resources, floor maps, and all uploaded floor map/resource images. This action is irreversible.') }}";
            const userInput = prompt(confirmationPrompt);

            if (userInput === "CONFIRM") {
                cleanupSystemDataStatusEl.textContent = "{{ _('Processing cleanup...') }}";
                cleanupSystemDataStatusEl.className = 'alert alert-info';
                cleanupSystemDataBtn.disabled = true;

                // Using global apiCall which handles CSRF
                apiCall('/api/admin/cleanup_system_data', {
                    method: 'POST'
                    // headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' } // csrfToken handled by apiCall
                }, cleanupSystemDataStatusEl)
                .then(data => {
                     if (!data.message && data.success) {
                        showSuccess(cleanupSystemDataStatusEl, "{{ _('System data cleanup successful.') }}");
                     }
                    // Optionally, refresh parts of the page or prompt user to refresh
                    // Example: if you have a function to reload backups on the Backup/Restore page,
                    // and this cleanup affects it, you might call it here.
                    // For now, no specific refresh action after cleanup on this page.
                })
                .catch(error => {
                    console.error('Cleanup System Data error:', error);
                })
                .finally(() => {
                    cleanupSystemDataBtn.disabled = false;
                });
            } else if (userInput !== null) {
                cleanupSystemDataStatusEl.textContent = "{{ _('Cleanup cancelled. Confirmation not received.') }}";
                cleanupSystemDataStatusEl.className = 'alert alert-warning';
            } else {
                 cleanupSystemDataStatusEl.textContent = "{{ _('Cleanup cancelled.') }}";
                 cleanupSystemDataStatusEl.className = 'alert alert-info';
            }
        });
    }
});
</script>
{% endblock %}
