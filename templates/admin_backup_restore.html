{% extends "base.html" %}

{% block title %}{{ _('Admin - Backup & Restore') }}{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js" integrity="sha512-skuhu6jj+sQnhLq1Txsack8VfnIrX8wL+MTFilYlFFT/NuLJm7eya7zOROs39Jy5cjASMEWqxLzijRVmKhsqWQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
    .log-area {
        max-height: 200px;
        overflow-y: auto;
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
    }
    .log-entry {
        padding: 2px 0;
    }
    .log-error {
        color: red;
        font-weight: bold;
    }
    .log-success {
        color: green;
        font-weight: bold;
    }
    .log-info {
        color: #333;
    }
    /* Styles for DB Records View */
    .db-table-container {
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
    }
    .db-records-content pre {
        background-color: #f8f9fa; /* Light background for pre */
        padding: 10px;
        border-radius: 4px;
        max-height: 300px; /* Max height for individual record lists */
        overflow-y: auto;
    }
    /* Style for active (expanded) button */
    #view-db-records-output .btn.active { 
        background-color: #007bff;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ _('Admin - Backup & Restore') }}</h1>
    <hr>

    <section id="backup-section" class="mb-5">
        <h2>{{ _('One Click Backup') }}</h2>
        <p>{{ _('Perform a full backup of the database, map configurations, and uploaded media files.') }}</p>
        <button id="one-click-backup-btn" class="btn btn-primary">{{ _('Perform Full Backup Now') }}</button>
        <div id="backup-status-message" class="mt-2"></div>
        <pre id="backup-log-area" class="log-area" style="display: none;"></pre>
    </section>

    <hr>

    <section id="restore-section">
        <h2>{{ _('One Click Restore') }}</h2>
        <p>{{ _('Restore the system from a previously created full backup. This will overwrite current data.') }}</p>
        <button id="list-backups-btn" class="btn btn-info mb-3">{{ _('Refresh Available Backups') }}</button>
        <div id="restore-status-message" class="mt-2 mb-3"></div>
        <pre id="restore-log-area" class="log-area" style="display: none;"></pre>

        <table id="available-backups-table" class="table table-striped">
            <thead>
                <tr>
                    <th>{{ _('Backup Timestamp (UTC)') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody id="available-backups-tbody">
                <!-- Backup items will be loaded here by JavaScript -->
            </tbody>
        </table>
        <nav aria-label="Backup pagination" id="backup-pagination-nav" style="display: none;">
            <ul class="pagination justify-content-center">
                <li class="page-item" id="backup-prev-page"><a class="page-link" href="#">{{ _('Previous') }}</a></li>
                <li class="page-item" id="backup-next-page"><a class="page-link" href="#">{{ _('Next') }}</a></li>
            </ul>
            <p class="text-center" id="backup-page-info"></p>
        </nav>
    </section>

    <hr>

    <!-- Selective Restore Modal -->
    <div id="selective-restore-modal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-selective-restore-modal">&times;</span>
            <h3>{{ _('Selective Restore Options') }}</h3>
            <p>{{ _('Select components to restore for backup:') }} <strong id="modal-backup-timestamp"></strong></p>
            <form id="selective-restore-form">
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="database" id="component-database" name="components">
                    <label class="form-check-label" for="component-database">{{ _('Database (Bookings, Users, Resources, etc.)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="map_config" id="component-map_config" name="components">
                    <label class="form-check-label" for="component-map_config">{{ _('Map Configuration (Floor map definitions & resource mappings on maps)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="floor_maps" id="component-floor_maps" name="components">
                    <label class="form-check-label" for="component-floor_maps">{{ _('Floor Map Images (in static/floor_map_uploads)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="resource_uploads" id="component-resource_uploads" name="components">
                    <label class="form-check-label" for="component-resource_uploads">{{ _('Resource Images (in static/resource_uploads)') }}</label>
                </div>
                <hr>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="all" id="component-all" name="components_all">
                    <label class="form-check-label" for="component-all">{{ _('ALL COMPONENTS (Full Restore)') }}</label>
                </div>
                <button type="submit" id="confirm-selective-restore-btn" class="btn btn-primary mt-3">{{ _('Proceed with Selected Restore') }}</button>
            </form>
            <div id="selective-restore-modal-status" class="status-message mt-2"></div>
        </div>
    </div>

    <h2>{{ _('Scheduled Full Backups') }}</h2>
    <div id="schedule-status-message" class="status-message my-2" role="alert"></div>
    <form id="backup-schedule-form" class="mb-4">
        <div class="form-group mb-2">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="schedule-enabled" name="is_enabled">
                <label class="form-check-label" for="schedule-enabled">{{ _('Enable Scheduled Backups') }}</label>
            </div>
        </div>
        <div class="form-group mb-2">
            <label for="schedule-type">{{ _('Schedule Type') }}</label>
            <select id="schedule-type" name="schedule_type" class="form-control form-select">
                <option value="daily">{{ _('Daily') }}</option>
                <option value="weekly">{{ _('Weekly') }}</option>
            </select>
        </div>
        <div class="form-group mb-2" id="day-of-week-group" style="display: none;"> <!-- Hidden by default -->
            <label for="schedule-day-of-week">{{ _('Day of Week') }}</label>
            <select id="schedule-day-of-week" name="day_of_week" class="form-control form-select">
                <option value="0">{{ _('Monday') }}</option>
                <option value="1">{{ _('Tuesday') }}</option>
                <option value="2">{{ _('Wednesday') }}</option>
                <option value="3">{{ _('Thursday') }}</option>
                <option value="4">{{ _('Friday') }}</option>
                <option value="5">{{ _('Saturday') }}</option>
                <option value="6">{{ _('Sunday') }}</option>
            </select>
        </div>
        <div class="form-group mb-2">
            <label for="schedule-time-of-day">{{ _('Time of Day (UTC)') }}</label>
            <input type="time" id="schedule-time-of-day" name="time_of_day" class="form-control" required>
        </div>
        <button type="submit" id="save-schedule-btn" class="btn btn-success">{{ _('Save Schedule') }}</button>
    </form>

    <hr>

    <section id="booking-csv-restore-section" class="mb-5">
        <h2>{{ _('Booking CSV Backups') }}</h2>
        <p>{{ _('Restore bookings from a previously generated CSV export. This will add new bookings from the CSV, skipping any that appear to be duplicates based on resource, user, and time.') }}</p>
        
        {% if booking_csv_backups and booking_csv_backups|length > 0 %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ _('Backup Timestamp (UTC)') }}</th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup_ts in booking_csv_backups %}
                        <tr>
                            <td>
                                {% set year = backup_ts[:4] %}
                                {% set month = backup_ts[4:6] %}
                                {% set day = backup_ts[6:8] %}
                                {% set hour = backup_ts[9:11] %}
                                {% set minute = backup_ts[11:13] %}
                                {% set second = backup_ts[13:15] %}
                                {{ year }}-{{ month }}-{{ day }} {{ hour }}:{{ minute }}:{{ second }}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('admin_ui.restore_booking_csv_route', timestamp_str=backup_ts) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('{{ _('Are you sure you want to restore bookings from CSV backup') }} {{ backup_ts }}? {{ _('This may add new bookings or skip duplicates based on existing data.') }}');">
                                        {{ _('Restore Bookings from this CSV') }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>{{ _('No booking CSV backups found.') }}</p>
        {% endif %}
    </section>

    <hr>
    <section id="troubleshooting-tools-section" class="mb-5">
        <h2>{{ _('System Troubleshooting Tools') }}</h2>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ _('View Database Records') }}</h5>
                <p class="card-text">{{ _('Fetch and display the top 100 records from key database tables.') }}</p>
                <button id="view-db-records-btn" class="btn btn-info">{{ _('View DB Records') }}</button>
                <div id="view-db-records-status" class="mt-2"></div>
                <pre id="view-db-records-output" class="log-area" style="display: none; max-height: 400px;"></pre>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ _('Reload Configurations') }}</h5>
                <p class="card-text">{{ _('Attempt to reload system configurations like the backup schedule and map data. Note: Full effect may require deeper application integration for some configurations.') }}</p>
                <button id="reload-configurations-btn" class="btn btn-warning">{{ _('Reload Configurations') }}</button>
                <div id="reload-configurations-status" class="mt-2"></div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">{{ _('Cleanup System Data') }}</h5>
                <p class="card-text text-danger"><strong>{{ _('Warning:') }}</strong> {{ _('This will delete all bookings, resources, and floor maps from the database, and remove all uploaded floor map and resource images. This action is irreversible.') }}</p>
                <button id="cleanup-system-data-btn" class="btn btn-danger">{{ _('Cleanup System Data') }}</button>
                <div id="cleanup-system-data-status" class="mt-2"></div>
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const socket = io();

        const backupButton = document.getElementById('one-click-backup-btn');
        const backupStatusMessageEl = document.getElementById('backup-status-message'); // Renamed for clarity
        const backupLogAreaEl = document.getElementById('backup-log-area');

        const listBackupsButton = document.getElementById('list-backups-btn');
        const restoreStatusMessageEl = document.getElementById('restore-status-message'); // Renamed for clarity
        const restoreLogAreaEl = document.getElementById('restore-log-area');
        const availableBackupsTbody = document.getElementById('available-backups-tbody');
        const availableBackupsTable = document.getElementById('available-backups-table');

        const scheduleForm = document.getElementById('backup-schedule-form');
        const scheduleEnabledCheckbox = document.getElementById('schedule-enabled');
        const scheduleTypeSelect = document.getElementById('schedule-type');
        const dayOfWeekGroup = document.getElementById('day-of-week-group');
        const scheduleDayOfWeekSelect = document.getElementById('schedule-day-of-week');
        const scheduleTimeOfDayInput = document.getElementById('schedule-time-of-day');
        const saveScheduleButton = document.getElementById('save-schedule-btn');
        const scheduleStatusMessage = document.getElementById('schedule-status-message');

        // Selective Restore Modal Elements
        const selectiveRestoreModal = document.getElementById('selective-restore-modal');
        const closeModalBtn = document.getElementById('close-selective-restore-modal');
        const modalBackupTimestampEl = document.getElementById('modal-backup-timestamp');
        const selectiveRestoreForm = document.getElementById('selective-restore-form');
        const confirmSelectiveRestoreBtn = document.getElementById('confirm-selective-restore-btn');
        const selectiveRestoreModalStatusEl = document.getElementById('selective-restore-modal-status');
        const componentCheckboxes = document.querySelectorAll('#selective-restore-form input[name="components"]');
        const componentAllCheckbox = document.getElementById('component-all');

        // Troubleshooting Tools Elements
        const viewDbRecordsBtn = document.getElementById('view-db-records-btn');
        const viewDbRecordsStatusEl = document.getElementById('view-db-records-status');
        const viewDbRecordsOutputEl = document.getElementById('view-db-records-output');

        const reloadConfigurationsBtn = document.getElementById('reload-configurations-btn');
        const reloadConfigurationsStatusEl = document.getElementById('reload-configurations-status');

        const cleanupSystemDataBtn = document.getElementById('cleanup-system-data-btn');
        const cleanupSystemDataStatusEl = document.getElementById('cleanup-system-data-status');

        let currentBackupTaskId = null;
        let currentRestoreTaskId = null;
        let currentVerifyTaskId = null; // Added for verification tasks
        let currentDeleteTaskId = null; // Added for deletion tasks

        let currentPage = 1;
        const backupsPerPage = 5; // Or any other number you prefer
        let allBackups = [];


        socket.on('connect', () => {
            console.log('Socket.IO connected for backup/restore logs.');
        });
        socket.on('disconnect', (reason) => {
            console.warn('Socket.IO disconnected:', reason);
        });
        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });

        function appendLog(logAreaId, message, detail, type = 'info') {
            const logArea = document.getElementById(logAreaId);
            if (!logArea) return;
            logArea.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + type; // e.g. log-info, log-error
            logEntry.textContent = `[${timestamp}] ${message}${detail ? ' - ' + detail : ''}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; // Auto-scroll to bottom
        }

        function keepAlive() {
            fetch('/ping', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    console.warn('Keep-alive ping failed. Status:', response.status);
                    appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                              'Session keep-alive ping failed.', `Status: ${response.status}`, 'error');
                }
            })
            .catch(error => {
                console.error('Keep-alive ping error:', error);
                appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                          'Session keep-alive ping error.', error.message, 'error');
            });
        }
        setInterval(keepAlive, 4 * 60 * 1000); // 4 minutes

        // SocketIO listeners
        socket.on('backup_progress', function(data) {
            console.log('Backup progress event:', data);
            if (data.task_id !== currentBackupTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';

            appendLog('backup-log-area', data.status, data.detail, messageType);
            backupStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            backupStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;


            if (data.status === "Backup completed with overall success: True" || data.status.startsWith("Backup completed with overall success: False")) {
                // backupButton.disabled = false; // Re-enable all relevant buttons
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                console.log('Final backup status displayed:', backupStatusMessageEl.textContent);
                currentBackupTaskId = null; // Clear task ID after processing final message
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) { // also check data.detail for success for loadAvailableBackups
                    loadAvailableBackups();
                }
            }
        });

        socket.on('restore_progress', function(data) {
            console.log('Restore progress event:', data);
            if (data.task_id !== currentRestoreTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';

            appendLog('restore-log-area', data.status, data.detail, messageType);
            restoreStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;

            const lowerStatus = data.status.toLowerCase();
            if (lowerStatus.includes("fully completed") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerStatus.includes("critical error") || lowerStatus.includes("finished")) {
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                // backupButton.disabled = false;
                console.log('Final restore status displayed:', restoreStatusMessageEl.textContent);
                currentRestoreTaskId = null; // Clear task ID after processing final message
            }

            // If actions are present in the data (from a dry run), display them
            if (data.actions && Array.isArray(data.actions)) {
                appendLog('restore-log-area', "DRY RUN ACTIONS:", '', 'info');
                if (data.actions.length === 0) {
                    appendLog('restore-log-area', "  No actions would be performed.", '', 'info');
                } else {
                    data.actions.forEach(action => {
                        appendLog('restore-log-area', `  - ${action}`, '', 'info');
                    });
                }
            }
            // If a summary is present (from selective restore), display it
            if (data.summary && Array.isArray(data.summary)) {
                appendLog('restore-log-area', "SELECTIVE RESTORE SUMMARY:", '', 'info');
                if (data.summary.length === 0) {
                    appendLog('restore-log-area', "  No component actions reported.", '', 'info');
                } else {
                    data.summary.forEach(action_summary => {
                        appendLog('restore-log-area', `  - ${action_summary}`, '', 'info');
                    });
                }
            }
        });

        // One Click Backup
        backupButton.addEventListener('click', function () {
            currentBackupTaskId = null;
            backupLogAreaEl.innerHTML = '';
            backupLogAreaEl.style.display = 'block'; // Show log area
            restoreLogAreaEl.style.display = 'none'; // Hide other log area
            appendLog('backup-log-area', "{{ _('Initiating backup request...') }}", '', 'info');
            // Disable all relevant buttons during one-click backup
            document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = true);

            backupStatusMessageEl.textContent = "{{ _('Initiating backup...') }}";
            backupStatusMessageEl.className = 'alert alert-info';

            fetch('/api/admin/one_click_backup', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                currentBackupTaskId = data.task_id; // Store task_id
                const messageType = data.success ? 'info' : 'error';
                appendLog('backup-log-area', data.message || (data.success ? "{{ _('Backup process started on server.') }}" : "{{ _('Failed to start backup process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                backupStatusMessageEl.textContent = data.message;
                backupStatusMessageEl.className = `alert alert-${messageType}`;

                if (!data.success) {
                    // backupButton.disabled = false;
                    // document.querySelectorAll('.restore-btn').forEach(btn => btn.disabled = false);
                    document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                }
            })
            .catch(error => {
                console.error('Backup error:', error);
                appendLog('backup-log-area', "{{ _('Backup request failed:') }}", error.message, 'error');
                backupStatusMessageEl.textContent = "{{ _('Backup request failed:') }} " + error.toString();
                backupStatusMessageEl.className = 'alert alert-danger';
                // backupButton.disabled = false;
                // document.querySelectorAll('.restore-btn').forEach(btn => btn.disabled = false);
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
            });
        });

        // Selective Restore Form Submission
        selectiveRestoreForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const backupTimestamp = this.dataset.timestamp;
            const selectedComponents = Array.from(document.querySelectorAll('#selective-restore-form input[name="components"]:checked'))
                                         .map(cb => cb.value);

            if (selectedComponents.length === 0) {
                selectiveRestoreModalStatusEl.textContent = "{{ _('Please select at least one component to restore.') }}";
                selectiveRestoreModalStatusEl.className = 'alert alert-warning';
                return;
            }

            currentRestoreTaskId = null; // Reset task ID
            restoreLogAreaEl.innerHTML = ''; // Clear main log area
            restoreLogAreaEl.style.display = 'block';
            backupLogAreaEl.style.display = 'none';
            appendLog('restore-log-area', `{{ _('Initiating selective restore for') }} ${backupTimestamp}...`, `Components: ${selectedComponents.join(', ')}`, 'info');

            // Disable buttons
            confirmSelectiveRestoreBtn.disabled = true;
            // document.querySelectorAll('.restore-btn, .restore-dry-run-btn').forEach(btn => btn.disabled = true);
            // backupButton.disabled = true;
            document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = true);


            restoreStatusMessageEl.textContent = `{{ _('Initiating selective restore...') }}`;
            restoreStatusMessageEl.className = 'alert alert-info';
            selectiveRestoreModalStatusEl.textContent = "{{ _('Processing...') }}";
            selectiveRestoreModalStatusEl.className = 'alert alert-info';


            fetch('/api/admin/selective_restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    backup_timestamp: backupTimestamp,
                    components: selectedComponents
                })
            })
            .then(response => response.json())
            .then(data => {
                currentRestoreTaskId = data.task_id;
                const messageType = data.success ? 'info' : 'error';

                appendLog('restore-log-area', data.message || (data.success ? `{{ _('Selective restore for ${backupTimestamp} process started.') }}` : `{{ _('Failed to start selective restore for ${backupTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                restoreStatusMessageEl.textContent = data.message; // Update main page status
                restoreStatusMessageEl.className = `alert alert-${messageType}`;

                selectiveRestoreModalStatusEl.textContent = data.message; // Update modal status
                selectiveRestoreModalStatusEl.className = `alert alert-${messageType}`;


                if (data.success) {
                    selectiveRestoreModal.style.display = 'none'; // Close modal on successful initiation
                } else {
                    // Re-enable buttons if initiation failed
                    // confirmSelectiveRestoreBtn.disabled = false;
                    // document.querySelectorAll('.restore-btn, .restore-dry-run-btn').forEach(btn => btn.disabled = false);
                    // backupButton.disabled = false;
                    document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn, #confirm-selective-restore-btn').forEach(btn => btn.disabled = false);
                }
            })
            .catch(error => {
                console.error('Selective restore error:', error);
                const errorMsg = `{{ _('Selective restore request for ${backupTimestamp} failed:') }} ${error.toString()}`;
                appendLog('restore-log-area', errorMsg, '', 'error');
                restoreStatusMessageEl.textContent = errorMsg;
                restoreStatusMessageEl.className = 'alert alert-danger';
                selectiveRestoreModalStatusEl.textContent = errorMsg;
                selectiveRestoreModalStatusEl.className = 'alert alert-danger';

                // Re-enable buttons on catch
                // confirmSelectiveRestoreBtn.disabled = false;
                // document.querySelectorAll('.restore-btn, .restore-dry-run-btn').forEach(btn => btn.disabled = false);
                // backupButton.disabled = false;
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn, #confirm-selective-restore-btn').forEach(btn => btn.disabled = false);
            });
        });

        function loadAvailableBackups() {
            restoreStatusMessageEl.textContent = "{{ _('Fetching available backups...') }}";
            restoreStatusMessageEl.className = 'alert alert-info';
            availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Loading...") }}</td></tr>';
            document.getElementById('backup-pagination-nav').style.display = 'none'; // Hide pagination during load

            fetch('/api/admin/list_backups', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.backups) {
                    allBackups = data.backups; // Store all fetched backups
                    currentPage = 1; // Reset to first page
                    displayBackupsPage(); // Display the first page
                    if (allBackups.length > 0) {
                        restoreStatusMessageEl.textContent = "{{ _('Available backups loaded.') }}";
                        restoreStatusMessageEl.className = 'alert alert-success';
                    } else {
                        restoreStatusMessageEl.textContent = "{{ _('No backups found.') }}";
                        restoreStatusMessageEl.className = 'alert alert-info';
                    }
                } else {
                    allBackups = [];
                    availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Failed to load backups.") }}</td></tr>';
                    restoreStatusMessageEl.textContent = "{{ _('Failed to load backups:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    document.getElementById('backup-pagination-nav').style.display = 'none';
                }
            })
            .catch(error => {
                allBackups = [];
                console.error('List backups error:', error);
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Error loading backups.") }}</td></tr>';
                restoreStatusMessageEl.textContent = "{{ _('Error fetching backups:') }} " + error.toString();
                restoreStatusMessageEl.className = 'alert alert-danger';
                document.getElementById('backup-pagination-nav').style.display = 'none';
            });
        }

        function displayBackupsPage() {
            availableBackupsTbody.innerHTML = '';
            const paginationNav = document.getElementById('backup-pagination-nav');
            const pageInfoEl = document.getElementById('backup-page-info');
            const prevPageBtn = document.getElementById('backup-prev-page');
            const nextPageBtn = document.getElementById('backup-next-page');

            if (allBackups.length === 0) {
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("No backups available.") }}</td></tr>';
                paginationNav.style.display = 'none';
                return;
            }

            const startIndex = (currentPage - 1) * backupsPerPage;
            const endIndex = startIndex + backupsPerPage;
            const pageBackups = allBackups.slice(startIndex, endIndex);

            pageBackups.forEach(timestamp => {
                const row = availableBackupsTbody.insertRow();
                const cellTimestamp = row.insertCell();
                const cellAction = row.insertCell();
                let displayTimestamp = timestamp;
                try {
                    const year = timestamp.substring(0,4); const month = timestamp.substring(4,6);
                    const day = timestamp.substring(6,8); const hour = timestamp.substring(9,11);
                    const minute = timestamp.substring(11,13); const second = timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                cellTimestamp.textContent = displayTimestamp;
                const restoreBtn = document.createElement('button');
                restoreBtn.textContent = "{{ _('Restore') }}";
                restoreBtn.className = 'btn btn-sm btn-warning restore-btn me-2';
                restoreBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(restoreBtn);

                const dryRunBtn = document.createElement('button');
                dryRunBtn.textContent = "{{ _('Dry Run') }}";
                dryRunBtn.className = 'btn btn-sm btn-info restore-dry-run-btn me-2';
                dryRunBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(dryRunBtn);

                const verifyBtn = document.createElement('button');
                verifyBtn.textContent = "{{ _('Verify') }}";
                verifyBtn.className = 'btn btn-sm btn-secondary verify-backup-btn me-2'; // Added me-2
                verifyBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(verifyBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = "{{ _('Delete') }}";
                deleteBtn.className = 'btn btn-sm btn-danger delete-backup-btn'; // Removed ms-2, as verifyBtn now has me-2
                deleteBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(deleteBtn);
            });

            // Update pagination controls
            const totalPages = Math.ceil(allBackups.length / backupsPerPage);
            if (totalPages > 1) {
                paginationNav.style.display = 'block';
                pageInfoEl.textContent = `{{ _('Page') }} ${currentPage} {{ _('of') }} ${totalPages}`;
                prevPageBtn.classList.toggle('disabled', currentPage === 1);
                nextPageBtn.classList.toggle('disabled', endIndex >= allBackups.length);
            } else {
                paginationNav.style.display = 'none';
            }
        }

        listBackupsButton.addEventListener('click', loadAvailableBackups);

        document.getElementById('backup-prev-page').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                displayBackupsPage();
            }
        });

        document.getElementById('backup-next-page').addEventListener('click', function(e) {
            e.preventDefault();
            if ((currentPage * backupsPerPage) < allBackups.length) {
                currentPage++;
                displayBackupsPage();
            }
        });

        availableBackupsTable.addEventListener('click', function (event) {
            const targetButton = event.target;
            let isRestore = targetButton.classList.contains('restore-btn');
            let isDryRun = targetButton.classList.contains('restore-dry-run-btn');
            let isVerify = targetButton.classList.contains('verify-backup-btn');
            let isDelete = targetButton.classList.contains('delete-backup-btn');

            if (isVerify) {
                const timestampToVerify = targetButton.getAttribute('data-timestamp');
                
                currentVerifyTaskId = null; 
                currentDeleteTaskId = null; 
                currentRestoreTaskId = null;
                currentBackupTaskId = null;

                restoreLogAreaEl.innerHTML = ''; 
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `VERIFY: Initiating for ${timestampToVerify}...`, '', 'info');

                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = true);
                
                restoreStatusMessageEl.textContent = `{{ _('Initiating verification for') }} ${timestampToVerify}...`;
                restoreStatusMessageEl.className = 'alert alert-info';

                fetch('/api/admin/verify_backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ backup_timestamp: timestampToVerify })
                })
                .then(response => response.json())
                .then(data => {
                    currentVerifyTaskId = data.task_id; 
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', `VERIFY: ${data.message || (data.success ? '{{ _("Verification process started.") }}' : '{{ _("Failed to start verification.") }}')}`, `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message; 
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) { 
                        document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                        currentVerifyTaskId = null; 
                    }
                })
                .catch(error => {
                    console.error('Verify backup error:', error);
                    const errorMsg = `{{ _('Verification request for ${timestampToVerify} failed:') }} ${error.toString()}`;
                    appendLog('restore-log-area', errorMsg, '', 'error');
                    restoreStatusMessageEl.textContent = errorMsg;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                    currentVerifyTaskId = null; 
                });

            } else if (isDelete) {
                const backup_timestamp = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = backup_timestamp;
                 try { // Format for display
                    const year = backup_timestamp.substring(0,4); const month = backup_timestamp.substring(4,6);
                    const day = backup_timestamp.substring(6,8); const hour = backup_timestamp.substring(9,11);
                    const minute = backup_timestamp.substring(11,13); const second = backup_timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                if (!confirm("{{ _('Are you sure you want to delete backup') }} '" + displayTimestamp + "'? {{ _('This action cannot be undone.') }}")) {
                    return;
                }

                currentDeleteTaskId = null;
                currentRestoreTaskId = null; // Clear other task IDs
                currentVerifyTaskId = null;
                currentBackupTaskId = null;

                restoreLogAreaEl.innerHTML = '';
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', "{{ _('Initiating delete request for') }} " + displayTimestamp + "...", '', 'info');

                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = true);

                restoreStatusMessageEl.textContent = "{{ _('Deleting backup...') }}";
                restoreStatusMessageEl.className = 'alert alert-info';

                fetch('/api/admin/delete_backup/' + backup_timestamp, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    currentDeleteTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Deletion process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start deletion for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message;
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) { // If API call itself fails to initiate
                         document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                         currentDeleteTaskId = null;
                    }
                    // Socket listener 'backup_delete_progress' will handle final re-enable and list refresh
                })
                .catch(error => {
                    console.error('Delete backup error:', error);
                    appendLog('restore-log-area', `{{ _('Delete request for ${displayTimestamp} failed:') }}`, error.message, 'error');
                    restoreStatusMessageEl.textContent = `{{ _('Delete request for ${displayTimestamp} failed:') }} ${error.toString()}`;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                    currentDeleteTaskId = null;
                });

            } else if (isRestore || isDryRun) { // Logic for Restore and Dry Run
                const timestampToProcess = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToProcess;
                try {
                    const year = timestampToProcess.substring(0,4); const month = timestampToProcess.substring(4,6);
                    const day = timestampToProcess.substring(6,8); const hour = timestampToProcess.substring(9,11);
                    const minute = timestampToProcess.substring(11,13); const second = timestampToProcess.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                currentRestoreTaskId = null; // Reset restore task ID
                currentDeleteTaskId = null; // Clear other task IDs
                currentVerifyTaskId = null;
                currentBackupTaskId = null;


                let confirmationMessage = "";
                let endpoint = "";
                let actionVerb = "";

                if (isRestore) {
                    confirmationMessage = "{{ _('Are you sure you want to restore from backup') }} " + displayTimestamp + "? {{ _('This will overwrite current data and may require an application restart.') }}";
                    endpoint = '/api/admin/one_click_restore';
                    actionVerb = "{{ _('restore from') }}";
                } else { // isDryRun
                    confirmationMessage = "{{ _('Are you sure you want to perform a dry run for restoring from backup') }} " + displayTimestamp + "?";
                    endpoint = `/api/admin/restore_dry_run/${timestampToProcess}`; // Timestamp in URL for dry run
                    actionVerb = "{{ _('dry run restore from') }}";
                }

                if (!confirm(confirmationMessage)) {
                    return;
                }

                currentRestoreTaskId = null; // This was already here, ensure it's the active task type
                restoreLogAreaEl.innerHTML = '';
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `{{ _('Initiating') }} ${actionVerb} ${displayTimestamp}...`, '', 'info');

                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = true);
                // backupButton.disabled = true; // Covered by above selector
                restoreStatusMessageEl.textContent = `{{ _('Initiating') }} ${actionVerb} ${displayTimestamp}... {{ _('This may take a while. Please do not navigate away.') }}`;
                restoreStatusMessageEl.className = 'alert alert-info';

                let fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                };
                // For actual restore, timestamp is in body. For dry run, it's in URL.
                if (isRestore) {
                    fetchOptions.body = JSON.stringify({ backup_timestamp: timestampToProcess });
                }


                fetch(endpoint, fetchOptions)
                .then(response => response.json())
                .then(data => {
                    currentRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start process for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message;
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) {
                        // document.querySelectorAll('.restore-btn, .restore-dry-run-btn').forEach(btn => btn.disabled = false);
                        // backupButton.disabled = false;
                        document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                    }
                    // If it's a dry run and successful, display actions from HTTP response for immediate feedback
                    if (isDryRun && data.success && data.actions && Array.isArray(data.actions)) {
                        appendLog('restore-log-area', "DRY RUN ACTIONS (from HTTP response):", '', 'info');
                        if (data.actions.length === 0) {
                            appendLog('restore-log-area', "  No actions would be performed.", '', 'info');
                        } else {
                            data.actions.forEach(action => {
                                appendLog('restore-log-area', `  - ${action}`, '', 'info');
                            });
                        }
                    }
                    // The socket listener will also receive actions with the final success message,
                    // which might update or confirm this list.
                })
                .catch(error => {
                    console.error(`${actionVerb} error:`, error);
                    appendLog('restore-log-area', `{{ _('Request for ${actionVerb} ${displayTimestamp} failed:') }}`, error.message, 'error');
                    restoreStatusMessageEl.textContent = `{{ _('Request for ${actionVerb} ${displayTimestamp} failed:') }} ${error.toString()}`;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    // document.querySelectorAll('.restore-btn, .restore-dry-run-btn').forEach(btn => btn.disabled = false);
                    // backupButton.disabled = false;
                    document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                });
            } else if (targetButton.classList.contains('restore-btn')) { // This is now the entry point for Selective Restore Modal
                const timestampToRestore = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToRestore;
                 try { // Format for display
                    const year = timestampToRestore.substring(0,4); const month = timestampToRestore.substring(4,6);
                    const day = timestampToRestore.substring(6,8); const hour = timestampToRestore.substring(9,11);
                    const minute = timestampToRestore.substring(11,13); const second = timestampToRestore.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                modalBackupTimestampEl.textContent = displayTimestamp;
                selectiveRestoreForm.dataset.timestamp = timestampToRestore; // Store timestamp for form submission

                // Reset form: uncheck all individual, check 'ALL', clear status
                componentCheckboxes.forEach(cb => cb.checked = true);
                componentAllCheckbox.checked = true;
                selectiveRestoreModalStatusEl.textContent = '';
                selectiveRestoreModalStatusEl.className = 'status-message mt-2';

                selectiveRestoreModal.style.display = 'block';
            }
        });

        // Modal Close Button
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                selectiveRestoreModal.style.display = 'none';
            });
        }
        window.addEventListener('click', function(event) { // Close if clicked outside modal content
            if (event.target == selectiveRestoreModal) {
                selectiveRestoreModal.style.display = 'none';
            }
        });

        // "ALL COMPONENTS" checkbox logic
        componentAllCheckbox.addEventListener('change', function() {
            componentCheckboxes.forEach(cb => cb.checked = this.checked);
        });

        componentCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) {
                    componentAllCheckbox.checked = false;
                } else {
                    // Check if all individual components are checked
                    const allChecked = Array.from(componentCheckboxes).every(indCb => indCb.checked);
                    if (allChecked) {
                        componentAllCheckbox.checked = true;
                    }
                }
            });
        });


        loadAvailableBackups(); // Initial load

        // --- Scheduled Backups Logic ---
        // SocketIO handler for backup verification progress
        socket.on('verify_backup_progress', function(data) {
            console.log('Verify backup progress event:', data);
            if (data.task_id !== currentVerifyTaskId) return;

            let messageType = 'info';
            // Determine message type based on content
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.results && data.results.status && data.results.status !== 'verified_present' && data.results.status !== 'pending') messageType = 'error';
            else if (data.results && data.results.status && data.results.status === 'verified_present') messageType = 'success';


            appendLog('restore-log-area', `VERIFY: ${data.status}`, data.detail, messageType);
            // Update main status message element as well
            restoreStatusMessageEl.textContent = `VERIFY: ${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType}`;

            if (data.results) { // This is the final message with all results
                appendLog('restore-log-area', `VERIFY: Overall Status: ${data.results.status}`, '', data.results.status === 'verified_present' ? 'success' : 'error');
                if (data.results.checks && data.results.checks.length > 0) {
                    appendLog('restore-log-area', 'VERIFY: Detailed Checks:', '', 'info');
                    data.results.checks.forEach(check => {
                        let checkLogType = 'info';
                        if (check.status !== 'found' && check.status !== 'found_count_match') {
                            checkLogType = 'error';
                        }
                        let detailMsg = `- Item: ${check.item} (${check.type || 'N/A'}) - Status: ${check.status}`;
                        if (check.hasOwnProperty('expected_count')) {
                            detailMsg += `, Expected: ${check.expected_count}, Actual: ${check.actual_count}`;
                        }
                        appendLog('restore-log-area', detailMsg, '', checkLogType);
                    });
                }
                if (data.results.errors && data.results.errors.length > 0) {
                    appendLog('restore-log-area', 'VERIFY: Errors Found:', '', 'error');
                    data.results.errors.forEach(err => {
                        appendLog('restore-log-area', `  - ${err}`, '', 'error');
                    });
                }
                // Re-enable buttons on completion
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                // backupButton.disabled = false; // Covered by above
                currentVerifyTaskId = null;
            } else if (data.status && (data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("missing") || data.status.toLowerCase().includes("critical") )) {
                 // Re-enable buttons if an intermediate error message implies failure for the task
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                // backupButton.disabled = false; // Covered by above
                currentVerifyTaskId = null;
            }
        });

        // Listener for Backup Deletion Progress
        socket.on('backup_delete_progress', function(data) {
            console.log('Backup delete progress event:', data);
            if (data.task_id !== currentDeleteTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';
            else if (data.status && data.status.toLowerCase().includes('failed')) messageType = 'error';


            appendLog('restore-log-area', data.status, data.detail, messageType);
            restoreStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;

            const lowerStatus = data.status.toLowerCase();
            const lowerDetail = data.detail ? data.detail.toLowerCase() : "";

            if (lowerStatus.includes("finished") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerDetail.includes("success") || lowerDetail.includes("failure") || lowerDetail.includes("critical_error")) {
                document.querySelectorAll('.restore-btn, .restore-dry-run-btn, .verify-backup-btn, .delete-backup-btn, #one-click-backup-btn').forEach(btn => btn.disabled = false);
                console.log('Final delete status displayed:', restoreStatusMessageEl.textContent);
                currentDeleteTaskId = null;
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) {
                    loadAvailableBackups(); // Refresh list on successful deletion
                }
            }
        });


        function toggleDayOfWeekVisibility() { /* ... existing ... */
            if (scheduleTypeSelect.value === 'weekly') {
                dayOfWeekGroup.style.display = 'block';
            } else {
                dayOfWeekGroup.style.display = 'none';
            }
        }
        scheduleTypeSelect.addEventListener('change', toggleDayOfWeekVisibility);

        function loadBackupSchedule() { /* ... existing ... */
            scheduleStatusMessage.textContent = "{{ _('Loading schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';
            fetch('/api/admin/backup_schedule', {
                method: 'GET',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message && !data.is_enabled && !data.schedule_type) {
                    scheduleStatusMessage.textContent = "{{ _('Could not load schedule:') }} " + data.message;
                    scheduleStatusMessage.className = 'alert alert-danger';
                    return;
                }
                scheduleEnabledCheckbox.checked = data.is_enabled;
                scheduleTypeSelect.value = data.schedule_type || 'daily';
                if (data.day_of_week !== null && data.day_of_week !== undefined) {
                    scheduleDayOfWeekSelect.value = data.day_of_week;
                } else {
                    scheduleDayOfWeekSelect.value = "0";
                }
                if (data.time_of_day) {
                    scheduleTimeOfDayInput.value = data.time_of_day.substring(0, 5);
                } else {
                    scheduleTimeOfDayInput.value = "02:00";
                }
                toggleDayOfWeekVisibility();
                scheduleStatusMessage.textContent = "{{ _('Schedule loaded.') }}";
                scheduleStatusMessage.className = 'alert alert-success';
            })
            .catch(error => {
                console.error('Load schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error loading schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            });
        }
        scheduleForm.addEventListener('submit', function(event) { /* ... existing ... */
            event.preventDefault();
            saveScheduleButton.disabled = true;
            scheduleStatusMessage.textContent = "{{ _('Saving schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';
            const payload = {
                is_enabled: scheduleEnabledCheckbox.checked,
                schedule_type: scheduleTypeSelect.value,
                time_of_day: scheduleTimeOfDayInput.value
            };
            if (payload.schedule_type === 'weekly') {
                payload.day_of_week = parseInt(scheduleDayOfWeekSelect.value, 10);
            } else {
                payload.day_of_week = null;
            }
            fetch('/api/admin/backup_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    scheduleStatusMessage.textContent = "{{ _('Schedule saved successfully.') }} " + (data.message || "");
                    scheduleStatusMessage.className = 'alert alert-success';
                } else {
                    scheduleStatusMessage.textContent = "{{ _('Failed to save schedule:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    scheduleStatusMessage.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('Save schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error saving schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            })
            .finally(() => {
                saveScheduleButton.disabled = false;
            });
        });
        loadBackupSchedule(); // Initial Load

        // --- Troubleshooting Tools Event Listeners ---
        if (viewDbRecordsBtn) {
            viewDbRecordsBtn.addEventListener('click', function() {
                viewDbRecordsStatusEl.textContent = "{{ _('Fetching DB records...') }}";
                viewDbRecordsStatusEl.className = 'alert alert-info';
                viewDbRecordsOutputEl.style.display = 'none';
                viewDbRecordsOutputEl.textContent = '';
                viewDbRecordsBtn.disabled = true;

                fetch('/api/admin/view_db_raw_top100', {
                    method: 'GET',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                if (data.success && data.data) {
                    viewDbRecordsOutputEl.innerHTML = ''; // Clear previous content
                        viewDbRecordsOutputEl.style.display = 'block';
                    
                    for (const tableName in data.data) {
                        if (data.data.hasOwnProperty(tableName)) {
                            const records = data.data[tableName];

                            // Create a container for each table's data
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'db-table-container mb-3';

                            // Create a button for the table name (for collapse/expand)
                            const tableButton = document.createElement('button');
                            tableButton.className = 'btn btn-outline-primary btn-sm mb-1 w-100 text-start';
                            tableButton.textContent = `${tableName} (${records.length} records)`;
                            
                            // Create a div for the records, initially hidden
                            const recordsDiv = document.createElement('div');
                            recordsDiv.className = 'db-records-content'; 
                            recordsDiv.style.display = 'none'; // Start collapsed

                            if (records.length > 0) {
                                const preFormattedRecords = document.createElement('pre');
                                preFormattedRecords.style.whiteSpace = 'pre-wrap'; // Ensure wrapping
                                preFormattedRecords.style.wordBreak = 'break-all'; // Break long strings
                                preFormattedRecords.textContent = JSON.stringify(records, null, 2);
                                recordsDiv.appendChild(preFormattedRecords);
                            } else {
                                recordsDiv.textContent = "{{ _('No records found for this table.') }}";
                            }

                            tableButton.addEventListener('click', function() {
                                const isHidden = recordsDiv.style.display === 'none';
                                recordsDiv.style.display = isHidden ? 'block' : 'none';
                                tableButton.classList.toggle('active', isHidden); 
                            });

                            tableContainer.appendChild(tableButton);
                            tableContainer.appendChild(recordsDiv);
                            viewDbRecordsOutputEl.appendChild(tableContainer);
                        }
                    }
                        viewDbRecordsStatusEl.textContent = "{{ _('DB records fetched successfully.') }}";
                        viewDbRecordsStatusEl.className = 'alert alert-success';
                    } else {
                        viewDbRecordsStatusEl.textContent = "{{ _('Failed to fetch DB records:') }} " + (data.message || "{{ _('Unknown error.') }}");
                        viewDbRecordsStatusEl.className = 'alert alert-danger';
                    viewDbRecordsOutputEl.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('View DB Records error:', error);
                    viewDbRecordsStatusEl.textContent = "{{ _('Error fetching DB records:') }} " + error.toString();
                    viewDbRecordsStatusEl.className = 'alert alert-danger';
                })
                .finally(() => {
                    viewDbRecordsBtn.disabled = false;
                });
            });
        }

        if (reloadConfigurationsBtn) {
            reloadConfigurationsBtn.addEventListener('click', function() {
                reloadConfigurationsStatusEl.textContent = "{{ _('Attempting to reload configurations...') }}";
                reloadConfigurationsStatusEl.className = 'alert alert-info';
                reloadConfigurationsBtn.disabled = true;

                fetch('/api/admin/reload_configurations', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        reloadConfigurationsStatusEl.textContent = "{{ _('Configuration reload attempt finished.') }} " + (data.message || "");
                        reloadConfigurationsStatusEl.className = 'alert alert-success';
                    } else {
                        reloadConfigurationsStatusEl.textContent = "{{ _('Failed to reload configurations:') }} " + (data.message || "{{ _('Unknown error.') }}");
                        reloadConfigurationsStatusEl.className = 'alert alert-danger';
                    }
                })
                .catch(error => {
                    console.error('Reload Configurations error:', error);
                    reloadConfigurationsStatusEl.textContent = "{{ _('Error reloading configurations:') }} " + error.toString();
                    reloadConfigurationsStatusEl.className = 'alert alert-danger';
                })
                .finally(() => {
                    reloadConfigurationsBtn.disabled = false;
                });
            });
        }

        if (cleanupSystemDataBtn) {
            cleanupSystemDataBtn.addEventListener('click', function() {
                const confirmationPrompt = "{{ _('Type CONFIRM to delete bookings, resources, floor maps, and all uploaded floor map/resource images. This action is irreversible.') }}";
                const userInput = prompt(confirmationPrompt);

                if (userInput === "CONFIRM") {
                    cleanupSystemDataStatusEl.textContent = "{{ _('Processing cleanup...') }}";
                    cleanupSystemDataStatusEl.className = 'alert alert-info';
                    cleanupSystemDataBtn.disabled = true;

                    fetch('/api/admin/cleanup_system_data', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            cleanupSystemDataStatusEl.textContent = "{{ _('System data cleanup successful.') }} " + (data.message || "");
                            cleanupSystemDataStatusEl.className = 'alert alert-success';
                            // Optionally, refresh parts of the page or prompt user to refresh
                            loadAvailableBackups(); // For example, if cleanup affects backup list display consistency
                        } else {
                            cleanupSystemDataStatusEl.textContent = "{{ _('Cleanup failed or partially failed:') }} " + (data.message || "{{ _('Unknown error.') }}");
                            cleanupSystemDataStatusEl.className = 'alert alert-danger';
                        }
                    })
                    .catch(error => {
                        console.error('Cleanup System Data error:', error);
                        cleanupSystemDataStatusEl.textContent = "{{ _('Error during cleanup:') }} " + error.toString();
                        cleanupSystemDataStatusEl.className = 'alert alert-danger';
                    })
                    .finally(() => {
                        cleanupSystemDataBtn.disabled = false;
                    });
                } else if (userInput !== null) { // User typed something other than CONFIRM
                    cleanupSystemDataStatusEl.textContent = "{{ _('Cleanup cancelled. Confirmation not received.') }}";
                    cleanupSystemDataStatusEl.className = 'alert alert-warning';
                } else { // User clicked cancel on the prompt
                     cleanupSystemDataStatusEl.textContent = "{{ _('Cleanup cancelled.') }}";
                     cleanupSystemDataStatusEl.className = 'alert alert-info';
                }
            });
        }
    });
</script>
{% endblock %}
