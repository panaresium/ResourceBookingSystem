{% extends "base.html" %}

{% block title %}{{ _('Admin - Backup & Restore') }}{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js" integrity="sha512-skuhu6jj+sQnhLq1Txsack8VfnIrX8wL+MTFilYlFFT/NuLJm7eya7zOROs39Jy5cjASMEWqxLzijRVmKhsqWQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
    .log-area {
        max-height: 200px;
        overflow-y: auto;
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
    }
    .log-entry {
        padding: 2px 0;
    }
    .log-error {
        color: red;
        font-weight: bold;
    }
    .log-success {
        color: green;
        font-weight: bold;
    }
    .log-info {
        color: #333;
    }
    /* Styles for DB Records View */
    .db-table-container {
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
    }
    .db-records-content pre {
        background-color: #f8f9fa; /* Light background for pre */
        padding: 10px;
        border-radius: 4px;
        max-height: 300px; /* Max height for individual record lists */
        overflow-y: auto;
    }
    /* Style for active (expanded) button */
    #view-db-records-output .btn.active { 
        background-color: #007bff;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ _('Admin - Backup & Restore') }}</h1>
    <hr>
    <p>{{ _('Current UTC Time:') }} <span id="utc-clock">Loading...</span></p>
    <hr>

    <!-- Full System Backup & Restore Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Full System Backup & Restore') }}</h2>
        </div>
        <div class="card-body">
            <section id="backup-section" class="mb-4"> <!-- mb-5 to mb-4 as it's inside a card -->
                <h5>{{ _('One Click Backup') }}</h5>
                <p>{{ _('Perform a full backup of the database, map configurations, and uploaded media files.') }}</p>
                <button id="one-click-backup-btn" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> {{ _('Perform Full Backup Now') }}</button>
                <div id="backup-status-message" class="mt-2"></div>
                <pre id="backup-log-area" class="log-area" style="display: none;"></pre>
            </section>

            <hr> <!-- Kept HR for separation within the same card -->

            <section id="restore-section">
                <h5>{{ _('One Click Restore') }}</h5>
                <p>{{ _('Restore the system from a previously created full backup. This will overwrite current data.') }}</p>
                <button id="list-backups-btn" class="btn btn-info mb-3"><i class="fas fa-sync-alt"></i> {{ _('Refresh Available Backups') }}</button>
                <div id="restore-status-message" class="mt-2 mb-3"></div>
                <pre id="restore-log-area" class="log-area" style="display: none;"></pre>

        <table id="available-backups-table" class="table table-striped">
            <thead>
                <tr>
                    <th>{{ _('Backup Timestamp (UTC)') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody id="available-backups-tbody">
                <!-- Backup items will be loaded here by JavaScript -->
            </tbody>
        </table>
        <nav aria-label="Backup pagination" id="backup-pagination-nav" style="display: none;">
            <ul class="pagination justify-content-center">
                <li class="page-item" id="backup-prev-page"><a class="page-link" href="#">{{ _('Previous') }}</a></li>
                <li class="page-item" id="backup-next-page"><a class="page-link" href="#">{{ _('Next') }}</a></li>
            </ul>
            <p class="text-center" id="backup-page-info"></p>
        </nav>
    </section>
        </div> <!-- End card-body for Full System Backup & Restore -->
    </div> <!-- End card for Full System Backup & Restore -->

    <!-- Selective Restore Modal (remains outside card structure as it's a modal) -->
    <div id="selective-restore-modal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-selective-restore-modal">&times;</span>
            <h3>{{ _('Selective Restore Options') }}</h3>
            <p>{{ _('Select components to restore for backup:') }} <strong id="modal-backup-timestamp"></strong></p>
            <form id="selective-restore-form">
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="database" id="component-database" name="components">
                    <label class="form-check-label" for="component-database">{{ _('Database (Bookings, Users, Resources, etc.)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="map_config" id="component-map_config" name="components">
                    <label class="form-check-label" for="component-map_config">{{ _('Map Configuration (Floor map definitions & resource mappings on maps)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="floor_maps" id="component-floor_maps" name="components">
                    <label class="form-check-label" for="component-floor_maps">{{ _('Floor Map Images (in static/floor_map_uploads)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="resource_uploads" id="component-resource_uploads" name="components">
                    <label class="form-check-label" for="component-resource_uploads">{{ _('Resource Images (in static/resource_uploads)') }}</label>
                </div>
                <hr>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="all" id="component-all" name="components_all">
                    <label class="form-check-label" for="component-all">{{ _('ALL COMPONENTS (Full Restore)') }}</label>
                </div>
                <button type="submit" id="confirm-selective-restore-btn" class="btn btn-primary mt-3">{{ _('Proceed with Selected Restore') }}</button>
            </form>
            <div id="selective-restore-modal-status" class="status-message mt-2"></div>
        </div>
    </div>

    <!-- Scheduled Full System Backups Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Scheduled Full System Backups') }}</h2>
        </div>
        <div class="card-body">
            <div id="schedule-status-message" class="status-message my-2" role="alert"></div>
            <form id="backup-schedule-form"> <!-- Removed mb-4 from form as card has mb-4 -->
                <div class="form-group mb-2">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="schedule-enabled" name="is_enabled">
                        <label class="form-check-label" for="schedule-enabled">{{ _('Enable Scheduled Backups') }}</label>
                    </div>
                </div>
                <div class="form-group mb-2">
                    <label for="schedule-type">{{ _('Schedule Type') }}</label>
                    <select id="schedule-type" name="schedule_type" class="form-control form-select">
                        <option value="daily">{{ _('Daily') }}</option>
                        <option value="weekly">{{ _('Weekly') }}</option>
                    </select>
                </div>
                <div class="form-group mb-2" id="day-of-week-group" style="display: none;"> <!-- Hidden by default -->
                    <label for="schedule-day-of-week">{{ _('Day of Week') }}</label>
                    <select id="schedule-day-of-week" name="day_of_week" class="form-control form-select">
                        <option value="0">{{ _('Monday') }}</option>
                        <option value="1">{{ _('Tuesday') }}</option>
                        <option value="2">{{ _('Wednesday') }}</option>
                        <option value="3">{{ _('Thursday') }}</option>
                        <option value="4">{{ _('Friday') }}</option>
                        <option value="5">{{ _('Saturday') }}</option>
                        <option value="6">{{ _('Sunday') }}</option>
                    </select>
                </div>
                <div class="form-group mb-2">
                    <label for="schedule-time-of-day">{{ _('Time of Day (UTC)') }}</label>
                    <input type="time" id="schedule-time-of-day" name="time_of_day" class="form-control" required>
                </div>
                <button type="submit" id="save-schedule-btn" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Schedule') }}</button>
            </form>
        </div> <!-- End card-body for Scheduled Full System Backups -->
    </div> <!-- End card for Scheduled Full System Backups -->

    <!-- Booking CSV Backups Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Booking CSV Backups') }}</h2>
        </div>
        <div class="card-body">
            <section id="booking-csv-restore-section"> <!-- Removed mb-5 -->
                <p>{{ _('Restore bookings from a previously generated CSV export. This will add new bookings from the CSV, skipping any that appear to be duplicates based on resource, user, and time.') }}</p>

                <form method="POST" action="{{ url_for('admin_ui.manual_backup_bookings_csv_route') }}" style="margin-bottom: 15px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <label class="sr-only" for="booking_backup_range">{{ _('Select Backup Range') }}</label>
                            <select class="custom-select mr-sm-2" id="booking_backup_range" name="backup_range_type">
                                <option value="all" selected>{{ _('All Bookings') }}</option>
                                <option value="1day">{{ _('Last 1 Day') }}</option>
                                <option value="3days">{{ _('Last 3 Days') }}</option>
                                <option value="7days">{{ _('Last 7 Days') }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary" onclick="return confirm('{{ _('Are you sure you want to manually back up bookings for the selected range to a new CSV file?') }}');">
                                <i class="fas fa-file-csv"></i> {{ _('Backup Bookings to CSV') }}
                            </button>
                        </div>
                    </div>
                </form>

                {% if booking_csv_backups and booking_csv_backups|length > 0 %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ _('Backup Details') }}</th> {# Changed header #}
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup_item in booking_csv_backups %} {# Changed loop variable #}
                        <tr>
                            <td>
                                {{ backup_item.display_name }} {# Use new display_name field #}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('admin_ui.restore_booking_csv_route', timestamp_str=backup_item.timestamp) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('{{ _('Are you sure you want to restore bookings from CSV backup') }} \'{{ backup_item.display_name }}\'? {{ _('This may add new bookings or skip duplicates based on existing data.') }}');">
                                        {{ _('Restore Bookings from this CSV') }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_ui.verify_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-info btn-sm">
                                        <i class="fas fa-check-circle"></i> {{ _('Verify') }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_ui.delete_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{{ _('Are you sure you want to permanently delete the booking CSV backup for file:') }} ' + '{{ backup_item.display_name | e }}');">
                                        <i class="fas fa-trash-alt"></i> {{ _('Delete') }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>{{ _('No booking CSV backups found.') }}</p>
        {% endif %}

        {% if booking_csv_total_pages > 1 %}
        <nav aria-label="Booking CSV Backup Pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if booking_csv_has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_ui.serve_backup_restore_page', page=booking_csv_page - 1) }}">{{ _('Previous') }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">{{ _('Previous') }}</span>
                    </li>
                {% endif %}

                <li class="page-item disabled">
                    <span class="page-link">{{ _('Page %(page)s of %(total_pages)s', page=booking_csv_page, total_pages=booking_csv_total_pages) }}</span>
                </li>

                {% if booking_csv_has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_ui.serve_backup_restore_page', page=booking_csv_page + 1) }}">{{ _('Next') }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">{{ _('Next') }}</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </section>
        </div> <!-- End card-body for Booking CSV Backups -->
    </div> <!-- End card for Booking CSV Backups -->

    <!-- Scheduled Booking CSV Backups Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Scheduled Booking CSV Backups') }}</h2>
        </div>
        <div class="card-body">
            <section id="booking-csv-schedule-section"> <!-- Removed mb-5 -->
                {# Ensure the route name 'admin_ui.save_booking_csv_schedule_route' is what will be created later #}
                <form method="POST" action="{{ url_for('admin_ui.save_booking_csv_schedule_route') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- h3 removed as card-title is used -->
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="booking_csv_schedule_enabled" name="booking_csv_schedule_enabled" value="true">
                            <label class="form-check-label" for="booking_csv_schedule_enabled">
                                {{ _('Enable Scheduled Booking CSV Backups') }}
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="booking_csv_schedule_interval_value">{{ _('Backup Interval Value') }}</label>
                            <input type="number" class="form-control" id="booking_csv_schedule_interval_value" name="booking_csv_schedule_interval_value" value="24" min="1">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="booking_csv_schedule_interval_unit">{{ _('Interval Unit') }}</label>
                            <select class="custom-select" id="booking_csv_schedule_interval_unit" name="booking_csv_schedule_interval_unit">
                                <option value="hours" selected>{{ _('Hours') }}</option>
                                <option value="days">{{ _('Days') }}</option>
                                <option value="minutes">{{ _('Minutes') }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="booking_csv_schedule_range_type">{{ _('Backup Data Range for Schedule') }}</label>
                        <select class="custom-select" id="booking_csv_schedule_range_type" name="booking_csv_schedule_range_type">
                            <option value="all" selected>{{ _('All Bookings') }}</option>
                            <option value="1day">{{ _('Last 1 Day') }}</option>
                            <option value="3days">{{ _('Last 3 Days') }}</option>
                            <option value="7days">{{ _('Last 7 Days') }}</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> {{ _('Save Schedule Settings') }}
                    </button>
                </form>
            </section>
        </div> <!-- End card-body for Scheduled Booking CSV Backups -->
    </div> <!-- End card for Scheduled Booking CSV Backups -->

    {# The System Troubleshooting Tools section that was here has been moved to admin_troubleshooting.html #}
    {# Ensure the <hr> that was above it is also removed if it's now redundant, or kept if it separates from the above section. #}
    {# Based on the previous structure, the <hr> before troubleshooting tools should remain to separate it from Booking CSV section. #}
    {# However, since the entire troubleshooting section is gone, the <hr> immediately preceding it is also gone. #}
    {# The final <hr> of the booking CSV section now acts as the separator before the script block or end of content. #}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const socket = io();

        // --- Global Interactive Element Selectors ---
        const interactiveElementSelectors = [
            '#one-click-backup-btn',
            '#list-backups-btn',
            '#save-schedule-btn',
            '.restore-btn', // Dynamically generated
            '.restore-dry-run-btn', // Dynamically generated
            '.delete-backup-btn', // Dynamically generated
            'form[action^="/admin/verify_full_backup/"] button[type="submit"]', // Dynamically generated
            '#confirm-selective-restore-btn',
            // Booking CSV buttons (some might be static, some dynamic if list is paginated by Flask)
            'form[action*="manual_backup_bookings_csv_route"] button[type="submit"]',
            'form[action*="restore_booking_csv_route"] button[type="submit"]',
            'form[action*="verify_booking_csv_backup_route"] button[type="submit"]',
            'form[action*="delete_booking_csv_backup_route"] button[type="submit"]',
            'form[action*="save_booking_csv_schedule_route"] button[type="submit"]',
            // Pagination buttons for full backups
            '#backup-prev-page a.page-link',
            '#backup-next-page a.page-link',
            // Pagination for booking CSV backups (these are direct links, less critical to disable, but for consistency)
            // 'nav[aria-label="Booking CSV Backup Pagination"] a.page-link', // These are <a> tags, not buttons. Disabling might be complex or not standard.
            // Schedule form inputs
            '#schedule-enabled',
            '#schedule-type',
            '#schedule-day-of-week',
            '#schedule-time-of-day',
            // Selective restore checkboxes (disabling these during operation might be good)
            '#selective-restore-form input.component-checkbox',
            '#selective-restore-form input#component-all'
        ];

        function disablePageInteractions() {
            console.log("Disabling page interactions.");
            interactiveElementSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.tagName === 'A' && el.classList.contains('page-link')) {
                        el.classList.add('disabled'); // Bootstrap way to disable pagination links
                        el.setAttribute('aria-disabled', 'true');
                        el.onclick = (event) => event.preventDefault(); // Prevent navigation
                    } else {
                        el.disabled = true;
                    }
                });
            });
        }

        function enablePageInteractions() {
            console.log("Enabling page interactions.");
            interactiveElementSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.tagName === 'A' && el.classList.contains('page-link')) {
                        el.classList.remove('disabled');
                        el.removeAttribute('aria-disabled');
                        el.onclick = null; // Restore default behavior
                    } else {
                        el.disabled = false;
                    }
                });
            });
            // Special handling for pagination list items if needed (e.g. 'disabled' class on <li>)
            // This is generally handled by Bootstrap's JS or by the logic that adds/removes 'disabled' on the <a> tag.
        }

        // --- UTC Clock ---
        function updateUtcClock() {
            const clockElement = document.getElementById('utc-clock');
            if (clockElement) {
                const now = new Date();
                // Using a more custom format: YYYY-MM-DD HH:MM:SS UTC
                const year = now.getUTCFullYear();
                const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                const day = String(now.getUTCDate()).padStart(2, '0');
                const hours = String(now.getUTCHours()).padStart(2, '0');
                const minutes = String(now.getUTCMinutes()).padStart(2, '0');
                const seconds = String(now.getUTCSeconds()).padStart(2, '0');
                const customUtcString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
                clockElement.textContent = customUtcString;
            }
        }
        setInterval(updateUtcClock, 1000);
        updateUtcClock(); // Initial call
        // --- End UTC Clock ---

        const backupButton = document.getElementById('one-click-backup-btn');
        const backupStatusMessageEl = document.getElementById('backup-status-message'); // Renamed for clarity
        const backupLogAreaEl = document.getElementById('backup-log-area');

        const listBackupsButton = document.getElementById('list-backups-btn');
        const restoreStatusMessageEl = document.getElementById('restore-status-message'); // Renamed for clarity
        const restoreLogAreaEl = document.getElementById('restore-log-area');
        const availableBackupsTbody = document.getElementById('available-backups-tbody');
        const availableBackupsTable = document.getElementById('available-backups-table');

        const scheduleForm = document.getElementById('backup-schedule-form');
        const scheduleEnabledCheckbox = document.getElementById('schedule-enabled');
        const scheduleTypeSelect = document.getElementById('schedule-type');
        const dayOfWeekGroup = document.getElementById('day-of-week-group');
        const scheduleDayOfWeekSelect = document.getElementById('schedule-day-of-week');
        const scheduleTimeOfDayInput = document.getElementById('schedule-time-of-day');
        const saveScheduleButton = document.getElementById('save-schedule-btn');
        const scheduleStatusMessage = document.getElementById('schedule-status-message');

        // Selective Restore Modal Elements
        const selectiveRestoreModal = document.getElementById('selective-restore-modal');
        const closeModalBtn = document.getElementById('close-selective-restore-modal');
        const modalBackupTimestampEl = document.getElementById('modal-backup-timestamp');
        const selectiveRestoreForm = document.getElementById('selective-restore-form');
        const confirmSelectiveRestoreBtn = document.getElementById('confirm-selective-restore-btn');
        const selectiveRestoreModalStatusEl = document.getElementById('selective-restore-modal-status');
        const componentCheckboxes = document.querySelectorAll('#selective-restore-form input[name="components"]');
        const componentAllCheckbox = document.getElementById('component-all');

        // Troubleshooting Tools Elements are now in admin_troubleshooting.html

        let currentBackupTaskId = null;
        let currentRestoreTaskId = null;
        let currentVerifyTaskId = null; // Added for verification tasks
        let currentDeleteTaskId = null; // Added for deletion tasks

        let currentPage = 1;
        const backupsPerPage = 5; // Or any other number you prefer
        let allBackups = [];


        socket.on('connect', () => {
            console.log('Socket.IO connected for backup/restore logs.');
        });
        socket.on('disconnect', (reason) => {
            console.warn('Socket.IO disconnected:', reason);
        });
        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });

        function appendLog(logAreaId, message, detail, type = 'info') {
            const logArea = document.getElementById(logAreaId);
            if (!logArea) return;
            logArea.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + type; // e.g. log-info, log-error
            logEntry.textContent = `[${timestamp}] ${message}${detail ? ' - ' + detail : ''}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight; // Auto-scroll to bottom
        }

        function keepAlive() {
            fetch('/ping', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    console.warn('Keep-alive ping failed. Status:', response.status);
                    appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                              'Session keep-alive ping failed.', `Status: ${response.status}`, 'error');
                }
            })
            .catch(error => {
                console.error('Keep-alive ping error:', error);
                appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                          'Session keep-alive ping error.', error.message, 'error');
            });
        }
        setInterval(keepAlive, 4 * 60 * 1000); // 4 minutes

        // SocketIO listeners
        socket.on('backup_progress', function(data) {
            console.log('Backup progress event:', data);
            if (data.task_id !== currentBackupTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';

            appendLog('backup-log-area', data.status, data.detail, messageType);
            backupStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            backupStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;


            if (data.status === "Backup completed with overall success: True" || data.status.startsWith("Backup completed with overall success: False")) {
                enablePageInteractions();
                console.log('Final backup status displayed:', backupStatusMessageEl.textContent);
                currentBackupTaskId = null; // Clear task ID after processing final message
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) { // also check data.detail for success for loadAvailableBackups
                    loadAvailableBackups(); // This might re-trigger enable/disable if it has its own calls, be mindful
                }
            }
        });

        socket.on('restore_progress', function(data) {
            console.log('Restore progress event:', data);
            if (data.task_id !== currentRestoreTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';

            appendLog('restore-log-area', data.status, data.detail, messageType);
            restoreStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;

            const lowerStatus = data.status.toLowerCase();
            if (lowerStatus.includes("fully completed") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerStatus.includes("critical error") || lowerStatus.includes("finished")) {
                enablePageInteractions();
                console.log('Final restore status displayed:', restoreStatusMessageEl.textContent);
                currentRestoreTaskId = null; // Clear task ID after processing final message
            }

            // If actions are present in the data (from a dry run), display them
            if (data.actions && Array.isArray(data.actions)) {
                appendLog('restore-log-area', "DRY RUN ACTIONS:", '', 'info');
                if (data.actions.length === 0) {
                    appendLog('restore-log-area', "  No actions would be performed.", '', 'info');
                } else {
                    data.actions.forEach(action => {
                        appendLog('restore-log-area', `  - ${action}`, '', 'info');
                    });
                }
            }
            // If a summary is present (from selective restore), display it
            if (data.summary && Array.isArray(data.summary)) {
                appendLog('restore-log-area', "SELECTIVE RESTORE SUMMARY:", '', 'info');
                if (data.summary.length === 0) {
                    appendLog('restore-log-area', "  No component actions reported.", '', 'info');
                } else {
                    data.summary.forEach(action_summary => {
                        appendLog('restore-log-area', `  - ${action_summary}`, '', 'info');
                    });
                }
            }
        });

        // One Click Backup
        backupButton.addEventListener('click', function () {
            currentBackupTaskId = null;
            backupLogAreaEl.innerHTML = '';
            backupLogAreaEl.style.display = 'block'; // Show log area
            restoreLogAreaEl.style.display = 'none'; // Hide other log area
            appendLog('backup-log-area', "{{ _('Initiating backup request...') }}", '', 'info');
            disablePageInteractions();

            backupStatusMessageEl.textContent = "{{ _('Initiating backup...') }}";
            backupStatusMessageEl.className = 'alert alert-info';

            fetch('/api/admin/one_click_backup', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                currentBackupTaskId = data.task_id; // Store task_id
                const messageType = data.success ? 'info' : 'error';
                appendLog('backup-log-area', data.message || (data.success ? "{{ _('Backup process started on server.') }}" : "{{ _('Failed to start backup process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                backupStatusMessageEl.textContent = data.message;
                backupStatusMessageEl.className = `alert alert-${messageType}`;

                if (!data.success) {
                    enablePageInteractions();
                }
            })
            .catch(error => {
                console.error('Backup error:', error);
                appendLog('backup-log-area', "{{ _('Backup request failed:') }}", error.message, 'error');
                backupStatusMessageEl.textContent = "{{ _('Backup request failed:') }} " + error.toString();
                backupStatusMessageEl.className = 'alert alert-danger';
                enablePageInteractions();
            });
        });

        // Selective Restore Form Submission
        selectiveRestoreForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const backupTimestamp = this.dataset.timestamp;
            const selectedComponents = Array.from(document.querySelectorAll('#selective-restore-form input[name="components"]:checked'))
                                         .map(cb => cb.value);

            if (selectedComponents.length === 0) {
                selectiveRestoreModalStatusEl.textContent = "{{ _('Please select at least one component to restore.') }}";
                selectiveRestoreModalStatusEl.className = 'alert alert-warning';
                return;
            }

            currentRestoreTaskId = null; // Reset task ID
            restoreLogAreaEl.innerHTML = ''; // Clear main log area
            restoreLogAreaEl.style.display = 'block';
            backupLogAreaEl.style.display = 'none';
            appendLog('restore-log-area', `{{ _('Initiating selective restore for') }} ${backupTimestamp}...`, `Components: ${selectedComponents.join(', ')}`, 'info');

            disablePageInteractions();


            restoreStatusMessageEl.textContent = `{{ _('Initiating selective restore...') }}`;
            restoreStatusMessageEl.className = 'alert alert-info';
            selectiveRestoreModalStatusEl.textContent = "{{ _('Processing...') }}";
            selectiveRestoreModalStatusEl.className = 'alert alert-info';


            fetch('/api/admin/selective_restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    backup_timestamp: backupTimestamp,
                    components: selectedComponents
                })
            })
            .then(response => response.json())
            .then(data => {
                currentRestoreTaskId = data.task_id;
                const messageType = data.success ? 'info' : 'error';

                appendLog('restore-log-area', data.message || (data.success ? `{{ _('Selective restore for ${backupTimestamp} process started.') }}` : `{{ _('Failed to start selective restore for ${backupTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                restoreStatusMessageEl.textContent = data.message; // Update main page status
                restoreStatusMessageEl.className = `alert alert-${messageType}`;

                selectiveRestoreModalStatusEl.textContent = data.message; // Update modal status
                selectiveRestoreModalStatusEl.className = `alert alert-${messageType}`;


                if (data.success) {
                    selectiveRestoreModal.style.display = 'none'; // Close modal on successful initiation
                } else {
                    enablePageInteractions();
                }
            })
            .catch(error => {
                console.error('Selective restore error:', error);
                const errorMsg = `{{ _('Selective restore request for ${backupTimestamp} failed:') }} ${error.toString()}`;
                appendLog('restore-log-area', errorMsg, '', 'error');
                restoreStatusMessageEl.textContent = errorMsg;
                restoreStatusMessageEl.className = 'alert alert-danger';
                selectiveRestoreModalStatusEl.textContent = errorMsg;
                selectiveRestoreModalStatusEl.className = 'alert alert-danger';
                enablePageInteractions();
            });
        });

        function loadAvailableBackups() {
            // It's possible this is called when other operations are finishing.
            // To prevent premature re-enabling or conflicting states, disable first.
            disablePageInteractions();
            restoreStatusMessageEl.textContent = "{{ _('Fetching available backups...') }}";
            restoreStatusMessageEl.className = 'alert alert-info';
            availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Loading...") }}</td></tr>';
            document.getElementById('backup-pagination-nav').style.display = 'none'; // Hide pagination during load

            fetch('/api/admin/list_backups', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.backups) {
                    allBackups = data.backups; // Store all fetched backups
                    currentPage = 1; // Reset to first page
                    displayBackupsPage(); // Display the first page
                    if (allBackups.length > 0) {
                        restoreStatusMessageEl.textContent = "{{ _('Available backups loaded.') }}";
                        restoreStatusMessageEl.className = 'alert alert-success';
                    } else {
                        restoreStatusMessageEl.textContent = "{{ _('No backups found.') }}";
                        restoreStatusMessageEl.className = 'alert alert-info';
                    }
                } else {
                    allBackups = [];
                    availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Failed to load backups.") }}</td></tr>';
                    restoreStatusMessageEl.textContent = "{{ _('Failed to load backups:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    document.getElementById('backup-pagination-nav').style.display = 'none';
                }
            })
            .catch(error => {
                allBackups = [];
                console.error('List backups error:', error);
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Error loading backups.") }}</td></tr>';
                restoreStatusMessageEl.textContent = "{{ _('Error fetching backups:') }} " + error.toString();
                restoreStatusMessageEl.className = 'alert alert-danger';
                document.getElementById('backup-pagination-nav').style.display = 'none';
            })
            .finally(() => {
                enablePageInteractions(); // Re-enable after loading, regardless of outcome
            });
        }

        function displayBackupsPage() {
            availableBackupsTbody.innerHTML = '';
            const paginationNav = document.getElementById('backup-pagination-nav');
            const pageInfoEl = document.getElementById('backup-page-info');
            const prevPageBtn = document.getElementById('backup-prev-page');
            const nextPageBtn = document.getElementById('backup-next-page');

            if (allBackups.length === 0) {
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("No backups available.") }}</td></tr>';
                paginationNav.style.display = 'none';
                return;
            }

            const startIndex = (currentPage - 1) * backupsPerPage;
            const endIndex = startIndex + backupsPerPage;
            const pageBackups = allBackups.slice(startIndex, endIndex);

            pageBackups.forEach(timestamp => {
                const row = availableBackupsTbody.insertRow();
                const cellTimestamp = row.insertCell();
                const cellAction = row.insertCell();
                let displayTimestamp = timestamp;
                try {
                    const year = timestamp.substring(0,4); const month = timestamp.substring(4,6);
                    const day = timestamp.substring(6,8); const hour = timestamp.substring(9,11);
                    const minute = timestamp.substring(11,13); const second = timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                cellTimestamp.textContent = displayTimestamp;
                const restoreBtn = document.createElement('button');
                restoreBtn.textContent = "{{ _('Restore') }}";
                restoreBtn.className = 'btn btn-sm btn-warning restore-btn me-2';
                restoreBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(restoreBtn);

                const dryRunBtn = document.createElement('button');
                dryRunBtn.textContent = "{{ _('Dry Run') }}";
                dryRunBtn.className = 'btn btn-sm btn-info restore-dry-run-btn me-2';
                dryRunBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(dryRunBtn);

                // const verifyBtn = document.createElement('button'); // Original simple button
                // verifyBtn.textContent = "{{ _('Verify') }}";
                // verifyBtn.className = 'btn btn-sm btn-secondary verify-backup-btn me-2';
                // verifyBtn.setAttribute('data-timestamp', timestamp);
                // cellAction.appendChild(verifyBtn);

                // New Verify Form for Full Backups
                const verifyForm = document.createElement('form');
                verifyForm.method = 'POST';
                // IMPORTANT: Constructing URL for Flask's url_for in JS is tricky.
                // This will be a literal string. The route needs to match this.
                verifyForm.action = `/admin/verify_full_backup/${timestamp}`;
                verifyForm.style.display = 'inline';
                verifyForm.style.marginLeft = '5px';

                const csrfInputVerify = document.createElement('input');
                csrfInputVerify.type = 'hidden';
                csrfInputVerify.name = 'csrf_token';
                csrfInputVerify.value = csrfToken; // Assumes csrfToken is available in this scope
                verifyForm.appendChild(csrfInputVerify);

                const verifySubmitBtn = document.createElement('button');
                verifySubmitBtn.type = 'submit';
                verifySubmitBtn.className = 'btn btn-info btn-sm';
                verifySubmitBtn.innerHTML = '<i class="fas fa-check-circle"></i> {{ _("Verify") }}'; // Use innerHTML for icon
                // No onclick confirmation for verify, as it's not directly destructive.
                verifyForm.appendChild(verifySubmitBtn);
                cellAction.appendChild(verifyForm);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = "{{ _('Delete') }}";
                deleteBtn.className = 'btn btn-sm btn-danger delete-backup-btn'; // Removed ms-2, as verifyBtn now has me-2
                deleteBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(deleteBtn);
            });

            // Update pagination controls
            const totalPages = Math.ceil(allBackups.length / backupsPerPage);
            if (totalPages > 1) {
                paginationNav.style.display = 'block';
                pageInfoEl.textContent = `{{ _('Page') }} ${currentPage} {{ _('of') }} ${totalPages}`;
                prevPageBtn.classList.toggle('disabled', currentPage === 1);
                nextPageBtn.classList.toggle('disabled', endIndex >= allBackups.length);
            } else {
                paginationNav.style.display = 'none';
            }
        }

        listBackupsButton.addEventListener('click', loadAvailableBackups);

        document.getElementById('backup-prev-page').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                displayBackupsPage();
            }
        });

        document.getElementById('backup-next-page').addEventListener('click', function(e) {
            e.preventDefault();
            if ((currentPage * backupsPerPage) < allBackups.length) {
                currentPage++;
                displayBackupsPage();
            }
        });

        availableBackupsTable.addEventListener('click', function (event) {
            const targetButton = event.target;
            let isRestore = targetButton.classList.contains('restore-btn');
            let isDryRun = targetButton.classList.contains('restore-dry-run-btn');
            let isVerify = targetButton.classList.contains('verify-backup-btn');
            let isDelete = targetButton.classList.contains('delete-backup-btn');

            if (isVerify) {
                const timestampToVerify = targetButton.getAttribute('data-timestamp');
                
                currentVerifyTaskId = null; 
                currentDeleteTaskId = null; 
                currentRestoreTaskId = null;
                currentBackupTaskId = null;

                restoreLogAreaEl.innerHTML = ''; 
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `VERIFY: Initiating for ${timestampToVerify}...`, '', 'info');

                disablePageInteractions();
                
                restoreStatusMessageEl.textContent = `{{ _('Initiating verification for') }} ${timestampToVerify}...`;
                restoreStatusMessageEl.className = 'alert alert-info';

                fetch('/api/admin/verify_backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ backup_timestamp: timestampToVerify })
                })
                .then(response => response.json())
                .then(data => {
                    currentVerifyTaskId = data.task_id; 
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', `VERIFY: ${data.message || (data.success ? '{{ _("Verification process started.") }}' : '{{ _("Failed to start verification.") }}')}`, `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message; 
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) { 
                        enablePageInteractions();
                        currentVerifyTaskId = null; 
                    }
                })
                .catch(error => {
                    console.error('Verify backup error:', error);
                    const errorMsg = `{{ _('Verification request for ${timestampToVerify} failed:') }} ${error.toString()}`;
                    appendLog('restore-log-area', errorMsg, '', 'error');
                    restoreStatusMessageEl.textContent = errorMsg;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    enablePageInteractions();
                    currentVerifyTaskId = null; 
                });

            } else if (isDelete) {
                const backup_timestamp = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = backup_timestamp;
                 try { // Format for display
                    const year = backup_timestamp.substring(0,4); const month = backup_timestamp.substring(4,6);
                    const day = backup_timestamp.substring(6,8); const hour = backup_timestamp.substring(9,11);
                    const minute = backup_timestamp.substring(11,13); const second = backup_timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                if (!confirm("{{ _('Are you sure you want to delete backup') }} '" + displayTimestamp + "'? {{ _('This action cannot be undone.') }}")) {
                    return;
                }

                currentDeleteTaskId = null;
                currentRestoreTaskId = null; // Clear other task IDs
                currentVerifyTaskId = null;
                currentBackupTaskId = null;

                restoreLogAreaEl.innerHTML = '';
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', "{{ _('Initiating delete request for') }} " + displayTimestamp + "...", '', 'info');

                disablePageInteractions();

                restoreStatusMessageEl.textContent = "{{ _('Deleting backup...') }}";
                restoreStatusMessageEl.className = 'alert alert-info';

                fetch('/api/admin/delete_backup/' + backup_timestamp, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    currentDeleteTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Deletion process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start deletion for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message;
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) { // If API call itself fails to initiate
                         enablePageInteractions();
                         currentDeleteTaskId = null;
                    }
                    // Socket listener 'backup_delete_progress' will handle final re-enable and list refresh
                })
                .catch(error => {
                    console.error('Delete backup error:', error);
                    appendLog('restore-log-area', `{{ _('Delete request for ${displayTimestamp} failed:') }}`, error.message, 'error');
                    restoreStatusMessageEl.textContent = `{{ _('Delete request for ${displayTimestamp} failed:') }} ${error.toString()}`;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    enablePageInteractions();
                    currentDeleteTaskId = null;
                });

            } else if (isRestore || isDryRun) { // Logic for Restore and Dry Run
                const timestampToProcess = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToProcess;
                try {
                    const year = timestampToProcess.substring(0,4); const month = timestampToProcess.substring(4,6);
                    const day = timestampToProcess.substring(6,8); const hour = timestampToProcess.substring(9,11);
                    const minute = timestampToProcess.substring(11,13); const second = timestampToProcess.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                currentRestoreTaskId = null; // Reset restore task ID
                currentDeleteTaskId = null; // Clear other task IDs
                currentVerifyTaskId = null;
                currentBackupTaskId = null;


                let confirmationMessage = "";
                let endpoint = "";
                let actionVerb = "";

                if (isRestore) {
                    confirmationMessage = "{{ _('Are you sure you want to restore from backup') }} " + displayTimestamp + "? {{ _('This will overwrite current data and may require an application restart.') }}";
                    endpoint = '/api/admin/one_click_restore';
                    actionVerb = "{{ _('restore from') }}";
                } else { // isDryRun
                    confirmationMessage = "{{ _('Are you sure you want to perform a dry run for restoring from backup') }} " + displayTimestamp + "?";
                    endpoint = `/api/admin/restore_dry_run/${timestampToProcess}`; // Timestamp in URL for dry run
                    actionVerb = "{{ _('dry run restore from') }}";
                }

                if (!confirm(confirmationMessage)) {
                    return;
                }

                currentRestoreTaskId = null; // This was already here, ensure it's the active task type
                restoreLogAreaEl.innerHTML = '';
                restoreLogAreaEl.style.display = 'block';
                backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `{{ _('Initiating') }} ${actionVerb} ${displayTimestamp}...`, '', 'info');

                disablePageInteractions();
                restoreStatusMessageEl.textContent = `{{ _('Initiating') }} ${actionVerb} ${displayTimestamp}... {{ _('This may take a while. Please do not navigate away.') }}`;
                restoreStatusMessageEl.className = 'alert alert-info';

                let fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                };
                // For actual restore, timestamp is in body. For dry run, it's in URL.
                if (isRestore) {
                    fetchOptions.body = JSON.stringify({ backup_timestamp: timestampToProcess });
                }


                fetch(endpoint, fetchOptions)
                .then(response => response.json())
                .then(data => {
                    currentRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start process for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType);
                    restoreStatusMessageEl.textContent = data.message;
                    restoreStatusMessageEl.className = `alert alert-${messageType}`;

                    if (!data.success) {
                        enablePageInteractions();
                    }
                    // If it's a dry run and successful, display actions from HTTP response for immediate feedback
                    if (isDryRun && data.success && data.actions && Array.isArray(data.actions)) {
                        appendLog('restore-log-area', "DRY RUN ACTIONS (from HTTP response):", '', 'info');
                        if (data.actions.length === 0) {
                            appendLog('restore-log-area', "  No actions would be performed.", '', 'info');
                        } else {
                            data.actions.forEach(action => {
                                appendLog('restore-log-area', `  - ${action}`, '', 'info');
                            });
                        }
                    }
                    // The socket listener will also receive actions with the final success message,
                    // which might update or confirm this list.
                })
                .catch(error => {
                    console.error(`${actionVerb} error:`, error);
                    appendLog('restore-log-area', `{{ _('Request for ${actionVerb} ${displayTimestamp} failed:') }}`, error.message, 'error');
                    restoreStatusMessageEl.textContent = `{{ _('Request for ${actionVerb} ${displayTimestamp} failed:') }} ${error.toString()}`;
                    restoreStatusMessageEl.className = 'alert alert-danger';
                    enablePageInteractions();
                });
            } else if (targetButton.classList.contains('restore-btn')) { // This is now the entry point for Selective Restore Modal
                // For opening the modal, we don't disable all page interactions yet.
                // That will happen when "Proceed with Selected Restore" is clicked.
                const timestampToRestore = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToRestore;
                 try { // Format for display
                    const year = timestampToRestore.substring(0,4); const month = timestampToRestore.substring(4,6);
                    const day = timestampToRestore.substring(6,8); const hour = timestampToRestore.substring(9,11);
                    const minute = timestampToRestore.substring(11,13); const second = timestampToRestore.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                modalBackupTimestampEl.textContent = displayTimestamp;
                selectiveRestoreForm.dataset.timestamp = timestampToRestore; // Store timestamp for form submission

                // Reset form: uncheck all individual, check 'ALL', clear status
                componentCheckboxes.forEach(cb => cb.checked = true);
                componentAllCheckbox.checked = true;
                selectiveRestoreModalStatusEl.textContent = '';
                selectiveRestoreModalStatusEl.className = 'status-message mt-2';

                selectiveRestoreModal.style.display = 'block';
            }
        });

        // Modal Close Button
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                selectiveRestoreModal.style.display = 'none';
            });
        }
        window.addEventListener('click', function(event) { // Close if clicked outside modal content
            if (event.target == selectiveRestoreModal) {
                selectiveRestoreModal.style.display = 'none';
            }
        });

        // "ALL COMPONENTS" checkbox logic
        componentAllCheckbox.addEventListener('change', function() {
            componentCheckboxes.forEach(cb => cb.checked = this.checked);
        });

        componentCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) {
                    componentAllCheckbox.checked = false;
                } else {
                    // Check if all individual components are checked
                    const allChecked = Array.from(componentCheckboxes).every(indCb => indCb.checked);
                    if (allChecked) {
                        componentAllCheckbox.checked = true;
                    }
                }
            });
        });


        loadAvailableBackups(); // Initial load

        // --- Scheduled Backups Logic ---
        // SocketIO handler for backup verification progress
        socket.on('verify_backup_progress', function(data) {
            console.log('Verify backup progress event:', data);
            if (data.task_id !== currentVerifyTaskId) return;

            let messageType = 'info';
            // Determine message type based on content
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.results && data.results.status && data.results.status !== 'verified_present' && data.results.status !== 'pending') messageType = 'error';
            else if (data.results && data.results.status && data.results.status === 'verified_present') messageType = 'success';


            appendLog('restore-log-area', `VERIFY: ${data.status}`, data.detail, messageType);
            // Update main status message element as well
            restoreStatusMessageEl.textContent = `VERIFY: ${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType}`;

            if (data.results) { // This is the final message with all results
                appendLog('restore-log-area', `VERIFY: Overall Status: ${data.results.status}`, '', data.results.status === 'verified_present' ? 'success' : 'error');
                if (data.results.checks && data.results.checks.length > 0) {
                    appendLog('restore-log-area', 'VERIFY: Detailed Checks:', '', 'info');
                    data.results.checks.forEach(check => {
                        let checkLogType = 'info';
                        if (check.status !== 'found' && check.status !== 'found_count_match') {
                            checkLogType = 'error';
                        }
                        let detailMsg = `- Item: ${check.item} (${check.type || 'N/A'}) - Status: ${check.status}`;
                        if (check.hasOwnProperty('expected_count')) {
                            detailMsg += `, Expected: ${check.expected_count}, Actual: ${check.actual_count}`;
                        }
                        appendLog('restore-log-area', detailMsg, '', checkLogType);
                    });
                }
                if (data.results.errors && data.results.errors.length > 0) {
                    appendLog('restore-log-area', 'VERIFY: Errors Found:', '', 'error');
                    data.results.errors.forEach(err => {
                        appendLog('restore-log-area', `  - ${err}`, '', 'error');
                    });
                }
                enablePageInteractions();
                currentVerifyTaskId = null;
            } else if (data.status && (data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("missing") || data.status.toLowerCase().includes("critical") )) {
                enablePageInteractions();
                currentVerifyTaskId = null;
            }
        });

        // Listener for Backup Deletion Progress
        socket.on('backup_delete_progress', function(data) {
            console.log('Backup delete progress event:', data);
            if (data.task_id !== currentDeleteTaskId) return;

            let messageType = 'info';
            if (data.detail && data.detail.toUpperCase().includes('ERROR')) messageType = 'error';
            else if (data.detail && data.detail.toUpperCase().includes('SUCCESS')) messageType = 'success';
            else if (data.status && data.status.toLowerCase().includes('failed')) messageType = 'error';


            appendLog('restore-log-area', data.status, data.detail, messageType);
            restoreStatusMessageEl.textContent = `${data.status}${data.detail ? ' ('+data.detail+')':''}`;
            restoreStatusMessageEl.className = `alert alert-${messageType === 'error' ? 'danger' : (messageType === 'success' ? 'success' : 'info')}`;

            const lowerStatus = data.status.toLowerCase();
            const lowerDetail = data.detail ? data.detail.toLowerCase() : "";

            if (lowerStatus.includes("finished") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerDetail.includes("success") || lowerDetail.includes("failure") || lowerDetail.includes("critical_error")) {
                enablePageInteractions();
                console.log('Final delete status displayed:', restoreStatusMessageEl.textContent);
                currentDeleteTaskId = null;
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) {
                    loadAvailableBackups(); // Refresh list on successful deletion
                }
            }
        });


        function toggleDayOfWeekVisibility() { /* ... existing ... */
            if (scheduleTypeSelect.value === 'weekly') {
                dayOfWeekGroup.style.display = 'block';
            } else {
                dayOfWeekGroup.style.display = 'none';
            }
        }
        scheduleTypeSelect.addEventListener('change', toggleDayOfWeekVisibility);

        function loadBackupSchedule() {
            disablePageInteractions(); // Disable while loading
            scheduleStatusMessage.textContent = "{{ _('Loading schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';
            fetch('/api/admin/backup_schedule', {
                method: 'GET',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message && !data.is_enabled && !data.schedule_type) {
                    scheduleStatusMessage.textContent = "{{ _('Could not load schedule:') }} " + data.message;
                    scheduleStatusMessage.className = 'alert alert-danger';
                    return;
                }
                scheduleEnabledCheckbox.checked = data.is_enabled;
                scheduleTypeSelect.value = data.schedule_type || 'daily';
                if (data.day_of_week !== null && data.day_of_week !== undefined) {
                    scheduleDayOfWeekSelect.value = data.day_of_week;
                } else {
                    scheduleDayOfWeekSelect.value = "0";
                }
                if (data.time_of_day) {
                    scheduleTimeOfDayInput.value = data.time_of_day.substring(0, 5);
                } else {
                    scheduleTimeOfDayInput.value = "02:00";
                }
                toggleDayOfWeekVisibility();
                scheduleStatusMessage.textContent = "{{ _('Schedule loaded.') }}";
                scheduleStatusMessage.className = 'alert alert-success';
            })
            .catch(error => {
                console.error('Load schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error loading schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            })
            .finally(() => {
                enablePageInteractions(); // Re-enable after loading
            });
        }
        scheduleForm.addEventListener('submit', function(event) {
            event.preventDefault();
            disablePageInteractions(); // Disable during save
            // saveScheduleButton.disabled = true; // This will be handled by disablePageInteractions
            scheduleStatusMessage.textContent = "{{ _('Saving schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';
            const payload = {
                is_enabled: scheduleEnabledCheckbox.checked,
                schedule_type: scheduleTypeSelect.value,
                time_of_day: scheduleTimeOfDayInput.value
            };
            if (payload.schedule_type === 'weekly') {
                payload.day_of_week = parseInt(scheduleDayOfWeekSelect.value, 10);
            } else {
                payload.day_of_week = null;
            }
            fetch('/api/admin/backup_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    scheduleStatusMessage.textContent = "{{ _('Schedule saved successfully.') }} " + (data.message || "");
                    scheduleStatusMessage.className = 'alert alert-success';
                } else {
                    scheduleStatusMessage.textContent = "{{ _('Failed to save schedule:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    scheduleStatusMessage.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('Save schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error saving schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            })
            .finally(() => {
                enablePageInteractions(); // Re-enable after save attempt
                // saveScheduleButton.disabled = false; // Handled by enablePageInteractions
            });
        });
        loadBackupSchedule(); // Initial Load

        // --- Troubleshooting Tools Event Listeners (Moved to admin_troubleshooting.html) ---
    });
</script>
{% endblock %}

[end of templates/admin_backup_restore.html]
