{% extends "base.html" %}

{% block title %}{{ _('Admin - Backup & Restore') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ _('Admin - Backup & Restore') }}</h1>
    <hr>

    <section id="backup-section" class="mb-5">
        <h2>{{ _('One Click Backup') }}</h2>
        <p>{{ _('Perform a full backup of the database, map configurations, and uploaded media files.') }}</p>
        <button id="one-click-backup-btn" class="btn btn-primary">{{ _('Perform Full Backup Now') }}</button>
        <div id="backup-status-message" class="mt-2"></div>
    </section>

    <hr>

    <section id="restore-section">
        <h2>{{ _('One Click Restore') }}</h2>
        <p>{{ _('Restore the system from a previously created full backup. This will overwrite current data.') }}</p>
        <button id="list-backups-btn" class="btn btn-info mb-3">{{ _('Refresh Available Backups') }}</button>
        <div id="restore-status-message" class="mt-2 mb-3"></div>

        <table id="available-backups-table" class="table table-striped">
            <thead>
                <tr>
                    <th>{{ _('Backup Timestamp (UTC)') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody id="available-backups-tbody">
                <!-- Backup items will be loaded here by JavaScript -->
            </tbody>
        </table>
    </section>

    <hr>
    <h2>{{ _('Scheduled Full Backups') }}</h2>
    <div id="schedule-status-message" class="status-message my-2" role="alert"></div>
    <form id="backup-schedule-form" class="mb-4">
        <div class="form-group mb-2">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="schedule-enabled" name="is_enabled">
                <label class="form-check-label" for="schedule-enabled">{{ _('Enable Scheduled Backups') }}</label>
            </div>
        </div>
        <div class="form-group mb-2">
            <label for="schedule-type">{{ _('Schedule Type') }}</label>
            <select id="schedule-type" name="schedule_type" class="form-control form-select">
                <option value="daily">{{ _('Daily') }}</option>
                <option value="weekly">{{ _('Weekly') }}</option>
            </select>
        </div>
        <div class="form-group mb-2" id="day-of-week-group" style="display: none;"> <!-- Hidden by default -->
            <label for="schedule-day-of-week">{{ _('Day of Week') }}</label>
            <select id="schedule-day-of-week" name="day_of_week" class="form-control form-select">
                <option value="0">{{ _('Monday') }}</option>
                <option value="1">{{ _('Tuesday') }}</option>
                <option value="2">{{ _('Wednesday') }}</option>
                <option value="3">{{ _('Thursday') }}</option>
                <option value="4">{{ _('Friday') }}</option>
                <option value="5">{{ _('Saturday') }}</option>
                <option value="6">{{ _('Sunday') }}</option>
            </select>
        </div>
        <div class="form-group mb-2">
            <label for="schedule-time-of-day">{{ _('Time of Day (UTC)') }}</label>
            <input type="time" id="schedule-time-of-day" name="time_of_day" class="form-control" required>
        </div>
        <button type="submit" id="save-schedule-btn" class="btn btn-success">{{ _('Save Schedule') }}</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const backupButton = document.getElementById('one-click-backup-btn');
        const backupStatusMessage = document.getElementById('backup-status-message');

        const listBackupsButton = document.getElementById('list-backups-btn');
        const restoreStatusMessage = document.getElementById('restore-status-message');
        const availableBackupsTbody = document.getElementById('available-backups-tbody');
        const availableBackupsTable = document.getElementById('available-backups-table');

        // Schedule form elements
        const scheduleForm = document.getElementById('backup-schedule-form');
        const scheduleEnabledCheckbox = document.getElementById('schedule-enabled');
        const scheduleTypeSelect = document.getElementById('schedule-type');
        const dayOfWeekGroup = document.getElementById('day-of-week-group');
        const scheduleDayOfWeekSelect = document.getElementById('schedule-day-of-week');
        const scheduleTimeOfDayInput = document.getElementById('schedule-time-of-day');
        const saveScheduleButton = document.getElementById('save-schedule-btn');
        const scheduleStatusMessage = document.getElementById('schedule-status-message');


        // One Click Backup
        backupButton.addEventListener('click', function () {
            backupButton.disabled = true;
            backupStatusMessage.textContent = "{{ _('Starting backup...') }}";
            backupStatusMessage.className = 'alert alert-info';

            fetch('/api/admin/one_click_backup', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    backupStatusMessage.textContent = "{{ _('Backup successful:') }} " + data.message;
                    backupStatusMessage.className = 'alert alert-success';
                    loadAvailableBackups(); // Refresh the list of backups
                } else {
                    backupStatusMessage.textContent = "{{ _('Backup failed:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    backupStatusMessage.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('Backup error:', error);
                backupStatusMessage.textContent = "{{ _('Backup request failed:') }} " + error.toString();
                backupStatusMessage.className = 'alert alert-danger';
            })
            .finally(() => {
                backupButton.disabled = false;
            });
        });

        // Function to load available backups
        function loadAvailableBackups() {
            restoreStatusMessage.textContent = "{{ _('Fetching available backups...') }}";
            restoreStatusMessage.className = 'alert alert-info';
            availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Loading...") }}</td></tr>';

            fetch('/api/admin/list_backups', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                    // CSRF not typically needed for GET, but include if server expects it for all API routes
                }
            })
            .then(response => response.json())
            .then(data => {
                availableBackupsTbody.innerHTML = ''; // Clear loading or old rows
                if (data.success && data.backups && data.backups.length > 0) {
                    data.backups.forEach(timestamp => {
                        const row = availableBackupsTbody.insertRow();
                        const cellTimestamp = row.insertCell();
                        const cellAction = row.insertCell();

                        // Format timestamp for better readability if needed
                        // Assuming timestamp is YYYYMMDD_HHMMSS
                        let displayTimestamp = timestamp;
                        try {
                            const year = timestamp.substring(0,4);
                            const month = timestamp.substring(4,6);
                            const day = timestamp.substring(6,8);
                            const hour = timestamp.substring(9,11);
                            const minute = timestamp.substring(11,13);
                            const second = timestamp.substring(13,15);
                            displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                        } catch (e) { /* ignore, use raw timestamp */ }

                        cellTimestamp.textContent = displayTimestamp;

                        const restoreButton = document.createElement('button');
                        restoreButton.textContent = "{{ _('Restore') }}";
                        restoreButton.className = 'btn btn-sm btn-warning restore-btn';
                        restoreButton.setAttribute('data-timestamp', timestamp);
                        cellAction.appendChild(restoreButton);
                    });
                    restoreStatusMessage.textContent = "{{ _('Available backups loaded.') }}";
                    restoreStatusMessage.className = 'alert alert-success';
                } else if (data.success && data.backups && data.backups.length === 0) {
                    availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("No backups available.") }}</td></tr>';
                    restoreStatusMessage.textContent = "{{ _('No backups found.') }}";
                    restoreStatusMessage.className = 'alert alert-info';
                } else {
                    availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Failed to load backups.") }}</td></tr>';
                    restoreStatusMessage.textContent = "{{ _('Failed to load backups:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    restoreStatusMessage.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('List backups error:', error);
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Error loading backups.") }}</td></tr>';
                restoreStatusMessage.textContent = "{{ _('Error fetching backups:') }} " + error.toString();
                restoreStatusMessage.className = 'alert alert-danger';
            });
        }

        // Event listener for "Refresh Available Backups"
        listBackupsButton.addEventListener('click', loadAvailableBackups);

        // Delegated event listener for "Restore" buttons
        availableBackupsTable.addEventListener('click', function (event) {
            if (event.target.classList.contains('restore-btn')) {
                const timestamp = event.target.getAttribute('data-timestamp');
                const rawTimestamp = timestamp; // For messages
                 let displayTimestamp = timestamp;
                 try {
                    const year = timestamp.substring(0,4);
                    const month = timestamp.substring(4,6);
                    const day = timestamp.substring(6,8);
                    const hour = timestamp.substring(9,11);
                    const minute = timestamp.substring(11,13);
                    const second = timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore, use raw timestamp for confirm */ }


                if (!confirm("{{ _('Are you sure you want to restore from backup') }} " + displayTimestamp + "? {{ _('This will overwrite current data and may require an application restart.') }}")) {
                    return;
                }

                // Disable all restore buttons
                document.querySelectorAll('.restore-btn').forEach(btn => btn.disabled = true);
                restoreStatusMessage.textContent = `{{ _('Starting restore from') }} ${displayTimestamp}... {{ _('This may take a while. Please do not navigate away.') }}`;
                restoreStatusMessage.className = 'alert alert-info';

                fetch('/api/admin/one_click_restore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ backup_timestamp: rawTimestamp })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        restoreStatusMessage.textContent = `{{ _('Restore from ${displayTimestamp} successful:') }} ${data.message} {{ _('It is highly recommended to restart the application now.') }}`;
                        restoreStatusMessage.className = 'alert alert-success';
                    } else {
                        restoreStatusMessage.textContent = `{{ _('Restore from ${displayTimestamp} failed:') }} ${data.message || '{{ _("Unknown error.") }}'}`;
                        restoreStatusMessage.className = 'alert alert-danger';
                    }
                })
                .catch(error => {
                    console.error('Restore error:', error);
                    restoreStatusMessage.textContent = `{{ _('Restore request for ${displayTimestamp} failed:') }} ${error.toString()}`;
                    restoreStatusMessage.className = 'alert alert-danger';
                })
                .finally(() => {
                    // Re-enable buttons after operation (or user can refresh)
                    document.querySelectorAll('.restore-btn').forEach(btn => btn.disabled = false);
                    // Optionally, refresh backup list automatically
                    // loadAvailableBackups();
                });
            }
        });

        // Initial load of backups
        loadAvailableBackups();

        // --- Scheduled Backups Logic ---

        function toggleDayOfWeekVisibility() {
            if (scheduleTypeSelect.value === 'weekly') {
                dayOfWeekGroup.style.display = 'block';
            } else {
                dayOfWeekGroup.style.display = 'none';
            }
        }

        scheduleTypeSelect.addEventListener('change', toggleDayOfWeekVisibility);

        function loadBackupSchedule() {
            scheduleStatusMessage.textContent = "{{ _('Loading schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';

            fetch('/api/admin/backup_schedule', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': csrfToken // Include CSRF if needed for GET by your setup
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message && !data.is_enabled && !data.schedule_type) { // Heuristic for error or uninitialized
                    scheduleStatusMessage.textContent = "{{ _('Could not load schedule:') }} " + data.message;
                    scheduleStatusMessage.className = 'alert alert-danger';
                    return;
                }
                scheduleEnabledCheckbox.checked = data.is_enabled;
                scheduleTypeSelect.value = data.schedule_type || 'daily';
                if (data.day_of_week !== null && data.day_of_week !== undefined) {
                    scheduleDayOfWeekSelect.value = data.day_of_week;
                } else {
                    scheduleDayOfWeekSelect.value = "0"; // Default to Monday if not set
                }
                if (data.time_of_day) {
                     // Ensure time is in HH:MM format for the input[type=time]
                    scheduleTimeOfDayInput.value = data.time_of_day.substring(0, 5);
                } else {
                    scheduleTimeOfDayInput.value = "02:00"; // Default
                }
                toggleDayOfWeekVisibility(); // Update visibility based on loaded type
                scheduleStatusMessage.textContent = "{{ _('Schedule loaded.') }}";
                scheduleStatusMessage.className = 'alert alert-success';
            })
            .catch(error => {
                console.error('Load schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error loading schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            });
        }

        scheduleForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveScheduleButton.disabled = true;
            scheduleStatusMessage.textContent = "{{ _('Saving schedule...') }}";
            scheduleStatusMessage.className = 'alert alert-info';

            const payload = {
                is_enabled: scheduleEnabledCheckbox.checked,
                schedule_type: scheduleTypeSelect.value,
                time_of_day: scheduleTimeOfDayInput.value // Format HH:MM
            };

            if (payload.schedule_type === 'weekly') {
                payload.day_of_week = parseInt(scheduleDayOfWeekSelect.value, 10);
            } else {
                payload.day_of_week = null; // Explicitly set to null for daily
            }

            fetch('/api/admin/backup_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    scheduleStatusMessage.textContent = "{{ _('Schedule saved successfully.') }} " + (data.message || "");
                    scheduleStatusMessage.className = 'alert alert-success';
                } else {
                    scheduleStatusMessage.textContent = "{{ _('Failed to save schedule:') }} " + (data.message || "{{ _('Unknown error.') }}");
                    scheduleStatusMessage.className = 'alert alert-danger';
                }
            })
            .catch(error => {
                console.error('Save schedule error:', error);
                scheduleStatusMessage.textContent = "{{ _('Error saving schedule:') }} " + error.toString();
                scheduleStatusMessage.className = 'alert alert-danger';
            })
            .finally(() => {
                saveScheduleButton.disabled = false;
            });
        });

        // Initial load of schedule configuration
        loadBackupSchedule();

    });
</script>
{% endblock %}
