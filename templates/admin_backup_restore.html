{% extends "base.html" %}

{% block title %}{{ _('Admin - Backup & Restore') }}{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js" integrity="sha512-skuhu6jj+sQnhLq1Txsack8VfnIrX8wL+MTFilYlFFT/NuLJm7eya7zOROs39Jy5cjASMEWqxLzijRVmKhsqWQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
    .log-area {
        max-height: 200px;
        overflow-y: auto;
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
    }
    .log-entry {
        padding: 2px 0;
    }
    .log-error {
        color: red;
        font-weight: bold;
    }
    .log-success {
        color: green;
        font-weight: bold;
    }
    .log-info {
        color: #333;
    }
    /* Styles for DB Records View */
    .db-table-container {
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
    }
    .db-records-content pre {
        background-color: #f8f9fa; /* Light background for pre */
        padding: 10px;
        border-radius: 4px;
        max-height: 300px; /* Max height for individual record lists */
        overflow-y: auto;
    }
    /* Style for active (expanded) button */
    #view-db-records-output .btn.active { 
        background-color: #007bff;
        color: white;
    }
    /* Ensure tab panes have some padding when active */
    .tab-content > .tab-pane {
        padding-top: 1rem; /* Add padding to the top of tab panes */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ _('Admin - Backup & Restore') }}</h1>
    <hr>
    <p>{{ _('Current UTC Time:') }} <span id="utc-clock">Loading...</span></p>
    <hr>

    <!-- Main Tab Navigation -->
    <ul class="nav nav-tabs" id="backupRestoreTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="system-tab" data-bs-toggle="tab" data-bs-target="#systemTabPane" type="button" role="tab" aria-controls="systemTabPane" aria-selected="true">{{ _('System Backup & Restore') }}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="booking-data-tab" data-bs-toggle="tab" data-bs-target="#bookingDataTabPane" type="button" role="tab" aria-controls="bookingDataTabPane" aria-selected="false">{{ _('Booking Data Management') }}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settingsTabPane" type="button" role="tab" aria-controls="settingsTabPane" aria-selected="false">{{ _('General Settings') }}</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="backupRestoreTabContent">

        <!-- System Backup & Restore Tab Pane -->
        <div class="tab-pane fade show active" id="systemTabPane" role="tabpanel" aria-labelledby="system-tab">
            <!-- Full System Backup & Restore Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Full System Backup & Restore') }}</h2>
                </div>
                <div class="card-body">
                    <section id="backup-section" class="mb-4">
                        <h5>{{ _('One Click Backup') }}</h5>
                        <p>{{ _('Perform a full backup of the database, map configurations, and uploaded media files.') }}</p>
                        <button id="one-click-backup-btn" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> {{ _('Perform Full Backup Now') }}</button>
                        <div id="backup-status-message" class="mt-2"></div>
                    </section>
                    <hr>
                    <section id="restore-section">
                        <h5>{{ _('One Click Restore') }}</h5>
                        <p>{{ _('Restore the system from a previously created full backup. This will overwrite current data.') }}</p>
                        <button id="list-backups-btn" class="btn btn-info mb-3"><i class="fas fa-sync-alt"></i> {{ _('Refresh Available Backups') }}</button>
                        <div id="restore-status-message" class="mt-2 mb-3"></div>
                        <table id="available-backups-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>{{ _('Backup Timestamp (UTC)') }}</th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody id="available-backups-tbody"></tbody>
                        </table>
                        <nav aria-label="Backup pagination" id="backup-pagination-nav" style="display: none;">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" id="backup-prev-page"><a class="page-link" href="#">{{ _('Previous') }}</a></li>
                                <li class="page-item" id="backup-next-page"><a class="page-link" href="#">{{ _('Next') }}</a></li>
                            </ul>
                            <p class="text-center" id="backup-page-info"></p>
                        </nav>
                    </section>
                </div>
            </div>

            <!-- Scheduled Full System Backups Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Scheduled Full System Backups') }}</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_ui.save_full_backup_schedule_settings') }}" id="full-backup-schedule-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group mb-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="full_backup_enabled" name="full_backup_enabled" value="true" {% if full_backup_settings.is_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="full_backup_enabled">{{ _('Enable Scheduled Full Backups') }}</label>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <label for="full_backup_schedule_type">{{ _('Schedule Type') }}</label>
                            <select id="full_backup_schedule_type" name="full_backup_schedule_type" class="form-control form-select">
                                <option value="daily" {% if full_backup_settings.schedule_type == 'daily' %}selected{% endif %}>{{ _('Daily') }}</option>
                                <option value="weekly" {% if full_backup_settings.schedule_type == 'weekly' %}selected{% endif %}>{{ _('Weekly') }}</option>
                            </select>
                        </div>
                        <div class="form-group mb-2" id="day-of-week-group" {% if full_backup_settings.schedule_type != 'weekly' %}style="display: none;"{% endif %}>
                            <label for="full_backup_day_of_week">{{ _('Day of Week') }}</label>
                            <select id="full_backup_day_of_week" name="full_backup_day_of_week" class="form-control form-select">
                                <option value="0" {% if full_backup_settings.day_of_week == 0 %}selected{% endif %}>{{ _('Monday') }}</option>
                                <option value="1" {% if full_backup_settings.day_of_week == 1 %}selected{% endif %}>{{ _('Tuesday') }}</option>
                                <option value="2" {% if full_backup_settings.day_of_week == 2 %}selected{% endif %}>{{ _('Wednesday') }}</option>
                                <option value="3" {% if full_backup_settings.day_of_week == 3 %}selected{% endif %}>{{ _('Thursday') }}</option>
                                <option value="4" {% if full_backup_settings.day_of_week == 4 %}selected{% endif %}>{{ _('Friday') }}</option>
                                <option value="5" {% if full_backup_settings.day_of_week == 5 %}selected{% endif %}>{{ _('Saturday') }}</option>
                                <option value="6" {% if full_backup_settings.day_of_week == 6 %}selected{% endif %}>{{ _('Sunday') }}</option>
                            </select>
                        </div>
                        <div class="form-group mb-2">
                            <label for="full_backup_time_of_day">{{ _('Time of Day (UTC)') }}</label>
                            <input type="time" id="full_backup_time_of_day" name="full_backup_time_of_day" class="form-control" value="{{ full_backup_settings.time_of_day | default('02:00') }}" required>
                        </div>
                        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Full Backup Schedule') }}</button>
                    </form>
                </div>
            </div>
        </div> <!-- End systemTabPane -->

        <!-- Booking Data Management Tab Pane -->
        <div class="tab-pane fade" id="bookingDataTabPane" role="tabpanel" aria-labelledby="booking-data-tab">
            <!-- Selective Booking Restore Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Selective Booking Restore (Advanced)') }}</h2>
                </div>
                <div class="card-body">
                    <p>{{_('These options allow restoring only booking data from different backup types, leaving other system configurations and media files untouched.')}}</p>
                    <!-- Restore Bookings from Full System Backup -->
                    <section id="restore-bookings-from-full-db-section" class="mb-3 p-3 border rounded">
                        <h5>{{ _('Restore Bookings from Full System Backup') }}</h5>
                        <div class="alert alert-warning" role="alert">
                            <strong>{{ _('Warning:') }}</strong> {{ _('This will delete ALL current bookings and replace them with the bookings from the selected full system backup.') }}
                        </div>
                        <div class="form-group mb-2">
                            <label for="selectFullBackupForBookingRestore">{{ _('Select Full Backup Timestamp:') }}</label>
                            <select id="selectFullBackupForBookingRestore" class="form-control form-select"></select>
                        </div>
                        <button id="btnRestoreBookingsFromFullDb" class="btn btn-warning mt-2">{{ _('Restore Bookings from Full Backup') }}</button>
                        <div id="statusRestoreBookingsFromFullDb" class="mt-2"></div>
                    </section>
                    <hr>
                    <!-- Restore Bookings from CSV Backup (JS driven) -->
                    <section id="restore-bookings-from-csv-js-section" class="mb-3 p-3 border rounded">
                        <h5>{{ _('Restore Bookings from Specific CSV Backup') }}</h5>
                        <p>{{ _('Select a specific booking CSV export file to restore from. This typically adds or updates bookings based on the CSV content and system\'s import logic.') }}</p>
                        <div class="form-group mb-2">
                            <label for="selectCsvBackupForBookingRestore">{{ _('Select CSV Backup:') }}</label>
                            <select id="selectCsvBackupForBookingRestore" class="form-control form-select"></select>
                        </div>
                        <button id="btnRestoreBookingsFromCsv" class="btn btn-info mt-2">{{ _('Restore Bookings from Selected CSV') }}</button>
                        <div id="statusRestoreBookingsFromCsv" class="mt-2"></div>
                    </section>
                    <hr>
                    <!-- Restore Bookings from Incremental Backups -->
                    <section id="restore-bookings-from-incremental-section" class="mb-3 p-3 border rounded">
                        <h5>{{ _('Restore Bookings from Incremental Backups') }}</h5>
                        <p>{{ _('Applies all available incremental booking backups sequentially to update booking records.') }}</p>
                        <div class="form-group mb-2">
                            <label>{{ _('Available Incremental Backups:') }}</label>
                            <div id="incrementalBackupsList" class="log-area" style="max-height: 150px;"><em>{{ _('Loading incremental backups list...') }}</em></div>
                        </div>
                        <button id="btnRestoreBookingsFromIncremental" class="btn btn-success mt-2">{{ _('Apply Incremental Backups') }}</button>
                        <div id="statusRestoreBookingsFromIncremental" class="mt-2"></div>
                    </section>
                </div>
            </div> <!-- End Selective Booking Restore Card -->

            <!-- Booking CSV Backups Card (Manual Operations) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Manual Booking CSV Backups & Restore (Legacy)') }}</h2>
                </div>
                <div class="card-body">
                    <section id="booking-csv-restore-section">
                        <p>{{ _('Manually create a CSV export of bookings, or restore bookings from a previously generated CSV export. When restoring, this will add new bookings from the CSV, skipping any that appear to be duplicates based on resource, user, and time.') }}</p>
                        <form method="POST" action="{{ url_for('admin_ui.manual_backup_bookings_csv_route') }}" style="margin-bottom: 15px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="form-row align-items-center">
                                <div class="col-auto">
                                    <label class="sr-only" for="booking_backup_range">{{ _('Select Backup Range') }}</label>
                                    <select class="custom-select mr-sm-2" id="booking_backup_range" name="backup_range_type">
                                        <option value="all" selected>{{ _('All Bookings') }}</option>
                                        <option value="1day">{{ _('Last 1 Day') }}</option>
                                        <option value="3days">{{ _('Last 3 Days') }}</option>
                                        <option value="7days">{{ _('Last 7 Days') }}</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary" onclick="return confirm('{{ _('Are you sure you want to manually back up bookings for the selected range to a new CSV file?') }}');">
                                        <i class="fas fa-file-csv"></i> {{ _('Backup Bookings to CSV') }}
                                    </button>
                                </div>
                            </div>
                        </form>

                        {% if booking_csv_backups and booking_csv_backups|length > 0 %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>{{ _('Backup Details') }}</th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup_item in booking_csv_backups %}
                                <tr>
                                    <td>{{ backup_item.display_name }}</td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin_ui.restore_booking_csv_route', timestamp_str=backup_item.timestamp) }}" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('{{ _('Are you sure you want to restore bookings from CSV backup') }} \'{{ backup_item.display_name }}\'? {{ _('This may add new bookings or skip duplicates based on existing data.') }}');">
                                                {{ _('Restore Bookings from this CSV') }}
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('admin_ui.verify_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-info btn-sm"><i class="fas fa-check-circle"></i> {{ _('Verify') }}</button>
                                        </form>
                                        <form method="POST" action="{{ url_for('admin_ui.delete_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{{ _('Are you sure you want to permanently delete the booking CSV backup for file:') }} ' + '{{ backup_item.display_name | e }}');">
                                                <i class="fas fa-trash-alt"></i> {{ _('Delete') }}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p>{{ _('No booking CSV backups found.') }}</p>
                        {% endif %}
                        {% if booking_csv_total_pages > 1 %}
                        <nav aria-label="Booking CSV Backup Pagination" class="mt-3">
                            <ul class="pagination justify-content-center">
                                {% if booking_csv_has_prev %}<li class="page-item"><a class="page-link" href="{{ url_for('admin_ui.serve_backup_restore_page', page=booking_csv_page - 1) }}">{{ _('Previous') }}</a></li>{% else %}<li class="page-item disabled"><span class="page-link">{{ _('Previous') }}</span></li>{% endif %}
                                <li class="page-item disabled"><span class="page-link">{{ _('Page %(page)s of %(total_pages)s', page=booking_csv_page, total_pages=booking_csv_total_pages) }}</span></li>
                                {% if booking_csv_has_next %}<li class="page-item"><a class="page-link" href="{{ url_for('admin_ui.serve_backup_restore_page', page=booking_csv_page + 1) }}">{{ _('Next') }}</a></li>{% else %}<li class="page-item disabled"><span class="page-link">{{ _('Next') }}</span></li>{% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    </section>
                </div>
            </div>

            <!-- Scheduled Booking CSV Backups Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Scheduled Booking Data Backups') }}</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_ui.save_booking_csv_schedule_settings') }}" id="booking-csv-schedule-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group mb-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="booking_csv_backup_enabled" name="booking_csv_backup_enabled" value="true" {% if booking_csv_backup_settings.is_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="booking_csv_backup_enabled">{{ _('Enable Scheduled Booking Data Backups') }}</label>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <label for="booking_csv_backup_interval_minutes">{{ _('Backup Interval (minutes)') }}</label>
                            <input type="number" class="form-control" id="booking_csv_backup_interval_minutes" name="booking_csv_backup_interval_minutes" value="{{ booking_csv_backup_settings.interval_minutes | default(60) }}" min="1" required>
                        </div>
                        <div class="form-group mb-2">
                            <label for="booking_backup_type_select">{{ _('Backup Type') }}</label>
                            <select id="booking_backup_type_select" name="booking_backup_type" class="form-control form-select">
                                <option value="full_export" {% if booking_csv_backup_settings.booking_backup_type == 'full_export' %}selected{% endif %}>{{ _('Full Export of Range (CSV)') }}</option>
                                <option value="incremental" {% if booking_csv_backup_settings.booking_backup_type == 'incremental' %}selected{% endif %}>{{ _('Incremental Changes (JSON)') }}</option>
                            </select>
                        </div>
                        <div class="form-group mb-2" id="booking_csv_backup_range_type_group">
                            <label for="booking_csv_backup_range_type">{{ _('Backup Data Range (for Full Export)') }}</label>
                            <select id="booking_csv_backup_range_type" name="booking_csv_backup_range_type" class="form-control form-select">
                                <option value="all" {% if booking_csv_backup_settings.range == 'all' %}selected{% endif %}>{{ _('All Bookings') }}</option>
                                <option value="1day" {% if booking_csv_backup_settings.range == '1day' %}selected{% endif %}>{{ _('Last 1 Day') }}</option>
                                <option value="3days" {% if booking_csv_backup_settings.range == '3days' %}selected{% endif %}>{{ _('Last 3 Days') }}</option>
                                <option value="7days" {% if booking_csv_backup_settings.range == '7days' %}selected{% endif %}>{{ _('Last 7 Days') }}</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Booking Data Schedule') }}</button>
                    </form>
                </div>
            </div>
        </div> <!-- End bookingDataTabPane -->

        <!-- General Settings Tab Pane -->
        <div class="tab-pane fade" id="settingsTabPane" role="tabpanel" aria-labelledby="settings-tab">
            <!-- Startup Behavior Settings Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="card-title h5">{{ _('Startup Behavior Settings') }}</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_ui.save_auto_restore_booking_records_settings') }}" id="startup-settings-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group mb-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="auto_restore_booking_records_enabled" name="auto_restore_booking_records_enabled" value="true" {% if auto_restore_booking_records_on_startup %}checked{% endif %}>
                                <label class="form-check-label" for="auto_restore_booking_records_enabled">
                                    {{ _('Enable Automatic Restore of Booking Records on Application Startup') }}
                                    <small class="form-text text-muted">{{ _('(Applies incremental booking backups if available)') }}</small>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Startup Settings') }}</button>
                    </form>
                </div>
            </div>
        </div> <!-- End settingsTabPane -->
    </div> <!-- End backupRestoreTabContent -->

    <!-- Global Log Areas -->
    <div class="mt-4"> <!-- Added a wrapper for spacing -->
        <h5>{{ _('Operation Logs') }}</h5>
        <pre id="backup-log-area" class="log-area" style="display: none;"></pre>
        <pre id="restore-log-area" class="log-area" style="display: none;"></pre>
    </div>

    <!-- Selective Restore Modal (remains global) -->
    <div id="selective-restore-modal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-selective-restore-modal">&times;</span>
            <h3>{{ _('Selective Restore Options') }}</h3>
            <p>{{ _('Select components to restore for backup:') }} <strong id="modal-backup-timestamp"></strong></p>
            <form id="selective-restore-form">
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="database" id="component-database" name="components">
                    <label class="form-check-label" for="component-database">{{ _('Database (Bookings, Users, Resources, etc.)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="map_config" id="component-map_config" name="components">
                    <label class="form-check-label" for="component-map_config">{{ _('Map Configuration (Floor map definitions & resource mappings on maps)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="floor_maps" id="component-floor_maps" name="components">
                    <label class="form-check-label" for="component-floor_maps">{{ _('Floor Map Images (in static/floor_map_uploads)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="resource_uploads" id="component-resource_uploads" name="components">
                    <label class="form-check-label" for="component-resource_uploads">{{ _('Resource Images (in static/resource_uploads)') }}</label>
                </div>
                <hr>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="all" id="component-all" name="components_all">
                    <label class="form-check-label" for="component-all">{{ _('ALL COMPONENTS (Full Restore)') }}</label>
                </div>
                <button type="submit" id="confirm-selective-restore-btn" class="btn btn-primary mt-3">{{ _('Proceed with Selected Restore') }}</button>
            </form>
            <div id="selective-restore-modal-status" class="status-message mt-2"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const socket = io();

        // --- Global Interactive Element Selectors ---
        const interactiveElementSelectors = [
            '#one-click-backup-btn',
            '#list-backups-btn',
            '.restore-btn',
            '.restore-dry-run-btn',
            '.delete-backup-btn',
            'form[action^="/admin/verify_full_backup/"] button[type="submit"]',
            '#confirm-selective-restore-btn',
            'form[action*="manual_backup_bookings_csv_route"] button[type="submit"]',
            'form[action*="restore_booking_csv_route"] button[type="submit"]',
            'form[action*="verify_booking_csv_backup_route"] button[type="submit"]',
            'form[action*="delete_booking_csv_backup_route"] button[type="submit"]',
            'form[action*="save_booking_csv_schedule_route"] button[type="submit"]',
            '#full-backup-schedule-form button[type="submit"]',
            '#full_backup_enabled',
            '#full_backup_schedule_type',
            '#full_backup_day_of_week',
            '#full_backup_time_of_day',
            '#booking-csv-schedule-form button[type="submit"]',
            '#booking_csv_backup_enabled',
            '#booking_csv_backup_interval_minutes',
            '#booking_backup_type_select',
            '#booking_csv_backup_range_type',
            '#startup-settings-form button[type="submit"]',
            '#auto_restore_booking_records_enabled',
            '#backup-prev-page a.page-link',
            '#backup-next-page a.page-link',
            '#selective-restore-form input.component-checkbox',
            '#selective-restore-form input#component-all',
            // Add new selective booking restore buttons and selects
            '#selectFullBackupForBookingRestore',
            '#btnRestoreBookingsFromFullDb',
            '#selectCsvBackupForBookingRestore',
            '#btnRestoreBookingsFromCsv',
            '#btnRestoreBookingsFromIncremental'
        ];

        function disablePageInteractions() {
            console.log("Disabling page interactions.");
            interactiveElementSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.tagName === 'A' && el.classList.contains('page-link')) {
                        el.classList.add('disabled');
                        el.setAttribute('aria-disabled', 'true');
                        el.onclick = (event) => event.preventDefault();
                    } else {
                        el.disabled = true;
                    }
                });
            });
        }

        function enablePageInteractions() {
            console.log("Enabling page interactions.");
            interactiveElementSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.tagName === 'A' && el.classList.contains('page-link')) {
                        el.classList.remove('disabled');
                        el.removeAttribute('aria-disabled');
                        el.onclick = null;
                    } else {
                        el.disabled = false;
                    }
                });
            });
        }

        // --- UTC Clock ---
        function updateUtcClock() {
            const clockElement = document.getElementById('utc-clock');
            if (clockElement) {
                const now = new Date();
                const year = now.getUTCFullYear();
                const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                const day = String(now.getUTCDate()).padStart(2, '0');
                const hours = String(now.getUTCHours()).padStart(2, '0');
                const minutes = String(now.getUTCMinutes()).padStart(2, '0');
                const seconds = String(now.getUTCSeconds()).padStart(2, '0');
                const customUtcString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
                clockElement.textContent = customUtcString;
            }
        }
        setInterval(updateUtcClock, 1000);
        updateUtcClock();
        // --- End UTC Clock ---

        // System Backup & Restore Tab
        const backupButton = document.getElementById('one-click-backup-btn');
        const backupStatusMessageEl = document.getElementById('backup-status-message');
        const listBackupsButton = document.getElementById('list-backups-btn');
        const restoreStatusMessageEl = document.getElementById('restore-status-message');
        const availableBackupsTbody = document.getElementById('available-backups-tbody');
        const availableBackupsTable = document.getElementById('available-backups-table');

        // Global Log areas (now outside tabs)
        const backupLogAreaEl = document.getElementById('backup-log-area');
        const restoreLogAreaEl = document.getElementById('restore-log-area');

        // Booking Data Management Tab - Selective Booking Restore Elements
        const selectFullBackupForBookingRestore = document.getElementById('selectFullBackupForBookingRestore');
        const btnRestoreBookingsFromFullDb = document.getElementById('btnRestoreBookingsFromFullDb');
        const statusRestoreBookingsFromFullDb = document.getElementById('statusRestoreBookingsFromFullDb');

        const selectCsvBackupForBookingRestore = document.getElementById('selectCsvBackupForBookingRestore');
        const btnRestoreBookingsFromCsv = document.getElementById('btnRestoreBookingsFromCsv');
        const statusRestoreBookingsFromCsv = document.getElementById('statusRestoreBookingsFromCsv');

        const incrementalBackupsListDiv = document.getElementById('incrementalBackupsList');
        const btnRestoreBookingsFromIncremental = document.getElementById('btnRestoreBookingsFromIncremental');
        const statusRestoreBookingsFromIncremental = document.getElementById('statusRestoreBookingsFromIncremental');

        // Global Modal Elements
        const selectiveRestoreModal = document.getElementById('selective-restore-modal');
        const closeModalBtn = document.getElementById('close-selective-restore-modal');
        const modalBackupTimestampEl = document.getElementById('modal-backup-timestamp');
        const selectiveRestoreForm = document.getElementById('selective-restore-form');
        const confirmSelectiveRestoreBtn = document.getElementById('confirm-selective-restore-btn');
        const selectiveRestoreModalStatusEl = document.getElementById('selective-restore-modal-status');
        const componentCheckboxes = document.querySelectorAll('#selective-restore-form input[name="components"]');
        const componentAllCheckbox = document.getElementById('component-all');

        let currentBackupTaskId = null;
        let currentRestoreTaskId = null;
        let currentVerifyTaskId = null;
        let currentDeleteTaskId = null;
        // Task IDs for new booking restore operations
        let currentBookingCsvRestoreTaskId = null;
        let currentBookingIncrementalRestoreTaskId = null;
        let currentBookingFullDbRestoreTaskId = null;

        let currentPage = 1;
        const backupsPerPage = 5;
        let allBackups = [];

        socket.on('connect', () => { console.log('Socket.IO connected for backup/restore logs.'); });
        socket.on('disconnect', (reason) => { console.warn('Socket.IO disconnected:', reason); });
        socket.on('connect_error', (error) => { console.error('Socket.IO connection error:', error); });

        function appendLog(logAreaId, message, detail, type = 'info', specificStatusEl = null) {
            const logArea = document.getElementById(logAreaId);
            if (logArea) {
                logArea.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry log-' + type;
                logEntry.textContent = `[${timestamp}] ${message}${detail ? ' - ' + detail : ''}`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;
            }
            if (specificStatusEl) {
                specificStatusEl.textContent = `${message}${detail ? ' ('+detail+')':''}`;
                specificStatusEl.className = `alert alert-${type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')} mt-2`;
            }
        }

        function keepAlive() {
            fetch('/ping', { method: 'GET', headers: { 'Accept': 'application/json' } })
            .then(response => {
                if (!response.ok) {
                    console.warn('Keep-alive ping failed. Status:', response.status);
                    appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                              'Session keep-alive ping failed.', `Status: ${response.status}`, 'error');
                }
            })
            .catch(error => {
                console.error('Keep-alive ping error:', error);
                appendLog(currentBackupTaskId ? 'backup-log-area' : (currentRestoreTaskId ? 'restore-log-area' : 'backup-log-area'),
                          'Session keep-alive ping error.', error.message, 'error');
            });
        }
        setInterval(keepAlive, 4 * 60 * 1000);

        // DEFINE HELPER FUNCTIONS FOR POPULATING LISTS FIRST
        function loadFullBackupsForBookingRestore() {
            const selectEl = document.getElementById('selectFullBackupForBookingRestore');
            if (!selectEl) { console.error("#selectFullBackupForBookingRestore not found"); return; }
            selectEl.innerHTML = '<option value="">{{ _("Loading...") }}</option>';
            fetch('/api/admin/booking_restore/list_full_backups')
                .then(response => response.json())
                .then(data => {
                    selectEl.innerHTML = '<option value="">{{ _("-- Select a Full Backup --") }}</option>';
                    if (data.success && data.backups && data.backups.length > 0) {
                        data.backups.forEach(timestamp => {
                            const option = document.createElement('option');
                            option.value = timestamp;
                            let displayTimestamp = timestamp;
                             try {
                                const year = timestamp.substring(0,4); const month = timestamp.substring(4,6);
                                const day = timestamp.substring(6,8); const hour = timestamp.substring(9,11);
                                const minute = timestamp.substring(11,13); const second = timestamp.substring(13,15);
                                displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second} UTC`;
                            } catch (e) { /* ignore */ }
                            option.textContent = displayTimestamp;
                            selectEl.appendChild(option);
                        });
                         selectEl.disabled = false;
                         if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = false;
                    } else {
                        selectEl.innerHTML = '<option value="">{{ _("No full backups found") }}</option>';
                        selectEl.disabled = true;
                        if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading full backups for booking restore:', error);
                    selectEl.innerHTML = '<option value="">{{ _("Error loading backups") }}</option>';
                    selectEl.disabled = true;
                    if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = true;
                });
        }

        function loadCsvBackupsForBookingRestore() {
            const selectEl = document.getElementById('selectCsvBackupForBookingRestore');
            if (!selectEl) { console.error("#selectCsvBackupForBookingRestore not found"); return; }
            selectEl.innerHTML = '<option value="">{{ _("Loading...") }}</option>';
            fetch('/api/admin/booking_restore/list_csv')
                .then(response => response.json())
                .then(data => {
                    selectEl.innerHTML = '<option value="">{{ _("-- Select a CSV Backup --") }}</option>';
                    if (data.success && data.backups && data.backups.length > 0) {
                        data.backups.forEach(backup => {
                            const option = new Option(backup.display_name, backup.timestamp);
                            selectEl.add(option);
                        });
                        selectEl.disabled = false;
                        if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = false;
                    } else {
                        selectEl.innerHTML = '<option value="">{{ _("No CSV backups found") }}</option>';
                        selectEl.disabled = true;
                        if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading CSV backups for booking restore:', error);
                    selectEl.innerHTML = '<option value="">{{ _("Error loading backups") }}</option>';
                    selectEl.disabled = true;
                    if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = true;
                });
        }

        function loadIncrementalBackupsList() {
            const listDiv = document.getElementById('incrementalBackupsList'); // Corrected variable name
            if (!listDiv) { console.error("#incrementalBackupsList not found"); return; }
            listDiv.innerHTML = '<em>{{ _("Loading incremental backups list...") }}</em>';
            fetch('/api/admin/booking_restore/list_incremental')
                .then(response => response.json())
                .then(data => {
                    listDiv.innerHTML = '';
                    if (data.success && data.backups && data.backups.length > 0) {
                        const ul = document.createElement('ul');
                        ul.className = 'list-group';
                        data.backups.forEach(backup => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item list-group-item-sm py-1';
                            li.textContent = backup.display_name;
                            ul.appendChild(li);
                        });
                        listDiv.appendChild(ul);
                        listDiv.style.maxHeight = '150px';
                        listDiv.style.overflowY = 'auto';
                        if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = false;
                    } else if (data.success) {
                        listDiv.textContent = "{{ _('No incremental backups available to apply.') }}";
                        if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                    } else {
                        listDiv.textContent = "{{ _('Error loading incremental backups list.') }}";
                         if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading incremental backups list:', error);
                    listDiv.textContent = "{{ _('Error loading list.') }}";
                    if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                });
        }

        // SocketIO listeners
        socket.on('backup_progress', function(data) {
            console.log('Backup progress event:', data);
            if (data.task_id !== currentBackupTaskId) return;
            let messageType = data.level ? data.level.toLowerCase() : 'info';
            appendLog('backup-log-area', data.status, data.detail, messageType, backupStatusMessageEl);
            if (data.status === "Backup completed with overall success: True" || data.status.startsWith("Backup completed with overall success: False")) {
                enablePageInteractions();
                currentBackupTaskId = null;
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) {
                    loadAvailableBackups();
                }
            }
        });

        socket.on('restore_progress', function(data) {
            console.log('Restore progress event:', data);
            // Determine which restore operation this is for (if specific task IDs are not used for this generic event)
            let targetStatusEl = restoreStatusMessageEl; // Default to main restore status
            if (currentBookingFullDbRestoreTaskId && data.task_id === currentBookingFullDbRestoreTaskId) {
                targetStatusEl = statusRestoreBookingsFromFullDb;
            } // Add more else-if for other booking restore types if they also use 'restore_progress'

            if (data.task_id === currentRestoreTaskId || data.task_id === currentBookingFullDbRestoreTaskId) { // Check against relevant task IDs
                let messageType = data.level ? data.level.toLowerCase() : 'info';
                appendLog('restore-log-area', data.status, data.detail, messageType, targetStatusEl);
                const lowerStatus = data.status.toLowerCase();
                if (lowerStatus.includes("completed") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerStatus.includes("critical")) {
                    enablePageInteractions();
                    if (data.task_id === currentRestoreTaskId) currentRestoreTaskId = null;
                    if (data.task_id === currentBookingFullDbRestoreTaskId) currentBookingFullDbRestoreTaskId = null;
                }
                if (data.actions && Array.isArray(data.actions)) { /* ... existing action display logic ... */ }
                if (data.summary && Array.isArray(data.summary)) { /* ... existing summary display logic ... */ }
            }
        });

        socket.on('booking_db_restore_progress', function(data) {
            if (data.task_id !== currentBookingFullDbRestoreTaskId) return;
            appendLog('restore-log-area', `Full DB Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromFullDb);
            if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                enablePageInteractions();
                currentBookingFullDbRestoreTaskId = null;
            }
        });
        socket.on('booking_csv_restore_progress', function(data) {
            if (data.task_id !== currentBookingCsvRestoreTaskId) return;
            appendLog('restore-log-area', `CSV Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromCsv);
             if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                enablePageInteractions();
                currentBookingCsvRestoreTaskId = null;
            }
        });
        socket.on('incremental_booking_restore_progress', function(data) {
            if (data.task_id !== currentBookingIncrementalRestoreTaskId) return;
            appendLog('restore-log-area', `Incremental Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromIncremental);
            if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                enablePageInteractions();
                currentBookingIncrementalRestoreTaskId = null;
                loadIncrementalBackupsList();
            }
        });


        // One Click Backup
        if(backupButton) backupButton.addEventListener('click', function () {
            currentBackupTaskId = null;
            backupLogAreaEl.innerHTML = '';
            backupLogAreaEl.style.display = 'block';
            restoreLogAreaEl.style.display = 'none';
            appendLog('backup-log-area', "{{ _('Initiating backup request...') }}", '', 'info', backupStatusMessageEl);
            disablePageInteractions();
            fetch('/api/admin/one_click_backup', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                currentBackupTaskId = data.task_id;
                const messageType = data.success ? 'info' : 'error';
                appendLog('backup-log-area', data.message || (data.success ? "{{ _('Backup process started on server.') }}" : "{{ _('Failed to start backup process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, backupStatusMessageEl);
                if (!data.success) {
                    enablePageInteractions();
                }
            })
            .catch(error => {
                console.error('Backup error:', error);
                appendLog('backup-log-area', "{{ _('Backup request failed:') }}", error.message, 'error', backupStatusMessageEl);
                enablePageInteractions();
            });
        });

        // Selective Restore Form Submission
        if(selectiveRestoreForm) selectiveRestoreForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const backupTimestamp = this.dataset.timestamp;
            const selectedComponents = Array.from(document.querySelectorAll('#selective-restore-form input[name="components"]:checked'))
                                         .map(cb => cb.value);
            if (selectedComponents.length === 0) {
                selectiveRestoreModalStatusEl.textContent = "{{ _('Please select at least one component to restore.') }}";
                selectiveRestoreModalStatusEl.className = 'alert alert-warning';
                return;
            }
            currentRestoreTaskId = null;
            restoreLogAreaEl.innerHTML = '';
            restoreLogAreaEl.style.display = 'block';
            backupLogAreaEl.style.display = 'none';
            appendLog('restore-log-area', `{{ _('Initiating selective restore for') }} ${backupTimestamp}...`, `Components: ${selectedComponents.join(', ')}`, 'info', restoreStatusMessageEl);
            disablePageInteractions();
            selectiveRestoreModalStatusEl.textContent = "{{ _('Processing...') }}";
            selectiveRestoreModalStatusEl.className = 'alert alert-info';

            fetch('/api/admin/selective_restore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                body: JSON.stringify({ backup_timestamp: backupTimestamp, components: selectedComponents })
            })
            .then(response => response.json())
            .then(data => {
                currentRestoreTaskId = data.task_id;
                const messageType = data.success ? 'info' : 'error';
                appendLog('restore-log-area', data.message || (data.success ? `{{ _('Selective restore for ${backupTimestamp} process started.') }}` : `{{ _('Failed to start selective restore for ${backupTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, restoreStatusMessageEl);
                selectiveRestoreModalStatusEl.textContent = data.message;
                selectiveRestoreModalStatusEl.className = `alert alert-${messageType}`;
                if (data.success) {
                    selectiveRestoreModal.style.display = 'none';
                } else {
                    enablePageInteractions();
                }
            })
            .catch(error => {
                console.error('Selective restore error:', error);
                const errorMsg = `{{ _('Selective restore request for ${backupTimestamp} failed:') }} ${error.toString()}`;
                appendLog('restore-log-area', errorMsg, '', 'error', restoreStatusMessageEl);
                selectiveRestoreModalStatusEl.textContent = errorMsg;
                selectiveRestoreModalStatusEl.className = 'alert alert-danger';
                enablePageInteractions();
            });
        });

        function loadAvailableBackups() {
            disablePageInteractions();
            appendLog('restore-log-area', "{{ _('Fetching available full system backups...') }}", '', 'info', restoreStatusMessageEl);
            availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Loading...") }}</td></tr>';
            document.getElementById('backup-pagination-nav').style.display = 'none';

            fetch('/api/admin/list_backups', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.backups) {
                    allBackups = data.backups;
                    currentPage = 1;
                    displayBackupsPage();
                    if (allBackups.length > 0) {
                        appendLog('restore-log-area', "{{ _('Available full system backups loaded.') }}", '', 'success', restoreStatusMessageEl);
                    } else {
                         appendLog('restore-log-area', "{{ _('No full system backups found.') }}", '', 'info', restoreStatusMessageEl);
                    }
                } else {
                    allBackups = [];
                    availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Failed to load backups.") }}</td></tr>';
                    appendLog('restore-log-area', "{{ _('Failed to load full system backups:') }}", data.message || "{{ _('Unknown error.') }}", 'error', restoreStatusMessageEl);
                    document.getElementById('backup-pagination-nav').style.display = 'none';
                }
            })
            .catch(error => {
                allBackups = [];
                console.error('List backups error:', error);
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("Error loading backups.") }}</td></tr>';
                appendLog('restore-log-area', "{{ _('Error fetching full system backups:') }}", error.toString(), 'error', restoreStatusMessageEl);
                document.getElementById('backup-pagination-nav').style.display = 'none';
            })
            .finally(() => {
                enablePageInteractions();
                // Load lists for new selective booking restore sections
                loadFullBackupsForBookingRestore();
                loadCsvBackupsForBookingRestore();
                loadIncrementalBackupsList();
            });
        }

        function displayBackupsPage() {
            availableBackupsTbody.innerHTML = '';
            const paginationNav = document.getElementById('backup-pagination-nav');
            const pageInfoEl = document.getElementById('backup-page-info');
            const prevPageBtn = document.getElementById('backup-prev-page');
            const nextPageBtn = document.getElementById('backup-next-page');

            if (allBackups.length === 0) {
                availableBackupsTbody.innerHTML = '<tr><td colspan="2">{{ _("No backups available.") }}</td></tr>';
                paginationNav.style.display = 'none';
                return;
            }

            const startIndex = (currentPage - 1) * backupsPerPage;
            const endIndex = startIndex + backupsPerPage;
            const pageBackups = allBackups.slice(startIndex, endIndex);

            pageBackups.forEach(timestamp => {
                const row = availableBackupsTbody.insertRow();
                const cellTimestamp = row.insertCell();
                const cellAction = row.insertCell();
                let displayTimestamp = timestamp;
                try {
                    const year = timestamp.substring(0,4); const month = timestamp.substring(4,6);
                    const day = timestamp.substring(6,8); const hour = timestamp.substring(9,11);
                    const minute = timestamp.substring(11,13); const second = timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }

                cellTimestamp.textContent = displayTimestamp;
                const restoreBtn = document.createElement('button');
                restoreBtn.textContent = "{{ _('Restore') }}";
                restoreBtn.className = 'btn btn-sm btn-warning restore-btn me-2';
                restoreBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(restoreBtn);

                const dryRunBtn = document.createElement('button');
                dryRunBtn.textContent = "{{ _('Dry Run') }}";
                dryRunBtn.className = 'btn btn-sm btn-info restore-dry-run-btn me-2';
                dryRunBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(dryRunBtn);

                const verifyBtnJs = document.createElement('button');
                verifyBtnJs.type = 'button';
                verifyBtnJs.className = 'btn btn-info btn-sm verify-backup-btn-js';
                verifyBtnJs.innerHTML = '<i class="fas fa-check-circle"></i> {{ _("Verify") }}';
                verifyBtnJs.setAttribute('data-timestamp', timestamp);
                verifyBtnJs.style.marginLeft = '5px';
                cellAction.appendChild(verifyBtnJs);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = "{{ _('Delete') }}";
                deleteBtn.className = 'btn btn-sm btn-danger delete-backup-btn';
                deleteBtn.style.marginLeft = '5px';
                deleteBtn.setAttribute('data-timestamp', timestamp);
                cellAction.appendChild(deleteBtn);
            });

            const totalPages = Math.ceil(allBackups.length / backupsPerPage);
            if (totalPages > 1) {
                paginationNav.style.display = 'block';
                pageInfoEl.textContent = `{{ _('Page') }} ${currentPage} {{ _('of') }} ${totalPages}`;
                prevPageBtn.classList.toggle('disabled', currentPage === 1);
                nextPageBtn.classList.toggle('disabled', endIndex >= allBackups.length);
            } else {
                paginationNav.style.display = 'none';
            }
        }

        if(listBackupsButton) listBackupsButton.addEventListener('click', loadAvailableBackups);

        const backupPrevPage = document.getElementById('backup-prev-page');
        if(backupPrevPage) backupPrevPage.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                displayBackupsPage();
            }
        });

        const backupNextPage = document.getElementById('backup-next-page');
        if(backupNextPage) backupNextPage.addEventListener('click', function(e) {
            e.preventDefault();
            if ((currentPage * backupsPerPage) < allBackups.length) {
                currentPage++;
                displayBackupsPage();
            }
        });

        if(availableBackupsTable) availableBackupsTable.addEventListener('click', function (event) {
            const targetButton = event.target.closest('button'); // Ensure we get the button if icon is clicked
            if (!targetButton) return;

            let isRestore = targetButton.classList.contains('restore-btn');
            let isDryRun = targetButton.classList.contains('restore-dry-run-btn');
            let isDelete = targetButton.classList.contains('delete-backup-btn');
            let isVerifyJs = targetButton.classList.contains('verify-backup-btn-js');

            if (isVerifyJs) {
                const timestampToVerify = targetButton.getAttribute('data-timestamp');
                currentVerifyTaskId = null; currentDeleteTaskId = null; currentRestoreTaskId = null; currentBackupTaskId = null;
                restoreLogAreaEl.innerHTML = ''; restoreLogAreaEl.style.display = 'block'; backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `{{ _('VERIFY: Initiating verification for backup') }} ${timestampToVerify}...`, '', 'info', restoreStatusMessageEl);
                disablePageInteractions();
                fetch('/api/admin/verify_backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                    body: JSON.stringify({ backup_timestamp: timestampToVerify })
                })
                .then(response => response.json())
                .then(data => {
                    currentVerifyTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', `{{ _('VERIFY:') }} ${data.message || (data.success ? '{{ _("Verification process started on server.") }}' : '{{ _("Failed to start verification process.") }}')}`, `Task ID: ${data.task_id || 'N/A'}`, messageType, restoreStatusMessageEl);
                    if (!data.success) { enablePageInteractions(); currentVerifyTaskId = null; }
                })
                .catch(error => {
                    const errorMsg = `{{ _('Verification request for ${timestampToVerify} failed:') }} ${error.toString()}`;
                    appendLog('restore-log-area', errorMsg, '', 'error', restoreStatusMessageEl);
                    enablePageInteractions(); currentVerifyTaskId = null;
                });

            } else if (isDelete) {
                const backup_timestamp = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = backup_timestamp;
                 try {
                    const year = backup_timestamp.substring(0,4); const month = backup_timestamp.substring(4,6);
                    const day = backup_timestamp.substring(6,8); const hour = backup_timestamp.substring(9,11);
                    const minute = backup_timestamp.substring(11,13); const second = backup_timestamp.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }
                if (!confirm("{{ _('Are you sure you want to delete backup') }} '" + displayTimestamp + "'? {{ _('This action cannot be undone.') }}")) return;

                currentDeleteTaskId = null; currentRestoreTaskId = null; currentVerifyTaskId = null; currentBackupTaskId = null;
                restoreLogAreaEl.innerHTML = ''; restoreLogAreaEl.style.display = 'block'; backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', "{{ _('Initiating delete request for') }} " + displayTimestamp + "...", '', 'info', restoreStatusMessageEl);
                disablePageInteractions();

                fetch('/api/admin/delete_backup/' + backup_timestamp, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    currentDeleteTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Deletion process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start deletion for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, restoreStatusMessageEl);
                    if (!data.success) { enablePageInteractions(); currentDeleteTaskId = null; }
                })
                .catch(error => {
                    appendLog('restore-log-area', `{{ _('Delete request for ${displayTimestamp} failed:') }}`, error.message, 'error', restoreStatusMessageEl);
                    enablePageInteractions(); currentDeleteTaskId = null;
                });

            } else if (isRestore || isDryRun) {
                const timestampToProcess = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToProcess;
                try {
                    const year = timestampToProcess.substring(0,4); const month = timestampToProcess.substring(4,6);
                    const day = timestampToProcess.substring(6,8); const hour = timestampToProcess.substring(9,11);
                    const minute = timestampToProcess.substring(11,13); const second = timestampToProcess.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }
                currentRestoreTaskId = null; currentDeleteTaskId = null; currentVerifyTaskId = null; currentBackupTaskId = null;
                let confirmationMessage = isRestore ? "{{ _('Are you sure you want to restore from backup') }} " + displayTimestamp + "? {{ _('This will overwrite current data and may require an application restart.') }}" : "{{ _('Are you sure you want to perform a dry run for restoring from backup') }} " + displayTimestamp + "?";
                let endpoint = isRestore ? '/api/admin/one_click_restore' : `/api/admin/restore_dry_run/${timestampToProcess}`;
                let actionVerb = isRestore ? "{{ _('restore from') }}" : "{{ _('dry run restore from') }}";

                if (!confirm(confirmationMessage)) return;

                restoreLogAreaEl.innerHTML = ''; restoreLogAreaEl.style.display = 'block'; backupLogAreaEl.style.display = 'none';
                appendLog('restore-log-area', `{{ _('Initiating') }} ${actionVerb} ${displayTimestamp}...`, '', 'info', restoreStatusMessageEl);
                disablePageInteractions();

                let fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }};
                if (isRestore) fetchOptions.body = JSON.stringify({ backup_timestamp: timestampToProcess });

                fetch(endpoint, fetchOptions)
                .then(response => response.json())
                .then(data => {
                    currentRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? `{{ _('Process for ${displayTimestamp} started.') }}` : `{{ _('Failed to start process for ${displayTimestamp}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, restoreStatusMessageEl);
                    if (!data.success) enablePageInteractions();
                    if (isDryRun && data.success && data.actions && Array.isArray(data.actions)) {
                        appendLog('restore-log-area', "DRY RUN ACTIONS (from HTTP response):", '', 'info');
                        if (data.actions.length === 0) appendLog('restore-log-area', "  No actions would be performed.", '', 'info');
                        else data.actions.forEach(action => appendLog('restore-log-area', `  - ${action}`, '', 'info'));
                    }
                })
                .catch(error => {
                    appendLog('restore-log-area', `{{ _('Request for ${actionVerb} ${displayTimestamp} failed:') }}`, error.message, 'error', restoreStatusMessageEl);
                    enablePageInteractions();
                });
            } else if (targetButton.id === 'confirm-selective-restore-btn') {
                // This button is inside the modal, its handler is separate (selectiveRestoreForm submit)
            } else if (targetButton.classList.contains('restore-btn')) {
                const timestampToRestore = targetButton.getAttribute('data-timestamp');
                let displayTimestamp = timestampToRestore;
                 try {
                    const year = timestampToRestore.substring(0,4); const month = timestampToRestore.substring(4,6);
                    const day = timestampToRestore.substring(6,8); const hour = timestampToRestore.substring(9,11);
                    const minute = timestampToRestore.substring(11,13); const second = timestampToRestore.substring(13,15);
                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) { /* ignore */ }
                modalBackupTimestampEl.textContent = displayTimestamp;
                selectiveRestoreForm.dataset.timestamp = timestampToRestore;
                componentCheckboxes.forEach(cb => cb.checked = true);
                componentAllCheckbox.checked = true;
                selectiveRestoreModalStatusEl.textContent = '';
                selectiveRestoreModalStatusEl.className = 'status-message mt-2';
                selectiveRestoreModal.style.display = 'block';
            }
        });

        // Modal Close Button
        if (closeModalBtn) closeModalBtn.addEventListener('click', function() { selectiveRestoreModal.style.display = 'none'; });
        window.addEventListener('click', function(event) { if (event.target == selectiveRestoreModal) selectiveRestoreModal.style.display = 'none'; });

        // "ALL COMPONENTS" checkbox logic
        if(componentAllCheckbox) componentAllCheckbox.addEventListener('change', function() { componentCheckboxes.forEach(cb => cb.checked = this.checked); });
        componentCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) componentAllCheckbox.checked = false;
                else {
                    const allChecked = Array.from(componentCheckboxes).every(indCb => indCb.checked);
                    if (allChecked) componentAllCheckbox.checked = true;
                }
            });
        });

        loadAvailableBackups(); // Initial load of full system backups & other lists

        // SocketIO handler for backup verification progress
        socket.on('verify_backup_progress', function(data) {
            console.log('Verify backup progress event:', data);
            if (data.task_id !== currentVerifyTaskId) return;
            let messageType = data.level ? data.level.toLowerCase() : 'info';
            appendLog('restore-log-area', `VERIFY: ${data.status}`, data.detail, messageType, restoreStatusMessageEl);
            if (data.results) {
                if (data.results.checks && data.results.checks.length > 0) { /* ... existing detailed checks log ... */ }
                if (data.results.errors && data.results.errors.length > 0) { /* ... existing errors log ... */ }
                enablePageInteractions(); currentVerifyTaskId = null;
            } else if (data.status && (data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("missing") || data.status.toLowerCase().includes("critical") )) {
                enablePageInteractions(); currentVerifyTaskId = null;
            }
        });

        // Listener for Backup Deletion Progress
        socket.on('backup_delete_progress', function(data) {
            console.log('Backup delete progress event:', data);
            if (data.task_id !== currentDeleteTaskId) return;
            let messageType = data.level ? data.level.toLowerCase() : 'info';
            appendLog('restore-log-area', data.status, data.detail, messageType, restoreStatusMessageEl);
            const lowerStatus = data.status.toLowerCase();
            const lowerDetail = data.detail ? data.detail.toLowerCase() : "";
            if (lowerStatus.includes("finished") || lowerStatus.includes("failed") || lowerStatus.includes("error") || lowerDetail.includes("success") || lowerDetail.includes("failure") || lowerDetail.includes("critical_error")) {
                enablePageInteractions(); currentDeleteTaskId = null;
                if (messageType === 'success' || (data.detail && data.detail.toUpperCase().includes("SUCCESS"))) {
                    loadAvailableBackups();
                }
            }
        });

        function toggleDayOfWeekVisibility() {
            const typeSelect = document.getElementById('full_backup_schedule_type');
            const dayGroup = document.getElementById('day-of-week-group');
            if (typeSelect && dayGroup) {
                dayGroup.style.display = (typeSelect.value === 'weekly') ? 'block' : 'none';
            }
        }
        const newFullBackupScheduleTypeSelect = document.getElementById('full_backup_schedule_type');
        if (newFullBackupScheduleTypeSelect) {
            newFullBackupScheduleTypeSelect.addEventListener('change', toggleDayOfWeekVisibility);
            toggleDayOfWeekVisibility();
        }

        const bookingBackupTypeSelect = document.getElementById('booking_backup_type_select');
        const bookingRangeGroup = document.getElementById('booking_csv_backup_range_type_group');
        function toggleBookingRangeVisibility() {
            if (bookingBackupTypeSelect && bookingRangeGroup) {
                bookingRangeGroup.style.display = (bookingBackupTypeSelect.value === 'full_export') ? 'block' : 'none';
            }
        }
        if (bookingBackupTypeSelect) {
            bookingBackupTypeSelect.addEventListener('change', toggleBookingRangeVisibility);
            toggleBookingRangeVisibility();
        }

        // Event Handlers for new Selective Booking Restore buttons
        if (btnRestoreBookingsFromFullDb) {
            btnRestoreBookingsFromFullDb.addEventListener('click', function() {
                const selectedTimestamp = selectFullBackupForBookingRestore.value;
                if (!selectedTimestamp) {
                    appendLog('restore-log-area', "{{ _('Please select a full backup.') }}", '', 'error', statusRestoreBookingsFromFullDb);
                    return;
                }
                if (!confirm("{{ _('WARNING: This will delete ALL current bookings and replace them with bookings from the selected full system backup. Are you sure you want to proceed?') }}")) return;

                currentBookingFullDbRestoreTaskId = null;
                appendLog('restore-log-area', `{{ _('Initiating booking restore from full DB backup:') }} ${selectedTimestamp}...`, '', 'info', statusRestoreBookingsFromFullDb);
                disablePageInteractions();
                fetch('/api/admin/booking_restore/from_full_db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                    body: JSON.stringify({ backup_timestamp: selectedTimestamp })
                })
                .then(response => response.json())
                .then(data => {
                    currentBookingFullDbRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from full DB process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromFullDb);
                    if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')) )) {
                        enablePageInteractions();
                    }
                })
                .catch(error => {
                    appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromFullDb);
                    enablePageInteractions();
                });
            });
        }

        if (btnRestoreBookingsFromCsv) {
            btnRestoreBookingsFromCsv.addEventListener('click', function() {
                const selectedTimestamp = selectCsvBackupForBookingRestore.value;
                if (!selectedTimestamp) {
                    appendLog('restore-log-area', "{{ _('Please select a CSV backup.') }}", '', 'error', statusRestoreBookingsFromCsv);
                    return;
                }
                 if (!confirm("{{ _('Are you sure you want to restore bookings from CSV backup:') }} '" + selectCsvBackupForBookingRestore.options[selectCsvBackupForBookingRestore.selectedIndex].text + "'?")) return;

                currentBookingCsvRestoreTaskId = null;
                appendLog('restore-log-area', `{{ _('Initiating booking restore from CSV:') }} ${selectedTimestamp}...`, '', 'info', statusRestoreBookingsFromCsv);
                disablePageInteractions();
                fetch('/api/admin/booking_restore/from_csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                    body: JSON.stringify({ backup_timestamp: selectedTimestamp })
                })
                .then(response => response.json())
                .then(data => {
                    currentBookingCsvRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from CSV process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromCsv);
                     if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail')|| data.summary.status.includes('error')))) {
                        enablePageInteractions();
                    }
                })
                .catch(error => {
                    appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromCsv);
                    enablePageInteractions();
                });
            });
        }

        if (btnRestoreBookingsFromIncremental) {
            btnRestoreBookingsFromIncremental.addEventListener('click', function() {
                if (!confirm("{{ _('Are you sure you want to apply all available incremental booking backups? This will update your current booking records.') }}")) return;

                currentBookingIncrementalRestoreTaskId = null;
                appendLog('restore-log-area', "{{ _('Initiating booking restore from incremental backups...') }}", '', 'info', statusRestoreBookingsFromIncremental);
                disablePageInteractions();
                fetch('/api/admin/booking_restore/from_incremental', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    currentBookingIncrementalRestoreTaskId = data.task_id;
                    const messageType = data.success ? 'info' : 'error';
                    appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from incremental backups process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromIncremental);
                    if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')))) {
                        enablePageInteractions();
                    }
                })
                .catch(error => {
                    appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromIncremental);
                    enablePageInteractions();
                });
            });
        }
    });
</script>
{% endblock %}
