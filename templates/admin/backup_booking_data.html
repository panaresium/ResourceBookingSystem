{% extends "base.html" %}

{% block title %}{{ _("Booking Data Management") }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">{{ _("Booking Data Management") }}</h1>
    <p class="mb-4">{{ _("Manage backups and restore options for booking data. For full system backups, please visit the System Backup page.") }}</p>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shield-alt"></i> {{ _("Full System Backup & Restore") }}
                </div>
                <div class="card-body">
                    <p>{{ _("For comprehensive system backups that include all data (bookings, settings, users, etc.) and allow for full system restoration, please use the dedicated system backup utility.") }}</p>
                    <a href="{{ url_for('admin_ui.serve_backup_system_page') }}" class="btn btn-primary">{{ _("Go to System Backup & Restore") }}</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Current Server Time -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i> {{ _("Current Server Time") }}
                </div>
                <div class="card-body">
                    <p id="server-time">{{ _("Loading server time...") }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Records Export/Import Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-file-export"></i> {{ _("Booking Records Export & Import") }}</h4>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ _("Export all booking records to a JSON file or import records from a JSON file.") }}</p>

                    <h5>{{ _("Export Bookings") }}</h5>
                    <div class="mb-3">
                        <a href="{{ url_for('admin_ui.export_all_bookings_json') }}" class="btn btn-primary">{{ _("Export All Bookings (JSON)") }}</a>
                    </div>
                    <hr>

                    <h5>{{ _("Import Bookings") }}</h5>
                    <p>{{ _("Upload a JSON file containing booking records to import. Existing records with matching IDs will be updated.") }}</p>
                    <form action="{{ url_for('admin_ui.import_bookings_json') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="form-group">
                            <label for="bookingJsonFile">{{ _("Select JSON File") }}</label>
                            <input type="file" class="form-control-file" id="bookingJsonFile" name="file" accept=".json" required>
                        </div>
                        <button type="submit" class="btn btn-warning">{{ _("Import Bookings (JSON)") }}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Destructive Actions Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> {{ _("Destructive Actions") }}</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ _("These actions can lead to data loss if not used carefully. Ensure you have adequate backups before proceeding.") }}</p>
                    <!-- Clear All Booking Data -->
                    <div class="mt-3">
                        <h6>{{ _("Clear All Booking Data") }}</h6>
                        <p>{{ _("This will permanently delete all booking entries from the database. This action cannot be undone.") }}</p>
                        <button class="btn btn-danger" onclick="confirmClearAllBookingData()">{{ _("Clear All Booking Data Now") }}</button>
                        <small class="form-text text-muted mt-1">{{ _("Use with extreme caution.") }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modals -->
<div class="modal fade" id="confirmClearAllModal" tabindex="-1" role="dialog" style="display: none !important;"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">{{ _("Confirm Clear All Booking Data") }}</h5> <button type="button" class="close" data-dismiss="modal">&times;</button> </div> <div class="modal-body"> {{ _("Are you sure you want to permanently delete all booking data? This action cannot be undone.") }} </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button> <button type="button" class="btn btn-danger" onclick="executeClearAllBookingData()">{{ _("Clear All Data") }}</button> </div> </div> </div> </div>
<div class="modal fade" id="actionProgressModal" tabindex="-1" aria-labelledby="actionProgressModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionProgressModalLabel">Action in Progress</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="actionProgressMessage">Loading initial page data...</p>
                <div class="progress">
                    <div id="actionProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_backup_common.js') }}" defer></script>
<script>
    // Utility functions (showProgressModal, hideProgressModal, updateServerTime)
    function showProgressModal(message) { $('#actionProgressMessage').text(message); $('#actionProgressModal').modal({backdrop: 'static', keyboard: false}); }
    function hideProgressModal() { $('#actionProgressModal').modal('hide'); }

    function updateServerTime() {
        fetch("{{ url_for('api_system.ping') }}")
        .then(response => response.json())
        .then(data => {
            if(data.timestamp) {
                document.getElementById('server-time').textContent = "{{ _('Current Server Time (UTC):') }} " + data.timestamp;
            } else {
                document.getElementById('server-time').textContent = "{{ _('Could not load server time.') }}";
            }
        })
        .catch(error => {
            console.error("{{ _('Error fetching server time:') }}", error);
            document.getElementById('server-time').textContent = "{{ _('Error loading server time.') }}";
        });
    }

    function confirmClearAllBookingData() {
        $('#confirmClearAllModal').modal('show');
    }

    function executeClearAllBookingData() {
        $('#confirmClearAllModal').modal('hide');
        showProgressModal("{{ _('Clearing all booking data...') }}");
        fetch("{{ url_for('admin_ui.clear_all_bookings_data') }}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('All booking data has been cleared.') }}");
            } else {
                alert("{{ _('Error clearing booking data:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error clearing booking data.') }}");
            console.error(error);
        });
    }

    $(document).ready(function() {
        $('#confirmClearAllModal').css('display', 'none'); // Initial forceful hide via CSS

        // Persistent hiding logic
        let hideIntervalCount = 0;
        const hideModalInterval = setInterval(function() {
            const modalElement = document.getElementById('confirmClearAllModal');
            if (modalElement && (modalElement.style.display !== 'none' || $(modalElement).hasClass('show'))) {
                $(modalElement).modal('hide'); // Use Bootstrap's method
                // If Bootstrap's hide doesn't set display:none (e.g. during transition), force it.
                if (modalElement.style.display !== 'none') {
                     modalElement.style.setProperty('display', 'none', 'important');
                }
                console.log('Persistently attempting to hide confirmClearAllModal (JS interval)...');
            }
            hideIntervalCount++;
            if (hideIntervalCount >= 20) { // Try for 2 seconds (20 * 100ms)
                clearInterval(hideModalInterval);
                console.log('Persistent hide interval for confirmClearAllModal cleared.');
            }
        }, 100);

        updateServerTime(); setInterval(updateServerTime, 60000);

        // Check for flash messages and show alerts if needed (standard Flask behavior usually handles this in base.html,
        // but if we need specific handling here it can be added. For now relying on base.html)

        $('#actionProgressModal').on('hide.bs.modal', function (e) {
            $(e.target).blur();
            document.body.focus();
        });
    });
</script>
{% endblock %}
