{% extends "base.html" %}

{% block title %}{{ _("Booking Data Management") }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">{{ _("Booking Data Management") }}</h1>
    <p class="mb-4">{{ _("Manage backups and restore options for booking data. For full system backups, please visit the System Backup page.") }}</p>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shield-alt"></i> {{ _("Full System Backup & Restore") }}
                </div>
                <div class="card-body">
                    <p>{{ _("For comprehensive system backups that include all data (bookings, settings, users, etc.) and allow for full system restoration, please use the dedicated system backup utility.") }}</p>
                    <a href="{{ url_for('admin_ui.serve_backup_system_page') }}" class="btn btn-primary">{{ _("Go to System Backup & Restore") }}</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Current Server Time -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i> {{ _("Current Server Time") }}
                </div>
                <div class="card-body">
                    <p id="server-time">{{ _("Loading server time...") }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Azure JSON Booking Data Backups Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> {{ _("Unified Azure JSON Booking Data Backups") }}</h4>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ _("This is the recommended method for robust backup and point-in-time recovery of your booking data.") }}</p>
                    <div class="mb-3">
                        <button id="btnManualUnifiedBackup" class="btn btn-primary" onclick="manualUnifiedBackup()">{{ _("Run Manual Full JSON Backup Now") }}</button>
                        <button id="btnRefreshUnifiedList" class="btn btn-info" onclick="refreshUnifiedAzureBackupList()">{{ _("Refresh Backup List") }}</button>
                    </div>

                    <h5>{{ _("Restore from Unified Azure JSON Backup") }}</h5>
                    <div class="form-group">
                        <label for="selectUnifiedAzureBackup">{{ _("Select Backup to Restore (Point-in-Time):") }}</label>
                        <select id="selectUnifiedAzureBackup" class="form-control mb-2"></select>
                        <button id="btnRestoreFromUnifiedAzure" class="btn btn-warning" onclick="restoreSelectedUnifiedBackup()">{{ _("Restore Selected Backup") }}</button>
                    </div>
                    <hr>
                    <h5>{{ _("Manage Unified Azure JSON Backups") }}</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>{{ _("Backup Details (Display Name)") }}</th>
                                    <th>{{ _("Type") }}</th>
                                    <th>{{ _("Filename") }}</th>
                                    <th>{{ _("Timestamp (UTC)") }}</th>
                                    <th>{{ _("Actions") }}</th>
                                </tr>
                            </thead>
                            <tbody id="listManageAzureBackups">
                                <!-- Backup items will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Backup Schedule Settings Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-alt"></i> {{ _("Unified Backup Schedule Settings") }}</h4>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ _("Configure the schedule for automatic unified full and incremental backups. These settings determine when backups are created by the system scheduler.") }}</p>

                    <!-- Full Backup Sub-section -->
                    <h5>{{ _("Full Backup Schedule") }}</h5>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="unified_full_enabled">
                            <label class="form-check-label" for="unified_full_enabled">{{ _("Enable Scheduled Full Backup") }}</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="unified_full_schedule_type">{{ _("Schedule Type") }}</label>
                            <select id="unified_full_schedule_type" class="form-control">
                                <option value="daily">{{ _("Daily") }}</option>
                                <option value="weekly">{{ _("Weekly") }}</option>
                                <option value="monthly">{{ _("Monthly") }}</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="unified_full_time_of_day">{{ _("Time of Day (UTC)") }}</label>
                            <input type="time" class="form-control" id="unified_full_time_of_day" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4" id="unified_full_day_of_week_group" style="display: none;">
                            <label for="unified_full_day_of_week">{{ _("Day of Week") }}</label>
                            <select id="unified_full_day_of_week" class="form-control">
                                <option value="0">{{ _("Monday") }}</option>
                                <option value="1">{{ _("Tuesday") }}</option>
                                <option value="2">{{ _("Wednesday") }}</option>
                                <option value="3">{{ _("Thursday") }}</option>
                                <option value="4">{{ _("Friday") }}</option>
                                <option value="5">{{ _("Saturday") }}</option>
                                <option value="6">{{ _("Sunday") }}</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4" id="unified_full_day_of_month_group" style="display: none;">
                            <label for="unified_full_day_of_month">{{ _("Day of Month") }}</label>
                            <input type="number" class="form-control" id="unified_full_day_of_month" min="1" max="31">
                        </div>
                    </div>
                    <hr>

                    <!-- Incremental Backup Sub-section -->
                    <h5>{{ _("Incremental Backup Schedule") }}</h5>
                     <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="unified_incremental_enabled">
                            <label class="form-check-label" for="unified_incremental_enabled">{{ _("Enable Scheduled Incremental Backup") }}</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="unified_incremental_interval_minutes">{{ _("Interval (minutes)") }}</label>
                            <input type="number" class="form-control" id="unified_incremental_interval_minutes" min="1">
                            <small class="form-text text-muted">{{ _("How often to run the incremental backup. E.g., 30 for every 30 minutes.") }}</small>
                        </div>
                    </div>
                    <hr>

                    <button id="saveUnifiedBackupScheduleBtn" class="btn btn-success">{{ _("Save Schedule Settings") }}</button>
                    <div id="unifiedScheduleFeedback" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legacy & Other Booking Data Operations - Section Removed -->

    <!-- Restore Booking Data Section (Non-CSV Legacy/Other Methods) -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-undo-alt"></i> {{ _("Restore Booking Data (Other Methods)") }}</h5>
                </div>
                <div class="card-body">
                    <p>{{ _("Restore booking data from available backups using methods other than the primary Unified Azure JSON system. The Unified Azure JSON Backup section provides more robust point-in-time recovery.") }}</p>

                    <div class="card mb-3">
                        <div class="card-header"> {{ _("Restore Bookings from Full System Backup") }} </div>
                        <div class="card-body">
                            <p>{{ _("Select a full system backup from Azure to restore its booking data. This will overwrite existing bookings.") }}</p>
                            <div class="form-group">
                                <label for="full-backup-system-list">{{ _("Available Full System Backups (on Azure)") }}</label>
                                <select id="full-backup-system-list" class="form-control"></select>
                            </div>
                            <button class="btn btn-primary" onclick="restoreBookingsFromFullSystemBackup()">{{ _("Restore Bookings from Selected System Backup") }}</button>
                            <button class="btn btn-info" onclick="loadFullBackupsForRestore()">{{ _("Refresh List") }}</button>
                        </div>
                    </div>

                    <!-- CSV Restore Section Removed -->

                    <div class="card mb-3">
                        <div class="card-header"> {{ _("Restore Bookings from Incremental Backups (JSON - Legacy/Other)") }} </div>
                        <div class="card-body">
                            <p><em>{{ _("Placeholder: Functionality to restore from legacy or other non-unified incremental JSON backups would be here. The Unified Azure JSON system is the primary method for incremental restores.") }}</em></p>
                            <!-- Example:
                            <div class="form-group">
                                <label for="incremental-json-backup-list">{{ _("Available Incremental JSON Backups (Legacy)") }}</label>
                                <select id="incremental-json-backup-list" class="form-control" disabled></select>
                            </div>
                            <button class="btn btn-outline-primary" disabled>{{ _("Restore from Selected Legacy Incremental JSON") }}</button>
                            <button class="btn btn-outline-info" disabled>{{ _("Refresh Legacy Incremental List") }}</button>
                            -->
                        </div>
                    </div>
                     <!-- Destructive Actions -->
                    <hr>
                    <h5>{{ _("Destructive Actions") }}</h5>
                    <button class="btn btn-danger" onclick="confirmClearAllBookingData()">{{ _("Clear All Booking Data") }}</button>
                    <small class="form-text text-muted">{{ _("This will permanently delete all booking entries from the database. Use with extreme caution.") }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Booking CSV Backups Table (Legacy) - Section Removed -->
</div>

<!-- Modals -->
<div class="modal fade" id="confirmClearAllModal" tabindex="-1" role="dialog"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">{{ _("Confirm Clear All Booking Data") }}</h5> <button type="button" class="close" data-dismiss="modal">&times;</button> </div> <div class="modal-body"> {{ _("Are you sure you want to permanently delete all booking data? This action cannot be undone.") }} </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button> <button type="button" class="btn btn-danger" onclick="executeClearAllBookingData()">{{ _("Clear All Data") }}</button> </div> </div> </div> </div>
<div class="modal fade" id="actionProgressModal" tabindex="-1" role="dialog" aria-labelledby="actionProgressModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="actionProgressModalLabel">{{ _("Action in Progress") }}</h5> </div> <div class="modal-body"> <p id="actionProgressMessage">{{ _("Please wait...") }}</p> <div class="progress"> <div id="actionProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div> </div> </div> </div> </div> </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_backup_common.js') }}" defer></script>
<script>
    // Task ID variables for polling
    let currentManualUnifiedBackupTaskId = null;
    let currentRestoreBookingsFullSysTaskId = null;
    // currentSelectiveRestoreTaskId is assumed to be available from admin_backup_common.js
    // along with pollTaskStatus, activePolls, displayedLogCounts,
    // showTaskProgressModal, hideTaskProgressModal, disablePageInteractions, enablePageInteractions.

    // Utility functions (showProgressModal, hideProgressModal, updateServerTime)
    // For this refactor, we keep the local showProgressModal/hideProgressModal,
    // but disablePageInteractions will be called explicitly.
    function showProgressModal(message) { $('#actionProgressMessage').text(message); $('#actionProgressModal').modal({backdrop: 'static', keyboard: false}); }
    function hideProgressModal() { $('#actionProgressModal').modal('hide'); }
    function updateServerTime() {
        fetch("{{ url_for('api_system.ping') }}")
        .then(response => response.json())
        .then(data => {
            if(data.timestamp) {
                document.getElementById('server-time').textContent = "{{ _('Current Server Time (UTC):') }} " + data.timestamp;
            } else {
                document.getElementById('server-time').textContent = "{{ _('Could not load server time.') }}";
            }
        })
        .catch(error => {
            console.error("{{ _('Error fetching server time:') }}", error);
            document.getElementById('server-time').textContent = "{{ _('Error loading server time.') }}";
        });
    }


    // --- Unified Azure JSON Backups ---
    // All functions (refreshUnifiedAzureBackupList, populateUnifiedBackupSelect, renderUnifiedBackupListForManagement,
    // manualUnifiedBackup, restoreSelectedUnifiedBackup, deleteUnifiedBackup) remain unchanged from the previous version.
    // For brevity, their full code is not repeated here.
    function refreshUnifiedAzureBackupList() {
        // showProgressModal("{{ _('Loading Unified Azure JSON backups list...') }}"); // Removed
        fetch("{{ url_for('api_system.api_list_booking_data_backups') }}")
            .then(response => response.json())
            .then(data => {
                // hideProgressModal(); // Removed
                if (data.success && data.backups) {
                    populateUnifiedBackupSelect(data.backups);
                    renderUnifiedBackupListForManagement(data.backups);
                } else {
                    alert("{{ _('Error loading Unified Azure JSON backups:') }} " + (data.message || "{{ _('Unknown error') }}"));
                    populateUnifiedBackupSelect([]);
                    renderUnifiedBackupListForManagement([]);
                }
            })
            .catch(error => {
                // hideProgressModal(); // Removed
                console.error("{{ _('Error fetching Unified Azure JSON backups list:') }}", error);
                alert("{{ _('Error fetching Unified Azure JSON backups list.') }}");
                populateUnifiedBackupSelect([]); renderUnifiedBackupListForManagement([]);
            })
            .finally(() => { // Simulating finally
                loadFullBackupsForRestore();
            });
    }

    function populateUnifiedBackupSelect(backups) {
        const select = $('#selectUnifiedAzureBackup');
        select.empty();
        if (backups && backups.length > 0) {
            backups.forEach(backup => {
                select.append($('<option>', {
                    value: backup.filename,
                    text: backup.display_name,
                    'data-type': backup.type,
                    'data-timestamp': backup.timestamp_str // ISO string from backend
                }));
            });
        } else {
            select.append($('<option>', { text: "{{ _('No Unified Azure JSON backups found') }}" }));
        }
    }

    function renderUnifiedBackupListForManagement(backups) {
        const tableBody = $('#listManageAzureBackups');
        tableBody.empty();
        if (backups && backups.length > 0) {
            backups.forEach(backup => {
                let actionsHtml = `
                    <button class="btn btn-sm btn-success mr-1" onclick="downloadUnifiedBackup('${backup.filename}', '${backup.type}')" title="{{ _('Download this backup') }}"><i class="fas fa-download"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUnifiedBackup('${backup.filename}', '${backup.type}')" title="{{ _('Delete this backup') }}"><i class="fas fa-trash"></i></button>`;
                tableBody.append(`
                    <tr>
                        <td>${backup.display_name}</td>
                        <td>${backup.type.charAt(0).toUpperCase() + backup.type.slice(1)}</td>
                        <td>${backup.filename}</td>
                        <td>${backup.timestamp_str ? new Date(backup.timestamp_str).toLocaleString() : 'N/A'}</td>
                        <td>${actionsHtml}</td>
                    </tr>`);
            });
        } else {
            tableBody.append(`<tr><td colspan="5" class="text-center">{{ _("No Unified Azure JSON backups found.") }}</td></tr>`);
        }
    }

    function manualUnifiedBackup() {
        if (!confirm("{{ _('Are you sure you want to run a manual full JSON backup now? This may take some time.') }}")) return;
        showProgressModal("{{ _('Starting manual full Unified Azure JSON backup...') }}");
        disablePageInteractions(); // Disable UI

        fetch("{{ url_for('api_system.api_manual_booking_data_backup_json') }}", {
            method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        }).then(response => response.json()).then(data => {
            if (data.success && data.task_id) {
                const statusEl = document.getElementById('actionProgressMessage');
                statusEl.textContent = "{{ _('Manual backup task started. Task ID:') }} " + data.task_id;
                currentManualUnifiedBackupTaskId = data.task_id;
                if (activePolls[data.task_id]) clearInterval(activePolls[data.task_id]);
                displayedLogCounts[data.task_id] = 0;
                pollTaskStatus(data.task_id, null, statusEl, 'manual_unified_booking_backup');
                // hideProgressModal will be called by pollTaskStatus logic via enablePageInteractions
            } else {
                throw new Error(data.message || "{{ _('Unknown error starting manual backup.') }}");
            }
        }).catch(error => {
            hideProgressModal();
            alert("{{ _('Error starting manual backup:') }} " + error.message);
            enablePageInteractions(); // Re-enable UI on fetch error
        });

        // Socket.IO event handler removed
    }

    function restoreSelectedUnifiedBackup() {
        const selectedOption = $('#selectUnifiedAzureBackup option:selected');
        const backupFilename = selectedOption.val();
        const backupType = selectedOption.data('type');
        const backupTimestampIso = selectedOption.data('timestamp');

        if (!backupFilename || backupFilename === "{{ _('No Unified Azure JSON backups found') }}") { alert("{{ _('Please select a backup.') }}"); return; }
        if (!backupType || !backupTimestampIso) { alert("{{ _('Selected backup missing type/timestamp.') }}"); return; }

        let confirmMsg = `{{ _('Restore from backup') }} '${backupFilename}' (${backupType}, ${new Date(backupTimestampIso).toLocaleString()})? `;
        confirmMsg += (backupType === 'full') ? `{{ _('This ERAASES current data.') }}` : `{{ _('This applies changes to current data.') }}`;
        if (!confirm(confirmMsg + ` {{ _('Cannot be undone.') }}`)) return;

        showProgressModal(`{{ _('Starting restore from') }} ${backupFilename}...`);
        disablePageInteractions(); // Disable UI

        fetch("{{ url_for('api_system.api_unified_booking_data_point_in_time_restore') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ filename: backupFilename, backup_type: backupType, backup_timestamp_iso: backupTimestampIso })
        }).then(response => response.json()).then(data => {
            if (data.success && data.task_id) {
                const statusEl = document.getElementById('actionProgressMessage');
                let initialMsg = (data.summary && data.summary.message) ? data.summary.message : "{{ _('Restore task started...') }}";
                statusEl.textContent = `{{ _('Task ID:') }} ${data.task_id}. ${initialMsg}`;

                currentSelectiveRestoreTaskId = data.task_id; // Assuming this var is from admin_backup_common.js
                if (activePolls[data.task_id]) clearInterval(activePolls[data.task_id]);
                displayedLogCounts[data.task_id] = 0;
                pollTaskStatus(data.task_id, null, statusEl, 'unified_booking_data_restore');
            } else if (data.summary && data.summary.status === 'failure') {
                throw new Error(data.summary.message || `{{ _('Failed to start restore task.') }}`);
            } else {
                throw new Error(data.message || `{{ _('Unknown error starting restore task.') }}`);
            }
        }).catch(error => {
            hideProgressModal();
            alert("{{ _('Error starting restore:') }} " + error.message);
            enablePageInteractions(); // Re-enable UI on fetch error
        });

        // Socket.IO event handler removed
    }

    function deleteUnifiedBackup(filename, backupType) {
        if (!confirm(`{{ _('Delete backup') }} '${filename}' (Type: ${backupType})? {{ _('Cannot be undone.') }}`)) return;
        showProgressModal(`{{ _('Deleting backup') }} ${filename}...`);
        fetch("{{ url_for('api_system.api_delete_booking_data_backup') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: filename, backup_type: backupType })
        }).then(response => response.json()).then(data => {
            hideProgressModal();
            if (data.success) { alert("{{ _('Backup deleted.') }}"); refreshUnifiedAzureBackupList(); }
            else { alert("{{ _('Error deleting backup:') }} " + (data.message || "{{ _('Unknown error') }}")); }
        }).catch(error => { hideProgressModal(); alert("{{ _('Error deleting backup.') }}"); console.error(error); });
    }

    // --- Legacy and Other Restore/Backup Functions ---
    // Note: All CSV related JS functions have been removed.
    // Functions like loadFullBackupsForRestore, restoreBookingsFromFullSystemBackup,
    // confirmClearAllBookingData, executeClearAllBookingData remain if they handle non-CSV operations.

    function loadFullBackupsForRestore() {
        // This function is now the last step in the initial data loading chain started by refreshUnifiedAzureBackupList.
        // The initial showProgressModal is in $(document).ready().
        fetch("{{ url_for('api_system.api_list_backups') }}")
            .then(response => response.json())
            .then(data => {
                const select = $('#full-backup-system-list');
                select.empty();
                if (data.success && data.backups && data.backups.length > 0) {
                    data.backups.forEach(backup => {
                        let displayName = backup.filename || backup.timestamp_str || backup.timestamp; // Ensure some display name
                        if (backup.timestamp_str) { // Prefer formatted timestamp if available
                             try { displayName = `${new Date(backup.timestamp_str).toLocaleString()} (${backup.filename})`; }
                             catch(e) { console.warn("Error parsing timestamp_str:", backup.timestamp_str, e); }
                        }
                        select.append($('<option>', { value: backup.filename, text: displayName }));
                    });
                } else {
                    select.append($('<option>', { text: data.message || "{{ _('No full system backups found') }}" }));
                     if (!data.success) alert("{{ _('Error loading full system backups for restore list:') }} " + (data.message || "{{ _('Unknown error') }}"));
                }
            })
            .catch(error => {
                console.error("{{ _('Error fetching full system backups list for restore:') }}", error);
                alert("{{ _('Error fetching full system backups list for restore.') }}");
                const select = $('#full-backup-system-list');
                select.empty();
                select.append($('<option>', { text: "{{ _('Error loading backups') }}" }));
            })
            .finally(() => {
                // This is now the final step of the initial data loading chain.
                hideProgressModal();
            });
    }

    function restoreBookingsFromFullSystemBackup() {
        const selectedBackup = $('#full-backup-system-list').val();
        if (!selectedBackup || selectedBackup === "{{ _('No full system backups found') }}") {
            alert("{{ _('Please select a system backup to restore bookings from.') }}");
            return;
        }
        if (!confirm("{{ _('Are you sure you want to restore bookings from the system backup') }} '" + selectedBackup + "'? {{ _('This will overwrite current booking data. This action cannot be undone.') }}")) {
            return;
        }
        showProgressModal("{{ _('Restoring bookings from system backup...') }}");
        disablePageInteractions(); // Disable UI

        fetch("{{ url_for('api_system.api_restore_bookings_from_full_db') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: selectedBackup })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                const statusEl = document.getElementById('actionProgressMessage');
                statusEl.textContent = "{{ _('Restore bookings from full system backup task started. Task ID:') }} " + data.task_id;
                currentRestoreBookingsFullSysTaskId = data.task_id;
                if (activePolls[data.task_id]) clearInterval(activePolls[data.task_id]);
                displayedLogCounts[data.task_id] = 0;
                pollTaskStatus(data.task_id, null, statusEl, 'restore_bookings_from_full_system_backup');
            } else {
                hideProgressModal();
                alert("{{ _('Error starting restore bookings task:') }} " + (data.message || "{{ _('Unknown error.') }}"));
                enablePageInteractions(); // Re-enable UI on error
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error during restore from system backup.') }}");
            console.error(error);
            enablePageInteractions(); // Re-enable UI on fetch error
        });
    }

    // Removed: loadCsvBackupsForRestore
    // Removed: restoreBookingsFromCsvBackup
    // Removed: deleteCsvBackup
    // Removed: loadLegacyCsvBackups
    // Removed: renderLegacyCsvPagination
    // Removed: directRestoreFromCsv
    // Removed: directDeleteCsv

    function confirmClearAllBookingData() {
        $('#confirmClearAllModal').modal('show');
    }

    function executeClearAllBookingData() {
        $('#confirmClearAllModal').modal('hide');
        showProgressModal("{{ _('Clearing all booking data...') }}");
        fetch("{{ url_for('admin_ui.clear_all_bookings_data') }}", { // Ensure this API endpoint is correct
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('All booking data has been cleared.') }}");
            } else {
                alert("{{ _('Error clearing booking data:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error clearing booking data.') }}");
            console.error(error);
        });
    }

    $(document).ready(function() {
        updateServerTime(); setInterval(updateServerTime, 60000);

        showProgressModal("{{ _('Loading initial page data...') }}");

        // Unified Azure JSON Backups - This will start the chain.
        // refreshUnifiedAzureBackupList calls loadFullBackupsForRestore in its finally block.
        // loadFullBackupsForRestore will now call hideProgressModal in its finally block,
        // effectively ending the initial data load sequence.
        refreshUnifiedAzureBackupList();

        // Load Unified Backup Schedule Settings - this happens in parallel / independently.
        loadUnifiedBackupSchedule();

        $('#actionProgressModal').on('hide.bs.modal', function () {
            // Explicitly move focus to the body before the modal is hidden
            // to prevent aria-hidden conflicts if the modal or its content had focus.
            document.body.focus();
        });

        // Attach event listeners for new schedule section
        $('#unified_full_schedule_type').on('change', handleScheduleTypeChange);
        $('#saveUnifiedBackupScheduleBtn').on('click', saveUnifiedBackupSchedule);


        // Check if socket event for manualUnifiedBackup needs correction.
        // It was 'booking_data_protection_backup_progress', changed to 'full_booking_data_backup_progress'.
        // This might be specific to the type of backup (full vs incremental) if those events differ.
        // For now, assuming 'full_booking_data_backup_progress' is correct for the manual full backup.
        // The incremental backup process (if it has a manual trigger and separate event) would need its own handler.
    });

    // --- Unified Backup Schedule JS ---

    function downloadUnifiedBackup(filename, backupType) {
        // Construct the download URL using placeholders and replacing them
        // This is a robust way to handle URL generation in JS when url_for needs dynamic parts.
        let downloadUrlTemplate = "{{ url_for('api_system.api_download_booking_data_backup', backup_type='TYPE_PLACEHOLDER', filename='FILENAME_PLACEHOLDER') }}";
        let downloadUrl = downloadUrlTemplate
            .replace('TYPE_PLACEHOLDER', encodeURIComponent(backupType))
            .replace('FILENAME_PLACEHOLDER', encodeURIComponent(filename));

        console.log(`Attempting to download: ${downloadUrl}`);
        // Trigger the download by navigating to the URL
        window.location.href = downloadUrl;
        // Note: Error handling for this direct navigation approach is limited.
        // The browser will handle the download or display an error page if the URL fails.
        // For more sophisticated error handling (e.g., via fetch and Blob), the backend would need to avoid direct 'attachment' disposition
        // or the client-side would need to handle the blob response. This method is simpler for direct downloads.
    }

    function handleScheduleTypeChange() {
        const type = $('#unified_full_schedule_type').val();
        $('#unified_full_day_of_week_group').toggle(type === 'weekly');
        $('#unified_full_day_of_month_group').toggle(type === 'monthly');
    }

    function loadUnifiedBackupSchedule() {
        console.log("Loading unified backup schedule settings...");
        fetch("{{ url_for('api_system.get_unified_backup_schedule') }}")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`{{ _('Network response was not ok:') }} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received schedule data:", data);
                if (data.error) {
                    throw new Error(data.error);
                }
                // Full Backup
                $('#unified_full_enabled').prop('checked', data.unified_full_backup.is_enabled);
                $('#unified_full_schedule_type').val(data.unified_full_backup.schedule_type);
                $('#unified_full_time_of_day').val(data.unified_full_backup.time_of_day);
                if (data.unified_full_backup.day_of_week !== null) {
                    $('#unified_full_day_of_week').val(data.unified_full_backup.day_of_week);
                }
                if (data.unified_full_backup.day_of_month !== null) {
                    $('#unified_full_day_of_month').val(data.unified_full_backup.day_of_month);
                }

                // Incremental Backup
                $('#unified_incremental_enabled').prop('checked', data.unified_incremental_backup.is_enabled);
                $('#unified_incremental_interval_minutes').val(data.unified_incremental_backup.interval_minutes);

                handleScheduleTypeChange(); // Update visibility of day/month fields
                $('#unifiedScheduleFeedback').html(`<div class="alert alert-info mt-2">{{ _('Schedule settings loaded.') }}</div>`);
            })
            .catch(error => {
                console.error("{{ _('Error loading unified backup schedule:') }}", error);
                $('#unifiedScheduleFeedback').html(`<div class="alert alert-danger mt-2">{{ _('Error loading schedule settings:') }} ${error.message}</div>`);
            });
    }

    function saveUnifiedBackupSchedule() {
        const feedbackDiv = $('#unifiedScheduleFeedback');
        feedbackDiv.html(''); // Clear previous feedback

        // Full Backup Data
        const fullEnabled = $('#unified_full_enabled').is(':checked');
        const fullScheduleType = $('#unified_full_schedule_type').val();
        const fullTimeOfDay = $('#unified_full_time_of_day').val();
        let fullDayOfWeek = null;
        if (fullScheduleType === 'weekly') {
            fullDayOfWeek = parseInt($('#unified_full_day_of_week').val());
            if (isNaN(fullDayOfWeek) || fullDayOfWeek < 0 || fullDayOfWeek > 6) {
                feedbackDiv.html(`<div class="alert alert-danger">{{ _('Invalid day of week for full backup.') }}</div>`);
                return;
            }
        }
        let fullDayOfMonth = null;
        if (fullScheduleType === 'monthly') {
            fullDayOfMonth = parseInt($('#unified_full_day_of_month').val());
            if (isNaN(fullDayOfMonth) || fullDayOfMonth < 1 || fullDayOfMonth > 31) {
                feedbackDiv.html(`<div class="alert alert-danger">{{ _('Invalid day of month for full backup.') }}</div>`);
                return;
            }
        }
        // Validate time format HH:MM
        if (!/^\d{2}:\d{2}$/.test(fullTimeOfDay)) {
             feedbackDiv.html(`<div class="alert alert-danger">{{ _('Invalid time format for full backup. Use HH:MM.') }}</div>`);
            return;
        }

        // Incremental Backup Data
        const incrementalEnabled = $('#unified_incremental_enabled').is(':checked');
        const incrementalIntervalMinutes = parseInt($('#unified_incremental_interval_minutes').val());
        if (incrementalEnabled && (isNaN(incrementalIntervalMinutes) || incrementalIntervalMinutes < 1)) {
            feedbackDiv.html(`<div class="alert alert-danger">{{ _('Invalid interval for incremental backup. Must be a positive number.') }}</div>`);
            return;
        }

        const payload = {
            "unified_full_backup": {
                "is_enabled": fullEnabled,
                "schedule_type": fullScheduleType,
                "time_of_day": fullTimeOfDay,
                "day_of_week": fullDayOfWeek,
                "day_of_month": fullDayOfMonth
            },
            "unified_incremental_backup": {
                "is_enabled": incrementalEnabled,
                "interval_minutes": incrementalEnabled ? incrementalIntervalMinutes : 30 // Send default if disabled
            }
        };
        console.log("Saving unified backup schedule:", payload);

        fetch("{{ url_for('api_system.update_unified_backup_schedule') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                feedbackDiv.html(`<div class="alert alert-success mt-2">${data.message || "{{ _('Schedule settings saved successfully.') }}"}</div>`);
            } else {
                feedbackDiv.html(`<div class="alert alert-danger mt-2">${data.message || "{{ _('Error saving schedule settings.') }}"}</div>`);
            }
        })
        .catch(error => {
            console.error("{{ _('Error saving unified backup schedule:') }}", error);
            feedbackDiv.html(`<div class="alert alert-danger mt-2">{{ _('Error saving schedule settings:') }} ${error.message}</div>`);
        });
    }

</script>
{% endblock %}
