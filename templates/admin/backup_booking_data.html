{% extends "base.html" %}

{% block title %}{{ _('Admin - Booking Data Management') }}{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js" integrity="sha512-skuhu6jj+sQnhLq1Txsack8VfnIrX8wL+MTFilYlFFT/NuLJm7eya7zOROs39Jy5cjASMEWqxLzijRVmKhsqWQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
    .log-area {
        max-height: 200px;
        overflow-y: auto;
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9em;
    }
    .log-entry {
        padding: 2px 0;
    }
    .log-error {
        color: red;
        font-weight: bold;
    }
    .log-success {
        color: green;
        font-weight: bold;
    }
    .log-info {
        color: #333;
    }
    /* Styles for DB Records View */
    .db-table-container {
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
    }
    .db-records-content pre {
        background-color: #f8f9fa; /* Light background for pre */
        padding: 10px;
        border-radius: 4px;
        max-height: 300px; /* Max height for individual record lists */
        overflow-y: auto;
    }
    /* Style for active (expanded) button */
    #view-db-records-output .btn.active {
        background-color: #007bff;
        color: white;
    }
    .tab-content > .tab-pane {
        padding-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ _('Booking Data Management') }}</h1>
    <hr>
    <p>{{ _('Current Server Time:') }} <span id="utc-clock" data-offset="{{ global_time_offset_hours | default(0) }}">Loading...</span></p>
    <hr>
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i> {{ _('For Full System Backup & Restore operations (including database, configurations, and media files), please visit the') }} <a href="{{ url_for('admin_ui.serve_backup_system_page') }}" class="alert-link">{{ _('System Backup Page') }}</a>.
    </div>
    <hr>

    <!-- Restore Booking Data Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Restore Booking Data') }}</h2>
        </div>
        <div class="card-body">
            <p>{{_('These options allow restoring only booking data from different backup types, leaving other system configurations and media files untouched. Select the appropriate source based on your needs.')}}</p>

            <!-- Restore Bookings from Full System Backup -->
            <section id="restore-bookings-from-full-db-section" class="mb-3 p-3 border rounded">
                <h5>{{ _('Restore Bookings from Full System Backup') }}</h5>
                <p>{{_('Use this to restore booking data from a specific full system backup. This is useful if you need to revert bookings to a state captured in a complete system snapshot.')}}</p>
                <div class="alert alert-warning" role="alert">
                    <strong>{{ _('Warning:') }}</strong> {{ _('This will delete ALL current bookings and replace them with the bookings from the selected full system backup.') }}
                </div>
                <div class="form-group mb-2">
                    <label for="selectFullBackupForBookingRestore">{{ _('Select Full System Backup Timestamp:') }}</label>
                    <select id="selectFullBackupForBookingRestore" class="form-control form-select"></select>
                </div>
                <button id="btnRestoreBookingsFromFullDb" class="btn btn-warning mt-2">{{ _('Restore Bookings from Full System Backup') }}</button>
                <div id="statusRestoreBookingsFromFullDb" class="mt-2"></div>
            </section>
            <hr>

            <!-- Restore Bookings from CSV Backup (JS driven) -->
            <section id="restore-bookings-from-csv-js-section" class="mb-3 p-3 border rounded">
                <h5>{{ _('Restore Bookings from Specific CSV Backup') }}</h5>
                <p>{{ _('Restore bookings from a manually or previously scheduled CSV export. This typically adds or updates bookings based on the CSV content and the system\'s import logic. Useful for migrating data or recovering from specific CSVs.') }}</p>
                <div class="form-group mb-2">
                    <label for="selectCsvBackupForBookingRestore">{{ _('Select CSV Backup:') }}</label>
                    <select id="selectCsvBackupForBookingRestore" class="form-control form-select"></select>
                </div>
                <button id="btnRestoreBookingsFromCsv" class="btn btn-info mt-2">{{ _('Restore Bookings from Selected CSV') }}</button>
                <div id="statusRestoreBookingsFromCsv" class="mt-2"></div>
            </section>
            <hr>

            <!-- Restore Bookings from Incremental Backups (JSON) -->
            <section id="restore-bookings-from-incremental-section" class="mb-3 p-3 border rounded">
                <h5>{{ _('Restore Bookings from Incremental Backups (JSON)') }}</h5>
                <p>{{ _('Applies all available incremental booking backups (JSON format) sequentially to update booking records. This is the preferred method for bringing bookings up-to-date from scheduled incremental backups.') }}</p>
                <div class="form-group mb-2">
                    <label>{{ _('Available Incremental JSON Backups:') }}</label>
                    <div id="incrementalBackupsList" class="log-area" style="max-height: 150px;"><em>{{ _('Loading incremental backups list...') }}</em></div>
                </div>
                <button id="btnRestoreBookingsFromIncremental" class="btn btn-success mt-2">{{ _('Apply Incremental Backups (JSON)') }}</button>
                <div id="statusRestoreBookingsFromIncremental" class="mt-2"></div>
            </section>
            <hr>

            <!-- Restore Bookings from Full JSON Export -->
            <section id="restore-bookings-from-full-json-section" class="mb-3 p-3 border rounded">
                <h5>{{ _('Restore Bookings from Full JSON Export (Azure)') }}</h5>
                <p>{{_('Select a full JSON export file previously created using the "Manual Booking JSON Operations".')}}</p>
                <div class="alert alert-danger" role="alert">
                    <strong>{{ _('WARNING:') }}</strong> {{ _('This will delete ALL current bookings and replace them with bookings from the selected file. This action is irreversible.') }}
                </div>
                <div class="form-group mb-2">
                    <label for="selectFullJsonExportForRestore">{{ _('Select Full JSON Export:') }}</label>
                    <select id="selectFullJsonExportForRestore" class="form-control form-select">
                        <option value="">{{ _('Loading...') }}</option>
                    </select>
                </div>
                <button id="btnRestoreFromFullJsonExport" class="btn btn-danger mt-2">{{ _('Restore from Selected JSON Export') }}</button>
                <div id="statusRestoreFromFullJsonExport" class="mt-2"></div>
            </section>

        </div>
    </div> <!-- End Restore Booking Data Card -->

    <!-- Scheduled Backups Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Scheduled Backups') }}</h2>
        </div>
        <div class="card-body">
            <p>{{ _('Configure automated backups for your booking data. It is recommended to enable scheduled incremental JSON backups for robust data protection.') }}</p>

            <section id="scheduled-csv-backups" class="mb-3 p-3 border rounded">
                <h5>{{ _('Scheduled Booking CSV Export (Legacy/External Use)') }}</h5>
                <p><small>{{ _('Configure scheduled exports of booking data in CSV format to Azure, primarily for use with external tools or archival. For data integrity and system restore, prefer scheduled incremental JSON backups.') }}</small></p>
                <form method="POST" action="{{ url_for('admin_ui.save_booking_data_schedule_settings') }}" id="booking-csv-schedule-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="booking_csv_backup_enabled" name="booking_csv_backup_enabled" value="true" {% if booking_csv_backup_settings.is_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="booking_csv_backup_enabled">{{ _('Enable Scheduled Booking CSV Backups') }}</label>
                    </div>
                    <div class="form-group mb-2">
                        <label for="booking_csv_backup_interval_minutes">{{ _('Backup Interval (minutes) for CSV') }}</label>
                        <input type="number" class="form-control" id="booking_csv_backup_interval_minutes" name="booking_csv_backup_interval_minutes" value="{{ booking_csv_backup_settings.interval_minutes | default(1440) }}" min="1" required>
                    </div>
                    <!-- Note: The following 'booking_backup_type_select' and related range might be deprecated or simplified if CSV is only 'full_export' -->
                    <div class="form-group mb-2" id="booking_csv_backup_range_type_group">
                        <label for="booking_csv_backup_range_type">{{ _('Data Range for CSV Export') }}</label>
                        <select id="booking_csv_backup_range_type" name="booking_csv_backup_range_type" class="form-control form-select">
                            <option value="all" {% if booking_csv_backup_settings.range == 'all' %}selected{% endif %}>{{ _('All Bookings') }}</option>
                            <option value="1day" {% if booking_csv_backup_settings.range == '1day' %}selected{% endif %}>{{ _('Last 1 Day') }}</option>
                            <option value="3days" {% if booking_csv_backup_settings.range == '3days' %}selected{% endif %}>{{ _('Last 3 Days') }}</option>
                            <option value="7days" {% if booking_csv_backup_settings.range == '7days' %}selected{% endif %}>{{ _('Last 7 Days') }}</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> {{ _('Save CSV Schedule Settings') }}</button>
                </form>
            </section>
            <hr>
            <section id="scheduled-json-incremental-backups" class="mb-3 p-3 border rounded">
                <h5>{{ _('Scheduled Incremental JSON Backups') }}</h5>
                <p>{{_('Configure periodic incremental backups of booking data in JSON format. This is the recommended approach for reliable and efficient data protection, offering minutely granularity.')}}</p>
                <form method="POST" action="{{ url_for('admin_ui.save_booking_incremental_json_schedule_settings') }}" id="json-incremental-schedule-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="booking_incremental_json_enabled" name="booking_incremental_json_enabled" value="true" {% if booking_incremental_json_schedule_settings.is_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="booking_incremental_json_enabled">{{ _('Enable Scheduled Incremental JSON Backups') }}</label>
                    </div>
                    <div class="form-group mb-2">
                        <label for="booking_incremental_json_interval_minutes">{{ _('Backup Interval (minutes) for Incremental JSON') }}</label>
                        <input type="number" class="form-control" id="booking_incremental_json_interval_minutes" name="booking_incremental_json_interval_minutes" value="{{ booking_incremental_json_schedule_settings.interval_minutes | default(30) }}" min="1" required>
                        <small class="form-text text-muted">{{ _('Enter a positive integer (e.g., 30 for 30 minutes).') }}</small>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> {{ _('Save Incremental JSON Schedule') }}</button>
                </form>
            </section>
        </div>
    </div> <!-- End Scheduled Backups Card -->

    <!-- Manual Operations Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title h5">{{ _('Manual Booking Data Operations') }}</h2>
        </div>
        <div class="card-body">
            <p>{{ _('Perform on-demand operations such as exporting, importing, or backing up booking data. Use these tools for specific administrative tasks or migrations.') }}</p>

            <section id="manual-csv-operations" class="mb-3 p-3 border rounded">
                <h5>{{ _('Manual Booking CSV Operations (Legacy)') }}</h5>
                <p>{{ _('Manually create a CSV export of bookings, or import bookings from a CSV file. Also manage existing CSV backups stored in Azure.') }}</p>

                <h6>{{_('Create or Export CSV')}}</h6>
                <form method="POST" action="{{ url_for('admin_ui.manual_backup_bookings_csv_route') }}" class="mb-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <label class="sr-only" for="booking_backup_range_manual">{{ _('Select Backup Range') }}</label>
                            <select class="custom-select mr-sm-2" id="booking_backup_range_manual" name="backup_range_type">
                                <option value="all" selected>{{ _('All Bookings') }}</option>
                                <option value="1day">{{ _('Last 1 Day') }}</option>
                                <option value="3days">{{ _('Last 3 Days') }}</option>
                                <option value="7days">{{ _('Last 7 Days') }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary" onclick="return confirm('{{ _('Are you sure you want to manually back up bookings for the selected range to a new CSV file on Azure?') }}');">
                                <i class="fas fa-cloud-upload-alt"></i> {{ _('Backup Bookings to CSV (to Azure - Legacy)') }}
                            </button>
                        </div>
                    </div>
                </form>

                <div class="mb-3">
                    <a href="{{ url_for('admin_ui.export_bookings_csv') }}" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> {{ _('Download All Bookings as CSV') }}
                    </a>
                </div>
                <hr>
                <h6>{{_('Import from CSV')}}</h6>
                <form method="POST" action="{{ url_for('admin_ui.import_bookings_csv') }}" enctype="multipart/form-data" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-group">
                        <label for="csv_file_import">{{ _('Select CSV File to Import:') }}</label>
                        <input type="file" name="file" id="csv_file_import" class="form-control-file" accept=".csv" required>
                        <small class="form-text text-muted">{{ _('Ensure the CSV format matches the export format, including the header row. This will attempt to add new bookings or update existing ones based on matches.') }}</small>
                    </div>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-file-import"></i> {{ _('Import Bookings from CSV') }}
                    </button>
                </form>
                <hr>
                <h6>{{_('Manage Stored CSV Backups on Azure (Legacy)')}}</h6>
                {% if booking_csv_backups and booking_csv_backups|length > 0 %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>{{ _('Stored CSV Backup Details') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup_item in booking_csv_backups %}
                        <tr>
                            <td>{{ backup_item.display_name }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('admin_ui.restore_booking_csv_route', timestamp_str=backup_item.timestamp) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-warning btn-sm"
                                            title="{{ _('This restore method adds new bookings from the CSV and skips duplicates. It does not delete existing data. For a full replacement restore, use the JSON options.') }}"
                                            onclick="return confirm('{{ _('Are you sure you want to restore bookings from CSV backup') }} \'{{ backup_item.display_name }}\'? {{ _('This may add new bookings or skip duplicates based on existing data. This action uses the CSV restore logic under the "Restore Booking Data" section.') }}');">
                                        <i class="fas fa-undo"></i> {{ _('Restore from this CSV (Adds/Skips - Legacy)') }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_ui.verify_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-info btn-sm"><i class="fas fa-check-circle"></i> {{ _('Verify Integrity') }}</button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_ui.delete_booking_csv_backup_route', timestamp_str=backup_item.timestamp) }}" style="display: inline; margin-left: 5px;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('{{ _('Are you sure you want to permanently delete the booking CSV backup file:') }} ' + '{{ backup_item.display_name | e }}' + ' {{_('from Azure storage?') }}');">
                                        <i class="fas fa-trash-alt"></i> {{ _('Delete from Azure') }}
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>{{ _('No booking CSV backups found in Azure storage.') }}</p>
                {% endif %}
                {% if booking_csv_total_pages > 1 %}
                <nav aria-label="Booking CSV Backup Pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if booking_csv_has_prev %}<li class="page-item"><a class="page-link" href="{{ url_for('admin_ui.serve_backup_booking_data_page', page=booking_csv_page - 1) }}">{{ _('Previous') }}</a></li>{% else %}<li class="page-item disabled"><span class="page-link">{{ _('Previous') }}</span></li>{% endif %}
                        <li class="page-item disabled"><span class="page-link">{{ _('Page %(page)s of %(total_pages)s', page=booking_csv_page, total_pages=booking_csv_total_pages) }}</span></li>
                        {% if booking_csv_has_next %}<li class="page-item"><a class="page-link" href="{{ url_for('admin_ui.serve_backup_booking_data_page', page=booking_csv_page + 1) }}">{{ _('Next') }}</a></li>{% else %}<li class="page-item disabled"><span class="page-link">{{ _('Next') }}</span></li>{% endif %}
                    </ul>
                </nav>
                {% endif %}
            </section> <!-- End Manual CSV Operations -->
            <hr>
            <section id="manual-json-operations" class="mb-3 p-3 border rounded">
                <h5>{{ _('Manual Booking JSON Operations') }}</h5>
                <p>{{_('Perform manual full exports or create incremental backups of booking data in JSON format. JSON is recommended for comprehensive backup and restore operations.')}}</p>

                <!-- Manual Full JSON Export to Azure -->
                <div class="form-group mb-2">
                    <button id="btnManualFullBookingExportJson" class="btn btn-primary"><i class="fas fa-cloud-upload-alt"></i> {{ _('Export All Bookings to JSON (to Azure)') }}</button> <!-- Icon changed -->
                    <small class="form-text text-muted">{{_('This will generate a complete export of all booking data in JSON format and upload it to Azure.')}}</small>
                    <div id="statusManualFullBookingExportJson" class="mt-2"></div>
                </div>

                <!-- Download All Bookings as JSON (Local) -->
                <div class="form-group mb-2">
                    <a href="{{ url_for('admin_ui.export_all_bookings_json') }}" class="btn btn-success">
                        <i class="fas fa-download"></i> {{ _('Download All Bookings as JSON (Local)') }}
                    </a>
                    <small class="form-text text-muted">{{_('Download a JSON file containing all booking records directly to your computer.')}}</small>
                </div>

                <hr>
                <h5>{{ _('Import Bookings from Local JSON File') }}</h5>
                <div class="alert alert-danger" role="alert">
                    <strong>{{ _('WARNING:') }}</strong> {{ _('This will delete ALL current bookings and replace them with bookings from the selected file. This action is irreversible.') }}
                </div>
                <form method="POST" action="{{ url_for('admin_ui.import_bookings_json') }}" enctype="multipart/form-data" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-group mb-2">
                        <label for="json_file_import">{{ _('Select JSON File to Import:') }}</label>
                        <input type="file" name="file" id="json_file_import" class="form-control-file" accept=".json" required>
                        <small class="form-text text-muted">{{_('Ensure the JSON file structure matches the export format.')}}</small>
                    </div>
                    <button type="submit" class="btn btn-danger mt-2" onclick="return confirm('{{ _('ARE YOU ABSOLUTELY SURE? This will DELETE ALL existing bookings and replace them with the content of the selected JSON file. This action cannot be undone.') }}');">
                        <i class="fas fa-file-import"></i> {{ _('Import Bookings from JSON (Local)') }}
                    </button>
                </form>

                <!-- Manual Incremental JSON Backup -->
                <div class="form-group mb-2">
                    <button id="btnManualIncrementalBookingBackup" class="btn btn-info"><i class="fas fa-history"></i> {{ _('Perform Incremental Backup (JSON)') }}</button>
                    <small class="form-text text-muted">{{_('This will generate an incremental backup of booking data changes since the last backup in JSON format.')}}</small>
                    <div id="statusManualIncrementalBookingBackup" class="mt-2"></div>
                </div>

                <!-- Manage Full JSON Exports -->
                <hr>
                <h5>{{ _('Manage Full JSON Exports (Azure)') }}</h5>
                <button id="refreshFullJsonExportsListBtn" class="btn btn-sm btn-secondary mb-2"><i class="fas fa-sync-alt"></i> {{ _('Refresh List') }}</button>
                <ul id="fullJsonExportsList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                    <!-- JS will populate this -->
                    <li class="list-group-item">{{_('Loading...')}}</li>
                </ul>
                <div id="statusDeleteFullJsonExport" class="mt-2"></div>

            </section> <!-- End Manual JSON Operations -->
            <hr>
            <section id="destructive-actions" class="p-3 border rounded bg-light">
                <h5 class="text-danger">{{ _('Destructive Actions') }}</h5>
                <p class="text-danger">{{ _('Warning: The following action is irreversible and will permanently delete data from the database.') }}</p>
                <form method="POST" action="{{ url_for('admin_ui.clear_all_bookings_data') }}" class="mt-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('{{ _('Are you absolutely sure you want to delete ALL booking data? This action cannot be undone and will permanently erase all bookings from the database.') }}');">
                        <i class="fas fa-trash-alt"></i> {{ _('Clear All Booking Data from Database') }}
                    </button>
                </form>
            </section> <!-- End Destructive Actions -->
        </div>
    </div> <!-- End Manual Operations Card -->

    <!-- Global Log Areas -->
    <div class="mt-4">
        <h5>{{ _('Operation Logs') }}</h5>
        <pre id="backup-log-area" class="log-area" style="display: none;"></pre>
        <pre id="restore-log-area" class="log-area" style="display: none;"></pre>
    </div>

    <!-- Selective Restore Modal (remains global) -->
    <div id="selective-restore-modal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-selective-restore-modal">&times;</span>
            <h3>{{ _('Selective Restore Options') }}</h3>
            <p>{{ _('Select components to restore for backup:') }} <strong id="modal-backup-timestamp"></strong></p>
            <form id="selective-restore-form">
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="database" id="component-database" name="components">
                    <label class="form-check-label" for="component-database">{{ _('Database (Bookings, Users, Resources, etc.)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="map_config" id="component-map_config" name="components">
                    <label class="form-check-label" for="component-map_config">{{ _('Map Configuration (Floor map definitions & resource mappings on maps)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="floor_maps" id="component-floor_maps" name="components">
                    <label class="form-check-label" for="component-floor_maps">{{ _('Floor Map Images (in static/floor_map_uploads)') }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input component-checkbox" type="checkbox" value="resource_uploads" id="component-resource_uploads" name="components">
                    <label class="form-check-label" for="component-resource_uploads">{{ _('Resource Images (in static/resource_uploads)') }}</label>
                </div>
                <hr>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="all" id="component-all" name="components_all">
                    <label class="form-check-label" for="component-all">{{ _('ALL COMPONENTS (Full Restore)') }}</label>
                </div>
                <button type="submit" id="confirm-selective-restore-btn" class="btn btn-primary mt-3">{{ _('Proceed with Selected Restore') }}</button>
            </form>
            <div id="selective-restore-modal-status" class="status-message mt-2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/admin_backup_common.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Elements for "Selective Booking Restore"
            const selectFullBackupForBookingRestore = document.getElementById('selectFullBackupForBookingRestore');
            const btnRestoreBookingsFromFullDb = document.getElementById('btnRestoreBookingsFromFullDb');
            const statusRestoreBookingsFromFullDb = document.getElementById('statusRestoreBookingsFromFullDb');

            const selectCsvBackupForBookingRestore = document.getElementById('selectCsvBackupForBookingRestore');
            const btnRestoreBookingsFromCsv = document.getElementById('btnRestoreBookingsFromCsv');
            const statusRestoreBookingsFromCsv = document.getElementById('statusRestoreBookingsFromCsv');

            const incrementalBackupsListDiv = document.getElementById('incrementalBackupsList');
            const btnRestoreBookingsFromIncremental = document.getElementById('btnRestoreBookingsFromIncremental');
            const statusRestoreBookingsFromIncremental = document.getElementById('statusRestoreBookingsFromIncremental');

            // Log areas (though global, might be specifically targeted for messages from this page)
            const backupLogAreaEl = document.getElementById('backup-log-area');
            const restoreLogAreaEl = document.getElementById('restore-log-area');


            // Task ID Variables
            let currentBookingFullDbRestoreTaskId = null;
            let currentBookingCsvRestoreTaskId = null;
            let currentBookingIncrementalRestoreTaskId = null; // For applying incremental backups
            let currentBookingCsvBackupTaskId = null; // For manual CSV backup to Azure
            let currentManualIncrementalBackupTaskId = null; // For manual incremental JSON backup
            let currentManualFullExportTaskId = null; // For manual full JSON export
            let currentRestoreFullJsonExportTaskId = null; // For restoring from full JSON export
            let currentDeleteIncrementalJsonTaskId = null; // For deleting incremental JSON backups
            let currentDeleteFullJsonExportTaskId = null; // For deleting full JSON exports


            // Elements for Manual JSON Operations & Restore from Full JSON
            const btnManualIncrementalBookingBackup = document.getElementById('btnManualIncrementalBookingBackup');
            const statusManualIncrementalBookingBackup = document.getElementById('statusManualIncrementalBookingBackup');
            const btnManualFullBookingExportJson = document.getElementById('btnManualFullBookingExportJson');
            const statusManualFullBookingExportJson = document.getElementById('statusManualFullBookingExportJson');

            const selectFullJsonExportForRestore = document.getElementById('selectFullJsonExportForRestore');
            const btnRestoreFromFullJsonExport = document.getElementById('btnRestoreFromFullJsonExport');
            const statusRestoreFromFullJsonExport = document.getElementById('statusRestoreFromFullJsonExport');

            // Elements for Manage Full JSON Exports
            const fullJsonExportsListEl = document.getElementById('fullJsonExportsList');
            const statusDeleteFullJsonExportEl = document.getElementById('statusDeleteFullJsonExport');
            const refreshFullJsonExportsListBtn = document.getElementById('refreshFullJsonExportsListBtn');


            // SocketIO Event Listeners (specific to booking data operations)
            if (typeof socket !== 'undefined') {
                socket.on('booking_db_restore_progress', function(data) {
                    if (data.task_id !== currentBookingFullDbRestoreTaskId) return;
                    appendLog('restore-log-area', `Full DB Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromFullDb);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentBookingFullDbRestoreTaskId = null;
                    }
                });
                socket.on('booking_csv_restore_progress', function(data) {
                    if (data.task_id !== currentBookingCsvRestoreTaskId) return;
                    appendLog('restore-log-area', `CSV Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromCsv);
                     if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentBookingCsvRestoreTaskId = null;
                    }
                });
                socket.on('incremental_booking_restore_progress', function(data) {
                    if (data.task_id !== currentBookingIncrementalRestoreTaskId) return;
                    appendLog('restore-log-area', `Incremental Restore: ${data.status}`, data.detail, data.level.toLowerCase(), statusRestoreBookingsFromIncremental);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentBookingIncrementalRestoreTaskId = null;
                        if (typeof loadIncrementalBackupsList === 'function') loadIncrementalBackupsList(); // Refresh list
                    }
                });
                socket.on('booking_csv_backup_progress', function(data) {
                    if (data.task_id !== currentBookingCsvBackupTaskId) return;
                    appendLog('backup-log-area', `Manual CSV Backup: ${data.status}`, data.detail, data.level.toLowerCase());
                    if (data.status.toLowerCase().includes("complete") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error")) {
                        enablePageInteractions();
                        currentBookingCsvBackupTaskId = null;
                        if (data.level.toLowerCase() === 'success' && typeof loadCsvBackupsForBookingRestore === 'function') {
                            loadCsvBackupsForBookingRestore();
                        }
                    }
                });
                socket.on('incremental_booking_backup_progress', function(data) {
                    if (data.task_id !== currentManualIncrementalBackupTaskId) return;
                    appendLog('backup-log-area', `Manual Incremental Backup: ${data.status}`, data.detail, data.level ? data.level.toLowerCase() : 'info', statusManualIncrementalBookingBackup);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentManualIncrementalBackupTaskId = null;
                        if (data.level && data.level.toLowerCase() === 'success' && typeof loadIncrementalBackupsList === 'function') {
                           loadIncrementalBackupsList();
                        }
                    }
                });
                socket.on('full_booking_export_progress', function(data) {
                    if (data.task_id !== currentManualFullExportTaskId) return;
                    appendLog('backup-log-area', `Manual Full Export: ${data.status}`, data.detail, data.level ? data.level.toLowerCase() : 'info', statusManualFullBookingExportJson);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentManualFullExportTaskId = null;
                         if (data.level && data.level.toLowerCase() === 'success' && typeof displayFullJsonExportsForManagement === 'function') {
                           displayFullJsonExportsForManagement();
                           loadFullJsonExportsForRestore(); // Also refresh the restore dropdown
                        }
                    }
                });
                socket.on('full_booking_json_restore_progress', function(data) {
                    if (data.task_id !== currentRestoreFullJsonExportTaskId) return;
                    appendLog('restore-log-area', `Full JSON Restore: ${data.status}`, data.detail, data.level ? data.level.toLowerCase() : 'info', statusRestoreFromFullJsonExport);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical")) {
                        enablePageInteractions();
                        currentRestoreFullJsonExportTaskId = null;
                    }
                });
                socket.on('incremental_booking_delete_progress', function(data) {
                    if (data.task_id !== currentDeleteIncrementalJsonTaskId) return;
                    appendLog('backup-log-area', `Delete Incremental Backup: ${data.status}`, data.detail, data.level ? data.level.toLowerCase() : 'info', statusRestoreBookingsFromIncremental);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical") || (data.detail && data.detail.toUpperCase().includes("SUCCESS")) || (data.status && data.status.toLowerCase().includes("not found"))) {
                        enablePageInteractions();
                        currentDeleteIncrementalJsonTaskId = null;
                        if ((data.detail && data.detail.toUpperCase().includes("SUCCESS")) || (data.status && data.status.toLowerCase().includes("not found")) || (data.level && data.level.toLowerCase() === 'success') ) {
                           loadIncrementalBackupsList();
                        }
                    }
                });
                socket.on('full_booking_export_delete_progress', function(data) {
                    if (data.task_id !== currentDeleteFullJsonExportTaskId) return;
                    appendLog('backup-log-area', `Delete Full JSON Export: ${data.status}`, data.detail, data.level ? data.level.toLowerCase() : 'info', statusDeleteFullJsonExportEl);
                    if (data.status.toLowerCase().includes("completed") || data.status.toLowerCase().includes("failed") || data.status.toLowerCase().includes("error") || data.status.toLowerCase().includes("critical") || (data.detail && data.detail.toUpperCase().includes("SUCCESS")) || (data.status && data.status.toLowerCase().includes("not found"))) {
                        enablePageInteractions();
                        currentDeleteFullJsonExportTaskId = null;
                        if ((data.detail && data.detail.toUpperCase().includes("SUCCESS")) || (data.status && data.status.toLowerCase().includes("not found")) || (data.level && data.level.toLowerCase() === 'success') ) {
                           displayFullJsonExportsForManagement();
                           loadFullJsonExportsForRestore(); // Keep restore dropdown in sync
                        }
                    }
                });


            } else {
                console.error("Socket.IO instance not found. Ensure admin_backup_common.js is loaded and initializes 'socket'.");
            }


            // Event handler for Manual Full Booking Export to JSON
            if (btnManualFullBookingExportJson) {
                btnManualFullBookingExportJson.addEventListener('click', function() {
                    if (!confirm("{{ _('Are you sure you want to perform a full export of all bookings to JSON? This will upload the file to Azure.') }}")) return;

                    currentManualFullExportTaskId = null;
                    if(backupLogAreaEl) { backupLogAreaEl.innerHTML = ''; backupLogAreaEl.style.display = 'block'; }
                    if(restoreLogAreaEl) { restoreLogAreaEl.style.display = 'none'; }
                    appendLog('backup-log-area', "{{ _('Initiating manual full booking JSON export...') }}", '', 'info', statusManualFullBookingExportJson);
                    disablePageInteractions();

                    fetch('/api/admin/manual_full_booking_export_json', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentManualFullExportTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('backup-log-area', data.message || (data.success ? "{{ _('Manual full JSON export process started.') }}" : "{{ _('Failed to start export process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusManualFullBookingExportJson);
                        if (!data.success) {
                            enablePageInteractions();
                        }
                    })
                    .catch(error => {
                        appendLog('backup-log-area', "{{ _('Request for full JSON export failed:') }}", error.message, 'error', statusManualFullBookingExportJson);
                        enablePageInteractions();
                    });
                });
            }

            // Event handler for Manual Incremental Booking Backup
            if (btnManualIncrementalBookingBackup) {
                btnManualIncrementalBookingBackup.addEventListener('click', function() {
                    if (!confirm("{{ _('Are you sure you want to perform a manual incremental booking backup now? This will capture changes since the last backup.') }}")) return;

                    currentManualIncrementalBackupTaskId = null;
                    if(backupLogAreaEl) { backupLogAreaEl.innerHTML = ''; backupLogAreaEl.style.display = 'block'; }
                    if(restoreLogAreaEl) { restoreLogAreaEl.style.display = 'none'; }
                    appendLog('backup-log-area', "{{ _('Initiating manual incremental booking backup...') }}", '', 'info', statusManualIncrementalBookingBackup);
                    disablePageInteractions();

                    fetch('/api/admin/manual_incremental_booking_backup', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentManualIncrementalBackupTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('backup-log-area', data.message || (data.success ? "{{ _('Manual incremental backup process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusManualIncrementalBookingBackup);
                        if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')))) {
                            enablePageInteractions();
                        }
                    })
                    .catch(error => {
                        appendLog('backup-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusManualIncrementalBookingBackup);
                        enablePageInteractions();
                    });
                });
            }

            // Helper Functions for populating selective restore lists
            function loadFullBackupsForBookingRestore() {
                if (!selectFullBackupForBookingRestore) return;
                selectFullBackupForBookingRestore.innerHTML = '<option value="">{{ _("Loading...") }}</option>';
                fetch('/api/admin/booking_restore/list_full_backups')
                    .then(response => response.json())
                    .then(data => {
                        selectFullBackupForBookingRestore.innerHTML = '<option value="">{{ _("-- Select a Full Backup --") }}</option>';
                        if (data.success && data.backups && data.backups.length > 0) {
                            data.backups.forEach(timestamp => {
                                const option = document.createElement('option');
                                option.value = timestamp;
                                let displayTimestamp = timestamp;
                                 try {
                                    const year = timestamp.substring(0,4); const month = timestamp.substring(4,6);
                                    const day = timestamp.substring(6,8); const hour = timestamp.substring(9,11);
                                    const minute = timestamp.substring(11,13); const second = timestamp.substring(13,15);
                                    displayTimestamp = `${year}-${month}-${day} ${hour}:${minute}:${second} UTC`;
                                } catch (e) { /* ignore parsing error */ }
                                option.textContent = displayTimestamp;
                                selectFullBackupForBookingRestore.appendChild(option);
                            });
                            selectFullBackupForBookingRestore.disabled = false;
                            if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = false;
                        } else {
                            selectFullBackupForBookingRestore.innerHTML = '<option value="">{{ _("No full backups found") }}</option>';
                            selectFullBackupForBookingRestore.disabled = true;
                            if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading full backups for booking restore:', error);
                        selectFullBackupForBookingRestore.innerHTML = '<option value="">{{ _("Error loading backups") }}</option>';
                        selectFullBackupForBookingRestore.disabled = true;
                        if(btnRestoreBookingsFromFullDb) btnRestoreBookingsFromFullDb.disabled = true;
                    });
            }

            function loadCsvBackupsForBookingRestore() {
                if (!selectCsvBackupForBookingRestore) return;
                selectCsvBackupForBookingRestore.innerHTML = '<option value="">{{ _("Loading...") }}</option>';
                fetch('/api/admin/booking_restore/list_csv')
                    .then(response => response.json())
                    .then(data => {
                        selectCsvBackupForBookingRestore.innerHTML = '<option value="">{{ _("-- Select a CSV Backup --") }}</option>';
                        if (data.success && data.backups && data.backups.length > 0) {
                            data.backups.forEach(backup => {
                                const option = new Option(backup.display_name, backup.timestamp);
                                selectCsvBackupForBookingRestore.add(option);
                            });
                            selectCsvBackupForBookingRestore.disabled = false;
                            if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = false;
                        } else {
                            selectCsvBackupForBookingRestore.innerHTML = '<option value="">{{ _("No CSV backups found") }}</option>';
                            selectCsvBackupForBookingRestore.disabled = true;
                            if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading CSV backups for booking restore:', error);
                        selectCsvBackupForBookingRestore.innerHTML = '<option value="">{{ _("Error loading backups") }}</option>';
                        selectCsvBackupForBookingRestore.disabled = true;
                        if(btnRestoreBookingsFromCsv) btnRestoreBookingsFromCsv.disabled = true;
                    });
            }

            function loadIncrementalBackupsList() {
                if (!incrementalBackupsListDiv) return;
                incrementalBackupsListDiv.innerHTML = '<em>{{ _("Loading incremental backups list...") }}</em>';
                fetch('/api/admin/booking_restore/list_incremental')
                    .then(response => response.json())
                    .then(data => {
                        incrementalBackupsListDiv.innerHTML = ''; // Clear previous content
                        if (data.success && data.backups && data.backups.length > 0) {
                            const ul = document.createElement('ul');
                            ul.className = 'list-group';
                            data.backups.forEach(backup => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item list-group-item-sm py-1 d-flex justify-content-between align-items-center';

                                const span = document.createElement('span');
                                span.textContent = backup.display_name;
                                li.appendChild(span);

                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-danger btn-sm delete-incremental-json-btn';
                                deleteBtn.setAttribute('data-filename', backup.filename);
                                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> {{ _("Delete") }}';
                                li.appendChild(deleteBtn);

                                ul.appendChild(li);
                            });
                            incrementalBackupsListDiv.appendChild(ul);
                            if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = false;
                        } else if (data.success) {
                            incrementalBackupsListDiv.textContent = "{{ _('No incremental backups available to apply.') }}";
                            if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                        } else {
                            incrementalBackupsListDiv.textContent = "{{ _('Error loading incremental backups list.') }}";
                            if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading incremental backups list:', error);
                        incrementalBackupsListDiv.textContent = "{{ _('Error loading list.') }}";
                        if(btnRestoreBookingsFromIncremental) btnRestoreBookingsFromIncremental.disabled = true;
                    });
            }

            // Function to load Full JSON Exports for Restore
            function loadFullJsonExportsForRestore() {
                if (!selectFullJsonExportForRestore) return;
                selectFullJsonExportForRestore.innerHTML = '<option value="">{{ _("Loading...") }}</option>';
                fetch('/api/admin/booking_restore/list_full_json_exports')
                    .then(response => response.json())
                    .then(data => {
                        selectFullJsonExportForRestore.innerHTML = '<option value="">{{ _("-- Select a Full JSON Export --") }}</option>';
                        if (data.success && data.backups && data.backups.length > 0) {
                            data.backups.forEach(backup => {
                                const option = new Option(backup.display_name, backup.filename); // Use filename as value
                                selectFullJsonExportForRestore.add(option);
                            });
                            selectFullJsonExportForRestore.disabled = false;
                            if(btnRestoreFromFullJsonExport) btnRestoreFromFullJsonExport.disabled = false;
                        } else {
                            selectFullJsonExportForRestore.innerHTML = `<option value="">{{ _("No full JSON exports found.") }}${data.message ? ' ('+data.message+')' : ''}</option>`;
                            selectFullJsonExportForRestore.disabled = true;
                            if(btnRestoreFromFullJsonExport) btnRestoreFromFullJsonExport.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading full JSON exports for restore:', error);
                        selectFullJsonExportForRestore.innerHTML = '<option value="">{{ _("Error loading exports") }}</option>';
                        selectFullJsonExportForRestore.disabled = true;
                        if(btnRestoreFromFullJsonExport) btnRestoreFromFullJsonExport.disabled = true;
                    });
            }

             // Function to display Full JSON Exports for Management (deletion)
            function displayFullJsonExportsForManagement() {
                if (!fullJsonExportsListEl) return;
                fullJsonExportsListEl.innerHTML = `<li class="list-group-item">{{_('Loading...')}}</li>`;
                fetch('/api/admin/booking_restore/list_full_json_exports')
                    .then(response => response.json())
                    .then(data => {
                        fullJsonExportsListEl.innerHTML = ''; // Clear previous content
                        if (data.success && data.backups && data.backups.length > 0) {
                            data.backups.forEach(backup => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item list-group-item-sm py-1 d-flex justify-content-between align-items-center';

                                const span = document.createElement('span');
                                span.textContent = backup.display_name;
                                li.appendChild(span);

                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-danger btn-sm delete-full-json-export-btn';
                                deleteBtn.setAttribute('data-filename', backup.filename);
                                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> {{ _("Delete") }}';
                                li.appendChild(deleteBtn);

                                fullJsonExportsListEl.appendChild(li);
                            });
                        } else if (data.success) {
                            fullJsonExportsListEl.innerHTML = `<li class="list-group-item">{{_('No full JSON exports found.')}}</li>`;
                        } else {
                            fullJsonExportsListEl.innerHTML = `<li class="list-group-item">{{_('Error loading full JSON exports list.')}} ${data.message || ''}</li>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading full JSON exports for management:', error);
                        fullJsonExportsListEl.innerHTML = `<li class="list-group-item">{{_('Error loading list.')}}</li>`;
                    });
            }

            // Event listener for deleting incremental JSON backups
            if (incrementalBackupsListDiv) {
                incrementalBackupsListDiv.addEventListener('click', function(event) {
                    const targetButton = event.target.closest('.delete-incremental-json-btn');
                    if (targetButton) {
                        const filename = targetButton.dataset.filename;
                        if (!confirm("{{ _('Are you sure you want to delete the incremental backup file:') }} " + filename + "?")) {
                            return;
                        }
                        currentDeleteIncrementalJsonTaskId = null; // Reset
                        if(backupLogAreaEl) { backupLogAreaEl.innerHTML = ''; backupLogAreaEl.style.display = 'block';}
                        if(restoreLogAreaEl) { restoreLogAreaEl.style.display = 'none';}
                        appendLog('backup-log-area', `{{ _('Initiating deletion of incremental backup:') }} ${filename}...`, '', 'info', statusRestoreBookingsFromIncremental);
                        disablePageInteractions();

                        fetch('/api/admin/delete_incremental_booking_backup', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ filename: filename })
                        })
                        .then(response => response.json())
                        .then(data => {
                            currentDeleteIncrementalJsonTaskId = data.task_id;
                            const messageType = data.success ? 'info' : 'error';
                            appendLog('backup-log-area', data.message || (data.success ? `{{ _('Deletion process for ${filename} started.') }}` : `{{ _('Failed to start deletion for ${filename}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromIncremental);
                            if (!data.success) {
                                enablePageInteractions();
                            }
                        })
                        .catch(error => {
                            appendLog('backup-log-area', `{{ _('Request to delete ${filename} failed:') }}`, error.message, 'error', statusRestoreBookingsFromIncremental);
                            enablePageInteractions();
                        });
                    }
                });
            }

            // Event listener for Refresh Full JSON Exports List button
            if (refreshFullJsonExportsListBtn) {
                refreshFullJsonExportsListBtn.addEventListener('click', function() {
                    displayFullJsonExportsForManagement();
                });
            }

            // Event listener for deleting Full JSON Exports
            if (fullJsonExportsListEl) {
                fullJsonExportsListEl.addEventListener('click', function(event) {
                    const targetButton = event.target.closest('.delete-full-json-export-btn');
                    if (targetButton) {
                        const filename = targetButton.dataset.filename;
                        if (!confirm("{{ _('Are you sure you want to delete the Full JSON Export file:') }} " + filename + "?")) {
                            return;
                        }
                        currentDeleteFullJsonExportTaskId = null;
                        if(backupLogAreaEl) { backupLogAreaEl.innerHTML = ''; backupLogAreaEl.style.display = 'block';}
                        if(restoreLogAreaEl) { restoreLogAreaEl.style.display = 'none';}
                        appendLog('backup-log-area', `{{ _('Initiating deletion of Full JSON Export:') }} ${filename}...`, '', 'info', statusDeleteFullJsonExportEl);
                        disablePageInteractions();

                        fetch('/api/admin/delete_full_booking_json_export', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ filename: filename })
                        })
                        .then(response => response.json())
                        .then(data => {
                            currentDeleteFullJsonExportTaskId = data.task_id;
                            const messageType = data.success ? 'info' : 'error';
                            appendLog('backup-log-area', data.message || (data.success ? `{{ _('Deletion process for ${filename} started.') }}` : `{{ _('Failed to start deletion for ${filename}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusDeleteFullJsonExportEl);
                            if (!data.success) {
                                enablePageInteractions();
                            }
                        })
                        .catch(error => {
                            appendLog('backup-log-area', `{{ _('Request to delete ${filename} failed:') }}`, error.message, 'error', statusDeleteFullJsonExportEl);
                            enablePageInteractions();
                        });
                    }
                });
            }


            // Event handler for Restore from Full JSON Export button
            if (btnRestoreFromFullJsonExport) {
                btnRestoreFromFullJsonExport.addEventListener('click', function() {
                    const selectedFilename = selectFullJsonExportForRestore.value;
                    if (!selectedFilename) {
                        appendLog('restore-log-area', "{{ _('Please select a Full JSON Export file to restore.') }}", '', 'error', statusRestoreFromFullJsonExport);
                        return;
                    }
                    const selectedDisplayName = selectFullJsonExportForRestore.options[selectFullJsonExportForRestore.selectedIndex].text;

                    if (!confirm("{{ _('WARNING: This will delete ALL current bookings and replace them with bookings from the selected file. This action is irreversible. Are you sure you want to proceed with restoring from') }} '" + selectedDisplayName + "'?")) return;

                    currentRestoreFullJsonExportTaskId = null;
                    if(restoreLogAreaEl) { restoreLogAreaEl.innerHTML = ''; restoreLogAreaEl.style.display = 'block'; }
                    if(backupLogAreaEl) { backupLogAreaEl.style.display = 'none'; }
                    appendLog('restore-log-area', `{{ _('Initiating restore from Full JSON Export:') }} ${selectedDisplayName}...`, '', 'info', statusRestoreFromFullJsonExport);
                    disablePageInteractions();

                    fetch('/api/admin/booking_restore/from_full_json_export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ filename: selectedFilename })
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentRestoreFullJsonExportTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('restore-log-area', data.message || (data.success ? `{{ _('Restore from Full JSON Export process started for ${selectedDisplayName}.') }}` : `{{ _('Failed to start restore process for ${selectedDisplayName}.') }}`), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreFromFullJsonExport);
                        if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')))) {
                            enablePageInteractions();
                        }
                        // Further updates via 'full_booking_json_restore_progress' socket event
                    })
                    .catch(error => {
                        appendLog('restore-log-area', `{{ _('Request to restore from Full JSON Export ${selectedDisplayName} failed:') }}`, error.message, 'error', statusRestoreFromFullJsonExport);
                        enablePageInteractions();
                    });
                });
            }

            // Event Handlers for Selective Booking Restore buttons
            if (btnRestoreBookingsFromFullDb) {
                btnRestoreBookingsFromFullDb.addEventListener('click', function() {
                    const selectedTimestamp = selectFullBackupForBookingRestore.value;
                    if (!selectedTimestamp) {
                        appendLog('restore-log-area', "{{ _('Please select a full backup.') }}", '', 'error', statusRestoreBookingsFromFullDb);
                        return;
                    }
                    if (!confirm("{{ _('WARNING: This will delete ALL current bookings and replace them with bookings from the selected full system backup. Are you sure you want to proceed?') }}")) return;

                    currentBookingFullDbRestoreTaskId = null;
                    appendLog('restore-log-area', `{{ _('Initiating booking restore from full DB backup:') }} ${selectedTimestamp}...`, '', 'info', statusRestoreBookingsFromFullDb);
                    disablePageInteractions();
                    fetch('/api/admin/booking_restore/from_full_db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                        body: JSON.stringify({ backup_timestamp: selectedTimestamp })
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentBookingFullDbRestoreTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from full DB process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromFullDb);
                        if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')) )) {
                            enablePageInteractions();
                        }
                    })
                    .catch(error => {
                        appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromFullDb);
                        enablePageInteractions();
                    });
                });
            }

            if (btnRestoreBookingsFromCsv) {
                btnRestoreBookingsFromCsv.addEventListener('click', function() {
                    const selectedTimestamp = selectCsvBackupForBookingRestore.value;
                    if (!selectedTimestamp) {
                        appendLog('restore-log-area', "{{ _('Please select a CSV backup.') }}", '', 'error', statusRestoreBookingsFromCsv);
                        return;
                    }
                    if (!confirm("{{ _('Are you sure you want to restore bookings from CSV backup:') }} '" + selectCsvBackupForBookingRestore.options[selectCsvBackupForBookingRestore.selectedIndex].text + "'?")) return;

                    currentBookingCsvRestoreTaskId = null;
                    appendLog('restore-log-area', `{{ _('Initiating booking restore from CSV:') }} ${selectedTimestamp}...`, '', 'info', statusRestoreBookingsFromCsv);
                    disablePageInteractions();
                    fetch('/api/admin/booking_restore/from_csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken, 'Accept': 'application/json' },
                        body: JSON.stringify({ backup_timestamp: selectedTimestamp })
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentBookingCsvRestoreTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from CSV process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromCsv);
                         if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail')|| data.summary.status.includes('error')))) {
                            enablePageInteractions();
                        }
                    })
                    .catch(error => {
                        appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromCsv);
                        enablePageInteractions();
                    });
                });
            }

            if (btnRestoreBookingsFromIncremental) {
                btnRestoreBookingsFromIncremental.addEventListener('click', function() {
                    if (!confirm("{{ _('Are you sure you want to apply all available incremental booking backups? This will update your current booking records.') }}")) return;

                    currentBookingIncrementalRestoreTaskId = null;
                    appendLog('restore-log-area', "{{ _('Initiating booking restore from incremental backups...') }}", '', 'info', statusRestoreBookingsFromIncremental);
                    disablePageInteractions();
                    fetch('/api/admin/booking_restore/from_incremental', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken, 'Accept': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        currentBookingIncrementalRestoreTaskId = data.task_id;
                        const messageType = data.success ? 'info' : 'error';
                        appendLog('restore-log-area', data.message || (data.success ? "{{ _('Booking restore from incremental backups process started.') }}" : "{{ _('Failed to start process.') }}"), `Task ID: ${data.task_id || 'N/A'}`, messageType, statusRestoreBookingsFromIncremental);
                        if (!data.success || (data.summary && data.summary.status && (data.summary.status.includes('fail') || data.summary.status.includes('error')))) {
                            enablePageInteractions();
                        }
                    })
                    .catch(error => {
                        appendLog('restore-log-area', "{{ _('Request failed:') }}", error.message, 'error', statusRestoreBookingsFromIncremental);
                        enablePageInteractions();
                    });
                });
            }

            // Initial data loading for dropdowns/lists
            loadFullBackupsForBookingRestore();
            loadCsvBackupsForBookingRestore();
            loadIncrementalBackupsList();
            loadFullJsonExportsForRestore();
            displayFullJsonExportsForManagement(); // Load the management list on page load
        });
    </script>
{% endblock %}
