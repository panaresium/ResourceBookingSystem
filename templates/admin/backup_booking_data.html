{% extends "base.html" %}

{% block title %}{{ _("Booking Data Management") }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">{{ _("Booking Data Management") }}</h1>
    <p class="mb-4">{{ _("Manage backups and restore options for booking data. For full system backups, please visit the System Backup page.") }}</p>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shield-alt"></i> {{ _("Full System Backup & Restore") }}
                </div>
                <div class="card-body">
                    <p>{{ _("For comprehensive system backups that include all data (bookings, settings, users, etc.) and allow for full system restoration, please use the dedicated system backup utility.") }}</p>
                    <a href="{{ url_for('admin_ui.serve_backup_system_page') }}" class="btn btn-primary">{{ _("Go to System Backup & Restore") }}</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Current Server Time -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i> {{ _("Current Server Time") }}
                </div>
                <div class="card-body">
                    <p id="server-time">{{ _("Loading server time...") }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Azure JSON Booking Data Backups Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> {{ _("Unified Azure JSON Booking Data Backups") }}</h4>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ _("This is the recommended method for robust backup and point-in-time recovery of your booking data.") }}</p>
                    <div class="mb-3">
                        <button id="btnManualUnifiedBackup" class="btn btn-primary" onclick="manualUnifiedBackup()">{{ _("Run Manual Full JSON Backup Now") }}</button>
                        <button id="btnRefreshUnifiedList" class="btn btn-info" onclick="refreshUnifiedAzureBackupList()">{{ _("Refresh Backup List") }}</button>
                    </div>

                    <h5>{{ _("Restore from Unified Azure JSON Backup") }}</h5>
                    <div class="form-group">
                        <label for="selectUnifiedAzureBackup">{{ _("Select Backup to Restore (Point-in-Time):") }}</label>
                        <select id="selectUnifiedAzureBackup" class="form-control mb-2"></select>
                        <button id="btnRestoreFromUnifiedAzure" class="btn btn-warning" onclick="restoreSelectedUnifiedBackup()">{{ _("Restore Selected Backup") }}</button>
                    </div>
                    <hr>
                    <h5>{{ _("Manage Unified Azure JSON Backups") }}</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>{{ _("Backup Details (Display Name)") }}</th>
                                    <th>{{ _("Type") }}</th>
                                    <th>{{ _("Filename") }}</th>
                                    <th>{{ _("Timestamp (UTC)") }}</th>
                                    <th>{{ _("Actions") }}</th>
                                </tr>
                            </thead>
                            <tbody id="listManageAzureBackups">
                                <!-- Backup items will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Legacy & Other Booking Data Operations -->
    <h2 class="mt-5 mb-3">{{ _("Legacy & Other Booking Data Operations") }}</h2>
    <p>{{ _("Manage scheduled and manual operations for your booking data using legacy methods or other formats. Use with caution or for specific export/import needs.") }}</p>

    <div class="row">
        <!-- Scheduled Backups Column (Legacy/Other) -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> {{ _("Scheduled Backups (Legacy/Other)") }}</h5>
                </div>
                <div class="card-body">
                    <!-- Scheduled Booking CSV Backups -->
                    <h6>{{ _("Scheduled Booking CSV Backups (Legacy)") }}</h6>
                    <p>{{ _("Configure automated daily CSV backups of booking data to Azure. This is a legacy method.") }}</p>
                    {#
                    <form method="POST" action="{{ url_for('admin_ui.configure_scheduled_csv_backup') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="csv_backup_time">{{ _("Backup Time (UTC)") }}</label>
                            <input type="time" class="form-control" id="csv_backup_time" name="csv_backup_time" value="{{ current_csv_backup_time if current_csv_backup_time else '' }}">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="csv_backup_enabled" name="csv_backup_enabled" {% if csv_backup_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="csv_backup_enabled">{{ _("Enable Scheduled CSV Backup") }}</label>
                        </div>
                        <button type="submit" class="btn btn-secondary">{{ _("Save CSV Schedule") }}</button>
                    </form>
                    #}
                    <hr>
                    <!-- Placeholder for Scheduled Incremental JSON Backups (Old System, if any) -->
                    <h6>{{ _("Scheduled Incremental JSON Backups (Legacy System)") }}</h6>
                    <p><em>{{ _("Configuration for any legacy scheduled incremental JSON backups would be here. The new Unified Azure JSON system handles scheduled incremental backups and is preferred.") }}</em></p>
                    <!-- Example: <button class="btn btn-outline-secondary" disabled>{{ _("Configure Legacy JSON Schedule (Not Implemented)") }}</button> -->
                </div>
            </div>
        </div>

        <!-- Manual Operations & Legacy CSV Column -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-hand-paper"></i> {{ _("Manual Operations & Legacy CSV") }}</h5>
                </div>
                <div class="card-body">
                    <!-- Manual Full Booking Export (Other JSON Formats) -->
                    <h6>{{ _("Manual Full Booking Export (Other JSON Formats)") }}</h6>
                    <p>{{ _("Manually trigger a full export of all booking data in specific non-backup JSON formats if needed for external systems.") }}</p>
                    <!-- <button class="btn btn-info" disabled>{{ _("Export All Bookings (Other JSON) (Coming Soon)") }}</button> -->
                    <p><em>{{ _("Placeholder: Functionality for exporting to other specific JSON formats (e.g., for external system integration) would be here.") }}</em></p>
                    <hr>

                    <!-- Manual Incremental Booking Backup (Other JSON Formats) -->
                    <h6>{{ _("Manual Incremental Booking Backup (Other JSON Formats)") }}</h6>
                    <p>{{ _("Manually trigger an incremental backup in specific non-backup JSON formats.") }}</p>
                    <!-- <button class="btn btn-info" disabled>{{ _("Manual Incremental Backup (Other JSON) (Coming Soon)") }}</button> -->
                    <p><em>{{ _("Placeholder: Functionality for manual incremental backups in other JSON formats would be here. The Unified Azure JSON system is preferred for actual backups.") }}</em></p>
                    <hr>

                    <!-- Manual Booking CSV Operations (Legacy) -->
                    <h6>{{ _("Manual Booking CSV Operations (Legacy)") }}</h6>
                    <p>{{ _("Manage legacy CSV files. Primarily for data export/import rather than robust backup.") }}</p>
                    <button class="btn btn-outline-secondary mb-2" onclick="backupBookingData('csv')">{{ _("Create New CSV Backup on Azure (Legacy)") }}</button>
                    {# <a href="{{ url_for('admin_ui.export_bookings_csv') }}" class="btn btn-outline-secondary mb-2">{{ _("Download All Bookings as CSV") }}</a> #}

                    {#
                    <form method="POST" action="{{ url_for('admin_ui.import_bookings_csv') }}" enctype="multipart/form-data" class="mt-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="csv_file">{{ _("Upload and Import Bookings from CSV (Legacy)") }}</label>
                            <input type="file" class="form-control-file" id="csv_file" name="csv_file" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn btn-warning">{{ _("Import from CSV") }}</button>
                    </form>
                    #}
                    <hr>

                    <!-- Destructive Actions -->
                    <h6>{{ _("Destructive Actions") }}</h6>
                    <button class="btn btn-danger" onclick="confirmClearAllBookingData()">{{ _("Clear All Booking Data") }}</button>
                    <small class="form-text text-muted">{{ _("This will permanently delete all booking entries from the database. Use with extreme caution.") }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Booking Data Section (Legacy/Other Methods) -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-undo-alt"></i> {{ _("Restore Booking Data (Legacy/Other Methods)") }}</h5>
                </div>
                <div class="card-body">
                    <p>{{ _("Restore booking data from available backups using legacy or other specific methods. The Unified Azure JSON Backup section provides more robust point-in-time recovery.") }}</p>

                    <div class="card mb-3">
                        <div class="card-header"> {{ _("Restore Bookings from Full System Backup") }} </div>
                        <div class="card-body">
                            <p>{{ _("Select a full system backup from Azure to restore its booking data. This will overwrite existing bookings.") }}</p>
                            <div class="form-group">
                                <label for="full-backup-system-list">{{ _("Available Full System Backups (on Azure)") }}</label>
                                <select id="full-backup-system-list" class="form-control"></select>
                            </div>
                            <button class="btn btn-primary" onclick="restoreBookingsFromFullSystemBackup()">{{ _("Restore Bookings from Selected System Backup") }}</button>
                            <button class="btn btn-info" onclick="loadFullBackupsForRestore()">{{ _("Refresh List") }}</button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header"> {{ _("Restore Bookings from Specific CSV Backup (Legacy)") }} </div>
                        <div class="card-body">
                            <p>{{ _("Select a specific CSV backup file from Azure to restore booking data. This is a legacy method and may not capture all data aspects.") }}</p>
                            <div class="form-group">
                                <label for="csv-backup-list">{{ _("Available CSV Backups on Azure (Legacy)") }}</label>
                                <select id="csv-backup-list" class="form-control"></select>
                            </div>
                            <button class="btn btn-warning" onclick="restoreBookingsFromCsvBackup()">{{ _("Restore from Selected CSV") }}</button>
                            <button class="btn btn-info" onclick="loadCsvBackupsForRestore()">{{ _("Refresh CSV List") }}</button>
                            <button class="btn btn-danger" onclick="deleteCsvBackup()">{{ _("Delete Selected CSV from Azure") }}</button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header"> {{ _("Restore Bookings from Incremental Backups (JSON - Legacy/Other)") }} </div>
                        <div class="card-body">
                            <p><em>{{ _("Placeholder: Functionality to restore from legacy or other non-unified incremental JSON backups would be here. The Unified Azure JSON system is the primary method for incremental restores.") }}</em></p>
                            <!-- Example:
                            <div class="form-group">
                                <label for="incremental-json-backup-list">{{ _("Available Incremental JSON Backups (Legacy)") }}</label>
                                <select id="incremental-json-backup-list" class="form-control" disabled></select>
                            </div>
                            <button class="btn btn-outline-primary" disabled>{{ _("Restore from Selected Legacy Incremental JSON") }}</button>
                            <button class="btn btn-outline-info" disabled>{{ _("Refresh Legacy Incremental List") }}</button>
                            -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Booking CSV Backups Table (Legacy) -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header"> <h5 class="mb-0"><i class="fas fa-list-alt"></i> {{ _("Available Booking CSV Backups on Azure (Legacy)") }}</h5> </div>
                <div class="card-body">
                    <p>{{ _("This table lists specific legacy CSV backup files stored in Azure. You can directly restore or delete them from here.") }}</p>
                    <table class="table table-bordered table-striped">
                        <thead> <tr> <th>{{ _("Filename") }}</th> <th>{{ _("Timestamp") }}</th> <th>{{ _("Size") }}</th> <th>{{ _("Actions") }}</th> </tr> </thead>
                        <tbody id="legacy-csv-table-body"> <!-- Populated by JS: loadLegacyCsvBackups --> </tbody>
                    </table>
                    <nav> <ul class="pagination" id="legacy-csv-pagination"></ul> </nav>
                    <button class="btn btn-info mt-2" onclick="loadLegacyCsvBackups(1)">{{ _("Refresh List") }}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="confirmClearAllModal" tabindex="-1" role="dialog"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">{{ _("Confirm Clear All Booking Data") }}</h5> <button type="button" class="close" data-dismiss="modal">&times;</button> </div> <div class="modal-body"> {{ _("Are you sure you want to permanently delete all booking data? This action cannot be undone.") }} </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Cancel") }}</button> <button type="button" class="btn btn-danger" onclick="executeClearAllBookingData()">{{ _("Clear All Data") }}</button> </div> </div> </div> </div>
<div class="modal fade" id="actionProgressModal" tabindex="-1" role="dialog" aria-labelledby="actionProgressModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="actionProgressModalLabel">{{ _("Action in Progress") }}</h5> </div> <div class="modal-body"> <p id="actionProgressMessage">{{ _("Please wait...") }}</p> <div class="progress"> <div id="actionProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div> </div> </div> </div> </div> </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Socket.IO connection and utility functions (showProgressModal, hideProgressModal, updateServerTime)
    // should remain as they are. For brevity, they are not repeated here.
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    socket.on('connect', () => console.log("Socket.IO connected for backup_booking_data."));
    socket.on('disconnect', () => console.log("Socket.IO disconnected."));
    socket.on('error', err => { console.error("Socket.IO error:", err); alert("{{ _('Socket.IO connection error.') }}"); });

    function showProgressModal(message) { $('#actionProgressMessage').text(message); $('#actionProgressModal').modal({backdrop: 'static', keyboard: false}); }
    function hideProgressModal() { $('#actionProgressModal').modal('hide'); }
    function updateServerTime() {
        fetch("{{ url_for('api_system.ping') }}")
        .then(response => response.json())
        .then(data => {
            if(data.timestamp) {
                document.getElementById('server-time').textContent = "{{ _('Current Server Time (UTC):') }} " + data.timestamp;
            } else {
                document.getElementById('server-time').textContent = "{{ _('Could not load server time.') }}";
            }
        })
        .catch(error => {
            console.error("{{ _('Error fetching server time:') }}", error);
            document.getElementById('server-time').textContent = "{{ _('Error loading server time.') }}";
        });
    }


    // --- Unified Azure JSON Backups ---
    // All functions (refreshUnifiedAzureBackupList, populateUnifiedBackupSelect, renderUnifiedBackupListForManagement,
    // manualUnifiedBackup, restoreSelectedUnifiedBackup, deleteUnifiedBackup) remain unchanged from the previous version.
    // For brevity, their full code is not repeated here.
    function refreshUnifiedAzureBackupList() {
        showProgressModal("{{ _('Loading Unified Azure JSON backups list...') }}");
        fetch("{{ url_for('api_system.api_list_booking_data_backups') }}")
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                if (data.success && data.backups) {
                    populateUnifiedBackupSelect(data.backups);
                    renderUnifiedBackupListForManagement(data.backups);
                } else {
                    alert("{{ _('Error loading Unified Azure JSON backups:') }} " + (data.message || "{{ _('Unknown error') }}"));
                    populateUnifiedBackupSelect([]);
                    renderUnifiedBackupListForManagement([]);
                }
            })
            .catch(error => {
                hideProgressModal(); console.error("{{ _('Error fetching Unified Azure JSON backups list:') }}", error);
                alert("{{ _('Error fetching Unified Azure JSON backups list.') }}");
                populateUnifiedBackupSelect([]); renderUnifiedBackupListForManagement([]);
            });
    }

    function populateUnifiedBackupSelect(backups) {
        const select = $('#selectUnifiedAzureBackup');
        select.empty();
        if (backups && backups.length > 0) {
            backups.forEach(backup => {
                select.append($('<option>', {
                    value: backup.filename,
                    text: backup.display_name,
                    'data-type': backup.type,
                    'data-timestamp': backup.timestamp_str // ISO string from backend
                }));
            });
        } else {
            select.append($('<option>', { text: "{{ _('No Unified Azure JSON backups found') }}" }));
        }
    }

    function renderUnifiedBackupListForManagement(backups) {
        const tableBody = $('#listManageAzureBackups');
        tableBody.empty();
        if (backups && backups.length > 0) {
            backups.forEach(backup => {
                let actionsHtml = `<button class="btn btn-sm btn-danger" onclick="deleteUnifiedBackup('${backup.filename}', '${backup.type}')" title="{{ _('Delete this backup') }}"><i class="fas fa-trash"></i></button>`;
                tableBody.append(`
                    <tr>
                        <td>${backup.display_name}</td>
                        <td>${backup.type.charAt(0).toUpperCase() + backup.type.slice(1)}</td>
                        <td>${backup.filename}</td>
                        <td>${backup.timestamp_str ? new Date(backup.timestamp_str).toLocaleString() : 'N/A'}</td>
                        <td>${actionsHtml}</td>
                    </tr>`);
            });
        } else {
            tableBody.append(`<tr><td colspan="5" class="text-center">{{ _("No Unified Azure JSON backups found.") }}</td></tr>`);
        }
    }

    function manualUnifiedBackup() {
        if (!confirm("{{ _('Are you sure you want to run a manual full JSON backup now? This may take some time.') }}")) return;
        showProgressModal("{{ _('Starting manual full Unified Azure JSON backup...') }}");
        fetch("{{ url_for('api_system.api_manual_booking_data_backup_json') }}", {
            method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        }).then(response => response.json()).then(data => {
            if (data.task_id) {
                $('#actionProgressMessage').text("{{ _('Manual backup started. Task ID:') }} " + data.task_id);
            } else { throw new Error(data.message || "{{ _('Unknown error starting manual backup.') }}"); }
        }).catch(error => { hideProgressModal(); alert("{{ _('Error starting manual backup:') }} " + error.message); });

        socket.off('full_booking_data_backup_progress').on('full_booking_data_backup_progress', function(data) { // Ensure correct event name
            if (data.error || data.level === 'ERROR') {
                hideProgressModal(); alert("{{ _('Error during manual backup:') }} " + (data.message || data.error)); socket.off('full_booking_data_backup_progress');
            } else if (data.status === 'completed' || data.status === 'success') {
                hideProgressModal(); alert("{{ _('Manual backup completed successfully!') }} " + (data.message || "")); socket.off('full_booking_data_backup_progress');
                refreshUnifiedAzureBackupList();
            } else { $('#actionProgressMessage').text(data.message || data.status); }
        });
    }

    function restoreSelectedUnifiedBackup() {
        const selectedOption = $('#selectUnifiedAzureBackup option:selected');
        const backupFilename = selectedOption.val();
        const backupType = selectedOption.data('type');
        const backupTimestampIso = selectedOption.data('timestamp');

        if (!backupFilename || backupFilename === "{{ _('No Unified Azure JSON backups found') }}") { alert("{{ _('Please select a backup.') }}"); return; }
        if (!backupType || !backupTimestampIso) { alert("{{ _('Selected backup missing type/timestamp.') }}"); return; }

        let confirmMsg = `{{ _('Restore from backup') }} '${backupFilename}' (${backupType}, ${new Date(backupTimestampIso).toLocaleString()})? `;
        confirmMsg += (backupType === 'full') ? `{{ _('This ERAASES current data.') }}` : `{{ _('This applies changes to current data.') }}`;
        if (!confirm(confirmMsg + ` {{ _('Cannot be undone.') }}`)) return;

        showProgressModal(`{{ _('Starting restore from') }} ${backupFilename}...`);
        fetch("{{ url_for('api_system.api_unified_booking_data_point_in_time_restore') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ filename: backupFilename, backup_type: backupType, backup_timestamp_iso: backupTimestampIso })
        }).then(response => response.json()).then(data => {
            if (data.task_id) {
                let initialMsg = (data.summary && data.summary.message) ? data.summary.message : "{{ _('Restore started...') }}";
                if (data.summary && data.summary.status === 'failure') { hideProgressModal(); alert(`{{ _('Failed to start restore:') }} ${data.summary.message}`); return; }
                $('#actionProgressMessage').text(`{{ _('Task ID:') }} ${data.task_id}. ${initialMsg}`);
            } else if (data.success === false) { throw new Error((data.summary && data.summary.message) || data.message || "{{ _('Error starting restore.') }}"); }
        }).catch(error => { hideProgressModal(); alert("{{ _('Error starting restore:') }} " + error.message); });

        socket.off('booking_data_protection_restore_progress').on('booking_data_protection_restore_progress', function(data) {
            let msg = data.message || data.status || (data.error ? `Error: ${data.error}` : "{{ _('Processing...') }}");
            if (data.detail) msg += ` (${data.detail})`;
            $('#actionProgressMessage').text(msg);
            if (data.error || data.level === 'ERROR' || data.level === 'CRITICAL_ERROR' || data.status === 'failure') {
                hideProgressModal(); alert(`{{ _('Restore error:') }} ${msg}`); socket.off('booking_data_protection_restore_progress');
            } else if (data.status === 'completed' || data.status === 'success') {
                hideProgressModal(); alert(`{{ _('Restore finished:') }} ${msg}`); socket.off('booking_data_protection_restore_progress');
            }
        });
    }

    function deleteUnifiedBackup(filename, backupType) {
        if (!confirm(`{{ _('Delete backup') }} '${filename}' (Type: ${backupType})? {{ _('Cannot be undone.') }}`)) return;
        showProgressModal(`{{ _('Deleting backup') }} ${filename}...`);
        fetch("{{ url_for('api_system.api_delete_booking_data_backup') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: filename, backup_type: backupType })
        }).then(response => response.json()).then(data => {
            hideProgressModal();
            if (data.success) { alert("{{ _('Backup deleted.') }}"); refreshUnifiedAzureBackupList(); }
            else { alert("{{ _('Error deleting backup:') }} " + (data.message || "{{ _('Unknown error') }}")); }
        }).catch(error => { hideProgressModal(); alert("{{ _('Error deleting backup.') }}"); console.error(error); });
    }

    // --- Legacy and Other Restore/Backup Functions ---
    // These functions are assumed to be correctly implemented as per the previous state of the file.
    // For brevity, their full code is not repeated here if unchanged from the previous version.
    // Make sure these JS functions are present and correct from the original file if they were there.

    function backupBookingData(type) { // Primarily for legacy CSV
        if (type === 'csv') {
            if (!confirm("{{ _('Are you sure you want to create a new manual CSV backup on Azure? This is a legacy method.') }}")) return;
            showProgressModal("{{ _('Starting manual CSV backup...') }}");
            /*
            fetch("{{ url_for('admin_ui.manual_backup_bookings_csv_route') }}", { // Check route
                method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            })
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                if (data.success) {
                    alert("{{ _('Manual CSV backup completed:') }} " + data.message);
                    loadLegacyCsvBackups(1); // Refresh table
                    loadCsvBackupsForRestore(); // Refresh dropdown
                } else {
                    alert("{{ _('Manual CSV backup failed:') }} " + data.message);
                }
            })
            .catch(error => {
                hideProgressModal();
                alert("{{ _('Error during CSV backup:') }} " + error);
                console.error(error);
            });
            */
            alert("{{ _('This feature is temporarily disabled.') }}");
            hideProgressModal();
        }
    }

    function loadFullBackupsForRestore() {
        showProgressModal("{{ _('Loading full system backups list...') }}");
        fetch("{{ url_for('api_system.list_available_system_backups_api') }}") // Ensure this API endpoint is correct
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                const select = $('#full-backup-system-list');
                select.empty();
                if (data.backups && data.backups.length > 0) {
                    data.backups.forEach(backup => {
                        // Assuming backup object has 'filename' and 'timestamp' or similar
                        let displayName = backup.filename || backup.timestamp;
                        if (backup.timestamp_str) displayName = `${new Date(backup.timestamp_str).toLocaleString()} (${backup.filename})`;
                        select.append($('<option>', { value: backup.filename, text: displayName }));
                    });
                } else {
                    select.append($('<option>', { text: "{{ _('No full system backups found') }}" }));
                }
            })
            .catch(error => {
                hideProgressModal();
                console.error("{{ _('Error fetching full system backups list:') }}", error);
                alert("{{ _('Error fetching full system backups list.') }}");
            });
    }

    function restoreBookingsFromFullSystemBackup() {
        const selectedBackup = $('#full-backup-system-list').val();
        if (!selectedBackup || selectedBackup === "{{ _('No full system backups found') }}") {
            alert("{{ _('Please select a system backup to restore bookings from.') }}");
            return;
        }
        if (!confirm("{{ _('Are you sure you want to restore bookings from the system backup') }} '" + selectedBackup + "'? {{ _('This will overwrite current booking data. This action cannot be undone.') }}")) {
            return;
        }
        showProgressModal("{{ _('Restoring bookings from system backup...') }}");
        fetch("{{ url_for('api_system.restore_bookings_from_full_system_backup_api') }}", { // Ensure this API endpoint is correct
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: selectedBackup })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('Bookings restored successfully from system backup:') }} " + data.message);
            } else {
                alert("{{ _('Error restoring bookings from system backup:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error during restore from system backup.') }}");
            console.error(error);
        });
    }

    function loadCsvBackupsForRestore() { // For the dropdown
        showProgressModal("{{ _('Loading legacy CSV backups list for dropdown...') }}");
        // This might use a different endpoint or filter from loadLegacyCsvBackups if it's just for the select
        fetch("{{ url_for('api_system.list_legacy_booking_csv_backups_api') }}?page=1&per_page=1000") // Fetch many for dropdown
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                const select = $('#csv-backup-list');
                select.empty();
                if (data.backups && data.backups.length > 0) {
                    data.backups.forEach(backup => {
                        select.append($('<option>', { value: backup.name, text: `${backup.name} (${backup.timestamp_utc})` }));
                    });
                } else {
                    select.append($('<option>', { text: "{{ _('No CSV backups found') }}" }));
                }
            })
            .catch(error => {
                hideProgressModal();
                console.error("{{ _('Error fetching CSV backups list for dropdown:') }}", error);
                alert("{{ _('Error fetching CSV backups list for dropdown.') }}");
            });
    }

    function restoreBookingsFromCsvBackup() { // From dropdown
        const selectedBackup = $('#csv-backup-list').val();
        if (!selectedBackup || selectedBackup === "{{ _('No CSV backups found') }}") {
            alert("{{ _('Please select a CSV backup to restore.') }}"); return;
        }
        if (!confirm("{{ _('Are you sure you want to restore bookings from CSV backup') }} '" + selectedBackup + "'? {{ _('This is a legacy method and may overwrite data. This action cannot be undone.') }}")) {
            return;
        }
        directRestoreFromCsv(selectedBackup); // Uses the common direct function
    }

    function deleteCsvBackup() { // From dropdown
        const selectedBackup = $('#csv-backup-list').val();
         if (!selectedBackup || selectedBackup === "{{ _('No CSV backups found') }}") {
            alert("{{ _('Please select a CSV backup to delete.') }}"); return;
        }
        // Confirmation is in directDeleteCsv
        directDeleteCsv(selectedBackup); // Uses the common direct function
    }

    function loadLegacyCsvBackups(page) { // For the table with pagination
        showProgressModal("{{ _('Loading legacy CSV backups list for table...') }}");
        fetch(`{{ url_for('api_system.list_legacy_booking_csv_backups_api') }}?page=${page}&per_page=5`)
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                const tableBody = $('#legacy-csv-table-body');
                tableBody.empty();
                if (data.backups && data.backups.length > 0) {
                    data.backups.forEach(backup => {
                        tableBody.append(`
                            <tr>
                                <td>${backup.name}</td>
                                <td>${backup.timestamp_utc}</td>
                                <td>${backup.size_readable}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="directRestoreFromCsv('${backup.name}')">{{ _("Restore") }}</button>
                                    <button class="btn btn-sm btn-danger" onclick="directDeleteCsv('${backup.name}')">{{ _("Delete") }}</button>
                                    <!-- Add verify button if that functionality is kept -->
                                </td>
                            </tr>`);
                    });
                    renderLegacyCsvPagination(data.pagination);
                } else {
                    tableBody.append(`<tr><td colspan="4" class="text-center">{{ _("No legacy CSV backups found.") }}</td></tr>`);
                    $('#legacy-csv-pagination').empty();
                }
                loadCsvBackupsForRestore(); // Also refresh dropdown to keep it in sync
            })
            .catch(error => {
                hideProgressModal();
                console.error("{{ _('Error fetching legacy CSV backups for table:') }}", error);
                alert("{{ _('Error fetching legacy CSV backups for table.') }}");
            });
    }

    function renderLegacyCsvPagination(pagination) {
        const ul = $('#legacy-csv-pagination');
        ul.empty();
        if (!pagination || pagination.total_pages <= 1) return;

        if (pagination.has_prev) {
            ul.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadLegacyCsvBackups(${pagination.prev_num})">{{ _("Previous") }}</a></li>`);
        } else {
            ul.append(`<li class="page-item disabled"><span class="page-link">{{ _("Previous") }}</span></li>`);
        }

        for (let i = 1; i <= pagination.total_pages; i++) {
            if (i === pagination.page) {
                ul.append(`<li class="page-item active"><span class="page-link">${i}</span></li>`);
            } else {
                ul.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadLegacyCsvBackups(${i})">${i}</a></li>`);
            }
        }

        if (pagination.has_next) {
            ul.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadLegacyCsvBackups(${pagination.next_num})">{{ _("Next") }}</a></li>`);
        } else {
            ul.append(`<li class="page-item disabled"><span class="page-link">{{ _("Next") }}</span></li>`);
        }
    }

    function directRestoreFromCsv(filename) {
        if (!confirm("{{ _('Restore bookings from CSV backup') }} '" + filename + "'? {{ _('This is a legacy method. Data will be overwritten. Cannot be undone.') }}")) return;
        showProgressModal("{{ _('Restoring from CSV backup...') }}");
        /*
        fetch("{{ url_for('admin_ui.restore_booking_csv_route') }}", { // Check route
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: filename })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('Bookings restored successfully from CSV:') }} " + data.message);
            } else {
                alert("{{ _('Error restoring from CSV:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error during CSV restore.') }}");
            console.error(error);
        });
        */
        alert("{{ _('This feature is temporarily disabled.') }}");
        hideProgressModal();
    }

    function directDeleteCsv(filename) {
        if (!confirm("{{ _('Are you sure you want to delete the CSV backup') }} '" + filename + "' {{ _('from Azure? This action cannot be undone.') }}")) return;
        showProgressModal("{{ _('Deleting CSV backup...') }}");
        /*
        fetch("{{ url_for('admin_ui.delete_booking_csv_backup_route') }}", { // Check route
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ backup_filename: filename })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('CSV backup deleted:') }} " + data.message);
                loadLegacyCsvBackups(1); // Refresh table
                loadCsvBackupsForRestore(); // Refresh dropdown
            } else {
                alert("{{ _('Error deleting CSV backup:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error deleting CSV backup.') }}");
            console.error(error);
        });
        */
        alert("{{ _('This feature is temporarily disabled.') }}");
        hideProgressModal();
    }

    function confirmClearAllBookingData() {
        $('#confirmClearAllModal').modal('show');
    }

    function executeClearAllBookingData() {
        $('#confirmClearAllModal').modal('hide');
        showProgressModal("{{ _('Clearing all booking data...') }}");
        fetch("{{ url_for('api_system.clear_all_booking_data_api') }}", { // Ensure this API endpoint is correct
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                alert("{{ _('All booking data has been cleared.') }}");
            } else {
                alert("{{ _('Error clearing booking data:') }} " + data.message);
            }
        })
        .catch(error => {
            hideProgressModal();
            alert("{{ _('Error clearing booking data.') }}");
            console.error(error);
        });
    }

    $(document).ready(function() {
        updateServerTime(); setInterval(updateServerTime, 60000);

        // Unified Azure JSON Backups
        refreshUnifiedAzureBackupList();

        // Legacy / Other sections
        loadFullBackupsForRestore();    // For "Restore Bookings from Full System Backup" dropdown
        // loadCsvBackupsForRestore();  // This is called within loadLegacyCsvBackups now
        loadLegacyCsvBackups(1);        // For "Available Booking CSV Backups (Legacy)" table & its dropdown

        // Check if socket event for manualUnifiedBackup needs correction.
        // It was 'booking_data_protection_backup_progress', changed to 'full_booking_data_backup_progress'.
        // This might be specific to the type of backup (full vs incremental) if those events differ.
        // For now, assuming 'full_booking_data_backup_progress' is correct for the manual full backup.
        // The incremental backup process (if it has a manual trigger and separate event) would need its own handler.
    });
</script>
{% endblock %}
